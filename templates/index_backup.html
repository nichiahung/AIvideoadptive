<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdaptVideo - 影片尺寸轉換工具</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* === 專業工具軟體設計系統 === */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: #dbeafe;
            --primary-dark: #1e40af;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --success: #059669;
            --warning: #d97706;
            --error: #dc2626;
            --sidebar-width: 240px;
            --border-radius: 6px;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.5;
            font-size: 14px;
        }

        .app-container { display: flex; min-height: 100vh; }

        /* === 側邊欄 === */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: 20px 0;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 20px;
        }

        .sidebar-header h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .nav-menu { list-style: none; }

        .nav-item a {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            color: var(--gray-600);
            text-decoration: none;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .nav-item a:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .nav-item.active a {
            background: var(--primary-light);
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .nav-item .icon { margin-right: 8px; }

        /* === 主內容 === */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .container { max-width: 900px; margin: 0 auto; }
        .page { display: none; }
        .page.active { display: block; }

        /* === 內容區塊 === */
        .content-section {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* === 影片來源選擇 === */
        .video-source-selection {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .source-option {
            position: relative;
        }

        /* === 上傳區域 === */
        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--gray-50);
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .upload-icon { font-size: 32px; color: var(--gray-400); margin-bottom: 12px; }
        .upload-text { font-size: 16px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px; }
        .upload-hint { font-size: 13px; color: var(--gray-500); }

        .upload-divider {
            margin: 20px 0;
            text-align: center;
            position: relative;
        }

        .upload-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gray-200);
        }

        .upload-divider span {
            background: white;
            padding: 0 12px;
            color: var(--gray-500);
            font-size: 12px;
            position: relative;
        }

        .file-input { display: none; }

        /* === 按鈕 === */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* === Tab === */
        .tab-navigation {
            display: flex;
            background: var(--gray-100);
            border-radius: var(--border-radius);
            padding: 4px;
            margin-bottom: 20px;
        }

        .tab-nav-item {
            flex: 1;
            padding: 8px 16px;
            text-align: center;
            cursor: pointer;
            border-radius: calc(var(--border-radius) - 4px);
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.15s ease;
        }

        .tab-nav-item.active {
            background: white;
            color: var(--gray-900);
            box-shadow: var(--shadow);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* === 影片預覽 === */
        .video-preview {
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 16px;
            align-items: start;
            margin-top: 16px;
        }

        .video-thumbnail {
            width: 100%;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
        }
        
        .subject-choices { display: flex; flex-direction: column; gap: 8px; }

        .subject-choice {
            display: flex;
            align-items: center;
            padding: 8px;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .subject-choice:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .subject-choice input[type="radio"], 
        .subject-choice input[type="checkbox"] { margin-right: 8px; }
        .subject-choice img {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            margin-right: 8px;
            object-fit: cover;
        }

        /* === 工具樣式 === */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .template-card {
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .template-card:hover, .template-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .template-name { font-weight: 600; color: var(--gray-900); margin-bottom: 4px; }
        .template-size { font-size: 12px; color: var(--gray-600); margin-bottom: 6px; }
        .template-desc { font-size: 11px; color: var(--gray-500); }

        .crop-options { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }

        .crop-option {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .crop-option:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .crop-option input[type="radio"] { margin-right: 8px; margin-top: 2px; }
        .option-content strong { display: block; font-weight: 600; color: var(--gray-900); margin-bottom: 2px; }
        .option-content p { font-size: 12px; color: var(--gray-600); margin: 0; }

        /* === 進度與狀態 === */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .status-message {
            padding: 10px 12px;
            border-radius: var(--border-radius);
            margin: 12px 0;
            font-size: 13px;
            font-weight: 500;
        }

        .status-message.success {
            background: #dcfce7;
            color: var(--success);
            border: 1px solid #bbf7d0;
        }

        .status-message.error {
            background: #fef2f2;
            color: var(--error);
            border: 1px solid #fecaca;
        }

        .status-message.info {
            background: var(--primary-light);
            color: var(--primary);
            border: 1px solid #93c5fd;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-200);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 16px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            0% { 
                opacity: 0;
                transform: translateY(-10px);
            }
            100% { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            0% { 
                opacity: 1;
                transform: translateY(0);
            }
            100% { 
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* === Modal === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: var(--border-radius);
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-header h2 { font-size: 16px; font-weight: 600; color: var(--gray-900); }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-400);
            padding: 4px;
            border-radius: 4px;
        }

        .close-btn:hover { background: var(--gray-100); color: var(--gray-600); }

        #videoHistoryGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .history-thumb-card {
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .history-thumb-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .history-thumb-card img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .history-thumb-card p {
            padding: 8px;
            font-size: 11px;
            color: var(--gray-600);
            background: var(--gray-50);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* === 整合的主體選擇樣式 === */
        .integrated-subject-choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .multi-select-info {
            background: var(--primary-light);
            border: 1px solid #93c5fd;
            border-radius: 6px;
            padding: 12px;
            font-size: 13px;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .subjects-selection-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.1);
        }

        .recommended-templates-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .ai-analysis-overview {
            position: relative;
            overflow: hidden;
        }

        .ai-analysis-overview::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 20%, transparent 70%);
            pointer-events: none;
        }

        /* === Markdown 內容樣式 === */
        .markdown-content {
            font-size: 14px;
            color: var(--gray-700);
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .markdown-content p {
            margin-bottom: 8px;
        }
        .markdown-content ul {
            margin-left: 20px;
            margin-bottom: 12px;
            list-style-type: disc;
        }
        .markdown-content li {
            margin-bottom: 4px;
        }
        .markdown-content strong {
            font-weight: 600;
            color: var(--gray-900);
        }

        /* === 響應式 === */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; order: 2; border-right: none; border-top: 1px solid var(--gray-200); }
            .main-content { order: 1; padding: 12px; }
            .video-preview { grid-template-columns: 1fr; gap: 12px; }
            
            /* 小螢幕時影片資訊使用單列佈局 */
            .video-info-grid { grid-template-columns: 1fr !important; }
            
            /* 小螢幕時影片來源選擇保持垂直佈局 */
            .video-source-selection { gap: 12px; }
        }

        .recommendation-warning {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-800);
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            background-color: #fffbeb;
            border-left: 4px solid var(--warning);
        }
        .recommendation-warning .icon-svg {
            color: var(--warning);
        }

        .recommendation-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-800);
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            background-color: #f0f9ff;
            border-left: 4px solid var(--primary);
        }
        .recommendation-info .icon-svg {
            color: var(--primary);
        }

        .recommendation-success {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #15803d;
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            background-color: #f0f9ff;
            border-left: 4px solid #22c55e;
        }

        .recommendation-warning {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #d97706;
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .recommendation-text .markdown-content {
            font-size: 14px;
            color: var(--gray-700);
        }

        .icon-svg {
            width: 1.1em;
            height: 1.1em;
            vertical-align: -0.2em;
            flex-shrink: 0;
        }

        /* === 影片資訊樣式優化 === */
        .video-info-section {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 16px;
        }

        .video-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px 16px;
            font-size: 14px; /* 從 11px 增加到 14px */
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            color: var(--gray-600);
            font-size: 12px; /* 從 10px 增加到 12px */
            font-weight: 500;
        }

        .info-value {
            color: var(--gray-900);
            font-weight: 600;
            font-size: 15px; /* 從 11px 增加到 15px */
            line-height: 1.3;
        }

        /* 檔案名稱特殊處理 */
        .info-item.filename {
            grid-column: 1 / -1;
        }

        .info-item.filename .info-value {
            font-size: 13px; /* 檔案名稱稍小一點 */
            max-height: 32px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2; /* 標準屬性，提供更好的兼容性 */
        }

        /* === AI 識別資訊優化 === */
        .ai-analysis-section {
            background: var(--primary-light);
            border: 1px solid var(--primary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
        }

        .ai-analysis-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            font-size: 16px; /* 增大標題字體 */
            font-weight: 600;
            color: var(--primary);
        }

        .ai-analysis-content {
            font-size: 15px; /* 增大內容字體 */
            line-height: 1.6;
            color: var(--gray-800);
        }

        /* === 主體選擇區域優化 === */
        .subject-choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .subject-choice {
            display: flex;
            align-items: center;
            padding: 12px; /* 增加內邊距 */
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .subject-choice:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .subject-choice input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2); /* 增大複選框 */
        }

        .subject-choice img {
            width: 40px; /* 從 32px 增加到 40px */
            height: 40px;
            border-radius: 6px;
            margin-right: 12px;
            object-fit: cover;
        }

        .subject-choice span {
            font-size: 14px; /* 從 12px 增加到 14px */
            font-weight: 500;
            line-height: 1.4;
        }

        .subject-choice small {
            font-size: 12px; /* 從 10px 增加到 12px */
            color: var(--gray-500);
        }

        /* === 多選說明優化 === */
        .multi-select-info {
            background: var(--primary-light);
            border: 1px solid var(--primary);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 13px; /* 從 11px 增加到 13px */
            color: var(--primary-dark);
            font-weight: 500;
        }

        /* === 推薦模板區域優化 === */
        .templates-title {
            display: flex;
            align-items: center;
            margin: 24px 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 16px; /* 增大標題字體 */
            font-weight: 600;
            color: var(--gray-800);
        }

        .template-card {
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 16px; /* 增加內邊距 */
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 16px;
        }

        .template-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 6px;
            font-size: 15px; /* 增大字體 */
        }

        .template-size {
            font-size: 13px; /* 從 12px 增加到 13px */
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        /* === 響應式設計優化 === */
        @media (max-width: 768px) {
            .video-info-grid {
                grid-template-columns: 1fr;
                font-size: 13px;
            }
            
            .info-value {
                font-size: 14px;
            }
            
            .ai-analysis-header {
                font-size: 15px;
            }
            
            .ai-analysis-content {
                font-size: 14px;
            }
            
            /* 影片比較區域響應式 */
            .video-comparison-grid {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }
            
            .aspect-ratio-comparison {
                margin: 12px 0 !important;
                padding: 12px !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>AdaptVideo</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-page="converter">
                    <a href="#"><span class="icon">🔧</span>影片轉換</a>
                </li>
                <li class="nav-item" data-page="history">
                    <a href="#"><span class="icon">📁</span>歷史紀錄</a>
                </li>
                <li class="nav-item" data-page="guide">
                    <a href="#"><span class="icon">❓</span>使用說明</a>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <div id="page-converter" class="page active">
                <div class="container">
                    <!-- 影片來源 -->
                    <div class="content-section">
                        <div class="section-title">
                            <span class="icon">📂</span>影片來源
                        </div>
                        
                        <!-- 影片來源選擇 -->
                        <div class="video-source-selection">
                            <div class="source-option" id="uploadOption">
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-icon">📤</div>
                                    <div class="upload-text">點擊選擇影片檔案或拖拽到此處</div>
                                    <div class="upload-hint">支援 MP4, MOV 格式，檔案大小限制 500MB</div>
                                </div>
                                <input type="file" id="fileInput" class="file-input" accept="video/*">
                            </div>
                            
                            <div class="upload-divider"><span>或</span></div>
                            
                            <div class="source-option" id="historyOption">
                                <button id="showHistoryBtn" class="btn btn-secondary" style="width: 100%; padding: 16px; font-size: 14px;">
                                    📁 從歷史紀錄選擇影片
                                </button>
                            </div>
                        </div>
                        
                        <!-- 影片預覽 -->
                        <div id="videoPreviewContainer" style="display:none;">
                            <div class="section-title" style="margin-top: 20px;">
                                <span class="icon">👁️</span>影片預覽
                            </div>
                            <div class="video-preview">
                                <div style="position: relative; display: inline-block;">
                                    <img id="videoThumbnail" class="video-thumbnail" src="" alt="影片縮圖"/>
                                    <button id="originalPreviewBtn" class="btn btn-secondary" style="position: absolute; top: 8px; right: 8px; font-size: 11px; padding: 4px 8px; display: none;">
                                        🎬 動態預覽
                                    </button>
                                </div>
                                
                                <!-- 右側區域：主體選擇 + 影片資訊 -->
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <!-- 主體選擇區域 -->
                                    <div id="subjectChoices" class="subject-choices"></div>
                                    
                                    <!-- 影片資訊 -->
                                    <div id="videoInfoSection" class="video-info-section">
                                        <div class="section-title" style="margin: 0 0 12px 0; font-size: 15px; font-weight: 600;">
                                            <span class="icon">📊</span>影片資訊
                                        </div>
                                        <div class="video-info-grid">
                                            <div class="info-item filename">
                                                <span class="info-label">📁 檔案名稱</span>
                                                <span id="videoFileName" class="info-value" title="">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">🎬 格式</span>
                                                <span id="videoFormat" class="info-value">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">📐 解析度</span>
                                                <span id="videoResolution" class="info-value">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">⏱️ 時長</span>
                                                <span id="videoDuration" class="info-value">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">🎞️ 幀率</span>
                                                <span id="videoFPS" class="info-value">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">💾 大小</span>
                                                <span id="videoFileSize" class="info-value">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI 分析狀態區域 -->
                            <div id="analysisStatusSection" style="display: none; margin-top: 16px;">
                                <div id="analysisStatus" style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    padding: 12px 16px;
                                    background: #f6ffed;
                                    border: 1px solid #b7eb8f;
                                    border-radius: 6px;
                                    font-size: 14px;
                                    color: #52c41a;
                                ">
                                    <svg style="width: 16px; height: 16px; margin-right: 8px;" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.91,10.59L6.5,12L11,16.5Z"/>
                                    </svg>
                                    <span>分析完成</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 轉換設定 -->
                    <div id="tabsSection" style="display:none;">
                        <div class="content-section">
                            <nav class="tab-navigation">
                                <div class="tab-nav-item active" data-tab="smart">智慧轉換</div>
                                <div class="tab-nav-item" data-tab="manual">手動轉換</div>
                            </nav>
                            
                            <!-- 智慧轉換 -->
                            <div id="tab-smart" class="tab-content active">

                                
                                <div class="section-title"><span class="icon">🤖</span>AI 推薦結果</div>
                                
                                <div id="aiSuggestions">
                                    <div class="spinner"></div>
                                    <p style="text-align: center; color: var(--gray-500); margin-top: 12px;">正在分析影片內容...</p>
                                </div>
                            </div>

                            <!-- 手動轉換 -->
                            <div id="tab-manual" class="tab-content">
                                <div class="section-title"><span class="icon">⚙️</span>選擇輸出尺寸</div>
                                <div id="templatesGridManual" class="templates-grid"></div>
                                
                                <div class="section-title" style="margin-top: 24px;"><span class="icon">✂️</span>裁切模式</div>
                                <div class="crop-options">
                                    <label class="crop-option">
                                        <input type="radio" name="cropModeManual" value="center" checked>
                                        <div class="option-content">
                                            <strong>置中裁切</strong>
                                            <p>從影片中心進行裁切</p>
                                        </div>
                                    </label>
                                    <label class="crop-option" style="display:none;">
                                        <input type="radio" name="cropModeManual" value="llm">
                                        <div class="option-content">
                                            <strong>智慧裁切</strong>
                                            <p>根據 AI 識別的主要對象進行裁切</p>
                                        </div>
                                    </label>
                                </div>

                                                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" id="convertBtnManual" disabled>
                        <svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="play-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true">
                            <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path>
                            <path d="M719.4 499.1l-296.1-215A15.9 15.9 0 00398 297v430c0 13.1 14.8 20.5 25.3 12.9l296.1-215a15.9 15.9 0 000-25.8zm-257.6 134V390.9L628.5 512 461.8 633.1z"></path>
                        </svg>
                        開始轉換
                    </button>
                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 轉換結果 -->
                    <div id="resultSection" style="display: none;">
                        <div class="content-section">
                            <div class="section-title">
                                <svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="check-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true">
                                    <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path>
                                    <path d="M699.1 316.2c-4.9-4.9-12.8-4.9-17.7 0L469 528.4 342.9 402.3c-4.9-4.9-12.8-4.9-17.7 0s-4.9 12.8 0 17.7l138.4 138.4c4.9 4.9 12.8 4.9 17.7 0l224.5-224.5c4.8-4.9 4.8-12.8-.1-17.7z"></path>
                                </svg>
                                轉換結果
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center; justify-items: center;" class="video-comparison-grid">
                                <div style="text-align: center; max-width: 100%;">
                                    <h4 style="margin-bottom: 12px; color: var(--gray-700); font-size: 14px; line-height: 1.4;">原始影片</h4>
                                    <video id="originalVideo" controls muted playsinline style="border-radius: var(--border-radius); border: 1px solid var(--gray-200); background: #000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 100%;"></video>
                                </div>
                                <div style="text-align: center; max-width: 100%;">
                                    <h4 style="margin-bottom: 12px; color: var(--gray-700); font-size: 14px; line-height: 1.4;">轉換後影片</h4>
                                    <video id="convertedVideo" controls muted playsinline style="border-radius: var(--border-radius); border: 1px solid var(--gray-200); background: #000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 100%;"></video>
                                </div>
                            </div>
                            <div id="downloadSection" style="display: none; margin-top: 20px; text-align: center;"></div>
                        </div>
                    </div>

                    <!-- 進度與狀態 -->
                    <div class="progress-bar" id="progressBar" style="display: none;">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="status-message" id="statusMessage"></div>
                </div>
            </div>

            <!-- 其他頁面 -->
            <div id="page-history" class="page" style="display: none;">
                <div class="container">
                    <div class="content-section">
                        <div class="section-title"><span class="icon">📁</span>歷史紀錄</div>
                        <div id="history-content"></div>
                    </div>
                </div>
            </div>

            <div id="page-guide" class="page" style="display: none;">
                <div class="container">
                    <div class="content-section">
                        <div class="section-title"><span class="icon">❓</span>使用說明</div>
                        <div style="line-height: 1.6;">
                            <h3 style="color: var(--gray-800); margin: 16px 0 8px;">基本操作</h3>
                            <ol style="margin-left: 20px; color: var(--gray-600);">
                                <li>選擇影片檔案或從歷史紀錄中選擇</li>
                                <li>等待 AI 自動分析影片內容</li>
                                <li>在「智慧轉換」中查看 AI 推薦的尺寸</li>
                                <li>或切換到「手動轉換」自行選擇設定</li>
                                <li>點擊開始轉換並等待處理完成</li>
                            </ol>
                            
                            <h3 style="color: var(--gray-800); margin: 20px 0 8px;">支援格式</h3>
                            <p style="color: var(--gray-600);">MP4, MOV 等常見影片格式，檔案大小限制 500MB</p>
                            
                            <h3 style="color: var(--gray-800); margin: 20px 0 8px;">裁切模式</h3>
                            <ul style="margin-left: 20px; color: var(--gray-600);">
                                <li><strong>置中裁切：</strong>從影片中心位置進行裁切</li>
                                <li><strong>智慧裁切：</strong>AI 自動識別主要對象並以其為中心裁切</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 歷史紀錄 Modal -->
    <div id="videoHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>選擇影片</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div id="videoHistoryGrid"></div>
        </div>
    </div>

    <script>
        const ICONS = {
            check: `<svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="check-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M699.1 316.2c-4.9-4.9-12.8-4.9-17.7 0L469 528.4 342.9 402.3c-4.9-4.9-12.8-4.9-17.7 0s-4.9 12.8 0 17.7l138.4 138.4c4.9 4.9 12.8 4.9 17.7 0l224.5-224.5c4.8-4.9 4.8-12.8-.1-17.7z"></path></svg>`,
            warning: `<svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="exclamation-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M496 632h32c4.4 0 8-3.6 8-8V448c0-4.4-3.6-8-8-8h-32c-4.4 0-8 3.6-8 8v176c0 4.4 3.6 8 8 8zm0-240h32c4.4 0 8-3.6 8-8v-32c0-4.4-3.6-8-8-8h-32c-4.4 0-8 3.6-8 8v32c0 4.4 3.6 8 8 8z"></path></svg>`,
            download: `<svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="download" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M505.7 661a8 8 0 0012.6 0l112-141.7c4.1-5.2.4-12.9-6.3-12.9h-74.1V168c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v338.3H400c-6.7 0-10.4 7.7-6.3 12.9l112 141.8zM878 626h-138c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h138c35.3 0 64-28.7 64-64V465c0-35.3-28.7-64-64-64h-138c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h138v154zM146 626h138c4.4 0 8 3.6 8 8v60c0 4.4-3.6 8-8 8H146c-35.3 0-64-28.7-64-64V465c0-35.3 28.7-64 64-64h138c4.4 0 8 3.6 8 8v60c0 4.4-3.6-8-8 8H146v154z"></path></svg>`,
            adjust: `<svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="setting" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M924.8 625.7l-65.5-56c3.1-19 4.7-38.4 4.7-57.8s-1.6-38.8-4.7-57.8l65.5-56a32.03 32.03 0 009.3-35.2l-.9-2.6a443.74 443.74 0 00-79.7-137.9l-1.8-2.1a32.12 32.12 0 00-35.1-9.5l-81.3 28.9c-30-24.6-63.5-44-99.7-57.6l-15.7-85a32.05 32.05 0 00-25.8-25.7l-2.7-.5c-52.1-9.4-106.9-9.4-159 0l-2.7.5a32.05 32.05 0 00-25.8 25.7l-15.8 85.4a351.86 351.86 0 00-99 57.4l-81.9-29.1a32 32 0 00-35.1 9.5l-1.8 2.1a446.02 446.02 0 00-79.7 137.9l-.9 2.6c-4.5 12.5-.8 26.5 9.3 35.2l66.3 56.6c-3.1 18.8-4.6 38-4.6 57.1 0 19.2 1.5 38.4 4.6 57.1L99 625.5a32.03 32.03 0 00-9.3 35.2l.9 2.6c18.1 50.4 44.9 96.9 79.7 137.9l1.8 2.1a32.12 32.12 0 0035.1 9.5l81.9-29.1c29.8 24.5 63.1 43.9 99 57.4l15.8 85.4a32.05 32.05 0 0025.8 25.7l2.7.5a449.4 449.4 0 00159 0l2.7-.5a32.05 32.05 0 0025.8-25.7l15.7-85a350 350 0 0099.7-57.6l81.3 28.9a32 32 0 0035.1-9.5l1.8-2.1c34.8-41.1 61.6-87.5 79.7-137.9l.9-2.6c4.5-12.3.8-26.3-9.3-35.2zM788.3 465.9c2.5 15.1 3.8 30.6 3.8 46.1s-1.3 31-3.8 46.1l-6.6 40.1 74.7 63.9a370.03 370.03 0 01-42.6 73.6L721 702.8l-31.4 25.8c-23.9 19.6-50.5 35-79.3 45.8l-38.1 14.3-17.9 97a377.5 377.5 0 01-85 0l-17.9-97.2-37.8-14.5c-28.5-10.8-55-26.2-78.7-45.7l-31.4-25.9-93.4 33.2c-17-22.9-31.2-47.6-42.6-73.6l75.5-64.5-6.5-40c-2.4-14.9-3.7-30.3-3.7-45.5 0-15.3 1.2-30.6 3.7-45.5l6.5-40-75.5-64.5c11.3-26.1 25.6-50.7 42.6-73.6l93.4 33.2 31.4-25.9c23.7-19.5 50.2-34.9 78.7-45.7l37.9-14.3 17.9-97.2c28.1-3.2 56.8-3.2 85 0l17.9 97 38.1 14.3c28.7 10.8 55.4 26.2 79.3 45.8l31.4 25.8 92.8-32.9c17 22.9 31.2 47.6 42.6 73.6L781.8 426l6.5 39.9zM512 326c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176-78.8-176-176-176zm79.2 255.2A111.6 111.6 0 01512 614c-29.9 0-58-11.7-79.2-32.8A111.6 111.6 0 01400 502c0-29.9 11.7-58 32.8-79.2C454 401.6 482.1 390 512 390c29.9 0 58 11.6 79.2 32.8A111.6 111.6 0 01624 502c0 29.9-11.7 58-32.8 79.2z"></path></svg>`
        };

        // 保持原有的 JavaScript 邏輯
        let selectedFile = null, selectedTemplate = null, fileId = null, selectedLLMSubjects = []; // 改為陣列支援多選
        let originalThumbnail = '';
        let videoInfo = {};
        let allTemplates = [];
        let allSubjects = [];
        let originalFilename = '';
        let currentCustomPrompt = '';
        let conversationHistory = []; // 新增：用於存儲對話歷史
        // 注意：activePreviewSections 已在其他區塊宣告，避免重複宣告

        document.addEventListener('DOMContentLoaded', () => {
            // 導航
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    const page = document.getElementById(`page-${item.dataset.page}`);
                    page.classList.add('active');
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                    if (item.dataset.page === 'history') loadHistoryPage();
                });
            });

            // Tab
            document.querySelectorAll('.tab-nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const tabId = `tab-${item.dataset.tab}`;
                    document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    document.querySelectorAll('.tab-nav-item').forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                    if(item.dataset.tab === 'manual' && fileId) setupManualTab();
                });
            });

            // Modal
            const modal = document.getElementById('videoHistoryModal');
            const showHistoryBtn = document.getElementById('showHistoryBtn');
            const closeBtn = document.querySelector('.close-btn');

            // 歷史記錄按鈕處理
            showHistoryBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                resetUIForNewVideo();
                modal.style.display = 'block';
                loadVideoHistory();
            });
            closeBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target == modal) modal.style.display = 'none';
            }

            // 檔案上傳處理
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // 點擊上傳區域選擇檔案
            uploadArea.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });
            
            // 檔案選擇變更處理
            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // 拖拽上傳處理
            ['dragover', 'dragleave', 'drop'].forEach(evt => {
                uploadArea.addEventListener(evt, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (evt === 'dragover') {
                        uploadArea.classList.add('dragover');
                    } else if (evt === 'dragleave') {
                        uploadArea.classList.remove('dragover');
                    } else if (evt === 'drop') {
                        uploadArea.classList.remove('dragover');
                        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                            handleFile(e.dataTransfer.files[0]);
                        }
                    }
                });
            });

            document.getElementById('convertBtnManual').addEventListener('click', () => {
                const cropMode = document.querySelector('input[name="cropModeManual"]:checked').value;
                let center = null;
                if(cropMode === 'llm') {
                    const selectedSubjectRadio = document.querySelector('input[name="manualSubjectSelect"]:checked');
                    if (selectedSubjectRadio) {
                        center = JSON.parse(selectedSubjectRadio.value);
                    } else if (allSubjects.length > 0) {
                        center = allSubjects[0].center;
                    }
                }
                startConversion(selectedTemplate, center);
            });



            // 原始影片動態預覽功能
            document.getElementById('originalPreviewBtn').addEventListener('click', async () => {
                if (!fileId) {
                    showStatus('請先選擇影片', 'error');
                    return;
                }
                await generateOriginalPreview();
            });

            loadAllTemplates();
        });

        // 所有其他 JavaScript 函式保持與原版本相同的邏輯
        async function loadAllTemplates() {
            try {
                const response = await fetch('/api/templates');
                allTemplates = await response.json();
            } catch (error) {
                console.error("Failed to load templates", error);
            }
        }

        async function loadVideoHistory() {
            const grid = document.getElementById('videoHistoryGrid');
            grid.innerHTML = '<div class="spinner"></div>';
            try {
                const response = await fetch('/api/uploaded_videos');
                const videos = await response.json();
                grid.innerHTML = '';
                if(videos.length === 0){
                    grid.innerHTML = '<p>暫無歷史紀錄</p>';
                    return;
                }
                videos.forEach(v => {
                    const card = document.createElement('div');
                    card.className = 'history-thumb-card';
                    card.innerHTML = `<img src="${v.thumbnail}" alt="${v.filename}"><p>${v.filename}</p>`;
                    card.addEventListener('click', () => {
                        handleExistingVideo(v.file_id, v.thumbnail, v.video_info, v.filename);
                        document.getElementById('videoHistoryModal').style.display = 'none';
                    });
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error("Failed to load video history", error);
                grid.innerHTML = '<p style="color:red;">載入失敗</p>';
            }
        }

        function handleFile(file) {
            if (!file) {
                console.log('沒有選擇檔案');
                return;
            }
            
            if (file.size > 500 * 1024 * 1024) {
                showStatus('檔案大小超過500MB限制', 'error');
                return;
            }
            
            console.log('處理檔案:', file.name, '大小:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
            
            // 重置 UI 並設定為檔案上傳模式
            resetUIForNewVideo();
            selectedFile = file;
            fileId = null; // 清除歷史記錄的 fileId
            
            uploadAndAnalyze(file);
        }

        async function handleExistingVideo(fId, thumb, vInfo, filename) {
            console.log('選擇歷史影片:', filename, 'fileId:', fId);
            
            // 重置 UI 並設定為歷史記錄模式
            resetUIForNewVideo();
            selectedFile = null;  // 明確確保沒有本地檔案
            fileId = fId;
            originalFilename = filename || '';
            
            if (thumb) {
                originalThumbnail = thumb;
                const videoThumbnailEl = document.getElementById('videoThumbnail');
                videoThumbnailEl.src = originalThumbnail;
                videoThumbnailEl.style.display = 'block';
                
                // 顯示動態預覽按鈕
                document.getElementById('originalPreviewBtn').style.display = 'block';
            }
            
            if (vInfo) {
                videoInfo = vInfo;
                displayVideoInfo(filename, vInfo, null); // 歷史影片沒有檔案大小資訊
            }
            
            document.getElementById('videoPreviewContainer').style.display = 'block';
            document.getElementById('tabsSection').style.display = 'block';
            
            // 清除檔案輸入
            const fileInput = document.getElementById('fileInput');
            fileInput.value = '';
            
            await runAnalysis(fileId);
        }

        async function uploadAndAnalyze(file) {
            const formData = new FormData();
            formData.append('video', file);
            showProgress(true);
            updateProgress(20, '上傳中...');
            resetUIForNewVideo();
            try {
                const uploadResponse = await fetch('/api/upload', { method: 'POST', body: formData });
                if (!uploadResponse.ok) throw new Error('上傳失敗');
                const uploadResult = await uploadResponse.json();
                fileId = uploadResult.file_id;
                videoInfo = uploadResult.video_info;
                originalThumbnail = uploadResult.thumbnail;
                document.getElementById('videoPreviewContainer').style.display = 'block';
                const videoThumbnailEl = document.getElementById('videoThumbnail');
                videoThumbnailEl.src = originalThumbnail;
                videoThumbnailEl.style.display = 'block';
                
                // 顯示動態預覽按鈕
                document.getElementById('originalPreviewBtn').style.display = 'block';
                
                // 顯示影片資訊
                displayVideoInfo(file.name, videoInfo, file.size);
                
                document.getElementById('tabsSection').style.display = 'block';
                await runAnalysis(fileId);
            } catch (error) {
                showProgress(false);
                showStatus(error.message, 'error');
            }
        }
        
        async function runAnalysis(fId) {
            // 清空自定義 prompt 和對話歷史，因為這是標準分析
            currentCustomPrompt = '';
            conversationHistory = [];

            updateProgress(40, 'AI 分析中...');
            document.getElementById('aiSuggestions').innerHTML = `<div class="spinner"></div><p style="text-align: center; color: var(--gray-500); margin-top: 12px;">AI 正在分析影片內容...</p>`;
            try {
                const analyzeResponse = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        file_id: fId,
                        conversation_history: [] // 傳遞空歷史記錄以開始新對話
                    })
                });
                if (!analyzeResponse.ok) throw new Error((await analyzeResponse.json()).error || '分析失敗');
                const analyzeResult = await analyzeResponse.json();
                
                // 將 AI 的第一個建議存入對話歷史
                if (analyzeResult.suggestions) {
                    conversationHistory.push({ role: 'assistant', content: analyzeResult.suggestions });
                }

                updateProgress(100);
                setTimeout(() => {
                    showProgress(false);
                    allSubjects = analyzeResult.analysis_options || [];
                    selectedLLMSubjects = allSubjects.length > 0 ? [allSubjects[0]] : [];
                    displayLlmChoices(allSubjects);
                    displaySuggestions(analyzeResult.suggestions, analyzeResult.recommended_template_names);
                    showStatus('分析完成', 'success');
                    // 顯示分析狀態區域
                    document.getElementById('analysisStatusSection').style.display = 'block';
                }, 500);
            } catch(e) {
                showProgress(false);
                showStatus(`分析失敗: ${e.message}`, 'error');
            }
        }

        async function runCustomAnalysis(fId, customPrompt) {
            // 保存當前的自定義 prompt
            currentCustomPrompt = customPrompt;
            
            // 將用戶的自定義需求添加到對話歷史
            conversationHistory.push({ role: 'user', content: customPrompt });

            updateProgress(40, '根據您的需求重新分析中...');
            document.getElementById('aiSuggestions').innerHTML = `
                <div class="spinner"></div>
                <p style="text-align: center; color: var(--gray-500); margin-top: 12px;">AI 正在根據您的需求重新分析影片...</p>
                <div style="background: var(--primary-light); border: 1px solid var(--primary); border-radius: var(--border-radius); padding: 12px; margin-top: 16px; font-size: 13px;">
                    <strong>分析需求：</strong>${customPrompt}
                </div>
            `;
            try {
                const analyzeResponse = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        file_id: fId,
                        conversation_history: conversationHistory // 傳遞完整對話歷史
                    })
                });
                if (!analyzeResponse.ok) throw new Error((await analyzeResponse.json()).error || '自定義分析失敗');
                const analyzeResult = await analyzeResponse.json();

                // 將 AI 的新建議添加到對話歷史
                if (analyzeResult.suggestions) {
                    conversationHistory.push({ role: 'assistant', content: analyzeResult.suggestions });
                }

                updateProgress(100);
                setTimeout(() => {
                    showProgress(false);
                    allSubjects = analyzeResult.analysis_options || [];
                    selectedLLMSubjects = allSubjects.length > 0 ? [allSubjects[0]] : [];
                    displayLlmChoices(allSubjects);
                    displaySuggestions(analyzeResult.suggestions, analyzeResult.recommended_template_names, customPrompt);
                    showStatus('自定義分析完成', 'success');
                    // 顯示分析狀態區域
                    document.getElementById('analysisStatusSection').style.display = 'block';
                }, 500);
            } catch(e) {
                showProgress(false);
                showStatus(`自定義分析失敗: ${e.message}`, 'error');
            }
        }

        function displaySuggestions(suggestions, recommendedNames, customPrompt = null) {
            const suggestionsContainer = document.getElementById('aiSuggestions');
            suggestionsContainer.innerHTML = '';
            
            // === AI 分析結果簡潔卡片 ===
            const analysisCard = document.createElement('div');
            analysisCard.style.cssText = `
                background: #f6ffed;
                border: 1px solid #b7eb8f;
                border-radius: 6px;
                padding: 16px;
                margin-bottom: 24px;
            `;
            
            const objectNames = allSubjects.map(s => s.subject).join('、');
            
            analysisCard.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <svg style="width: 16px; height: 16px; margin-right: 8px; color: #52c41a;" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.91,10.59L6.5,12L11,16.5Z"/>
                    </svg>
                    <span style="font-weight: 600; color: #389e0d; font-size: 14px;">AI 分析完成</span>
                </div>
                <div style="color: #52c41a; font-size: 14px; margin-bottom: 8px;">
                    識別到 ${allSubjects.length} 個主要物體：${objectNames}
                </div>
                <div style="color: #389e0d; font-size: 12px;">
                    請依序完成以下步驟進行影片轉換
                </div>
            `;
            suggestionsContainer.appendChild(analysisCard);

            // === 第二步：主體選擇區域 ===
            if (allSubjects && allSubjects.length > 0) {
                const subjectsCard = document.createElement('div');
                subjectsCard.className = 'subjects-selection-card';
                subjectsCard.style.cssText = `
                    background: white; 
                    border: 1px solid var(--gray-200); 
                    border-radius: 12px; 
                    padding: 24px; 
                    margin-bottom: 24px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                    transition: all 0.3s ease;
                `;
                subjectsCard.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center;">
                            <div style="background: var(--primary-light); border-radius: 8px; padding: 8px; margin-right: 12px;">
                                <svg style="width: 20px; height: 20px; color: var(--primary);" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--gray-800);">步驟 1：選擇保護對象</h3>
                                <p style="margin: 0; font-size: 13px; color: var(--gray-500);">多選支援，AI 會自動計算最佳中心點</p>
                            </div>
                        </div>
                        <div style="background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                            必填項目
                        </div>
                    </div>
                    <div id="integratedSubjectChoices" class="integrated-subject-choices"></div>
                `;
                suggestionsContainer.appendChild(subjectsCard);
                
                // 渲染主體選擇
                displayIntegratedLlmChoices(allSubjects);
            }

            // === 第三步：如果有自定義 prompt，顯示用戶需求 ===
            if (customPrompt) {
                const customPromptCard = document.createElement('div');
                customPromptCard.style.cssText = `
                    background: white; 
                    border: 1px solid var(--primary); 
                    border-radius: 12px; 
                    padding: 24px; 
                    margin-bottom: 24px;
                    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
                `;
                customPromptCard.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center;">
                            <div style="background: var(--primary-light); border-radius: 8px; padding: 8px; margin-right: 12px;">
                                <svg style="width: 20px; height: 20px; color: var(--primary);" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--gray-800);">您的自定義需求</h3>
                                <p style="margin: 0; font-size: 13px; color: var(--gray-500);">基於此需求進行客製化分析</p>
                            </div>
                        </div>
                        <div style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                            自定義分析
                        </div>
                    </div>
                    <div style="background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; padding: 16px; white-space: pre-wrap; line-height: 1.6; font-size: 14px; color: var(--gray-700);">${customPrompt}</div>
                `;
                suggestionsContainer.appendChild(customPromptCard);
            }

            // === 第四步：AI 專業建議 ===
            if (suggestions && suggestions.trim()) {
                const aiSuggestionsCard = document.createElement('div');
                aiSuggestionsCard.style.cssText = `
                    background: white; 
                    border: 1px solid var(--gray-200); 
                    border-radius: 12px; 
                    padding: 24px; 
                    margin-bottom: 24px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                `;
                aiSuggestionsCard.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center;">
                            <div style="background: #f0f9ff; border-radius: 8px; padding: 8px; margin-right: 12px;">
                                <svg style="width: 20px; height: 20px; color: #0284c7;" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7A1,1 0 0,0 14,8H16A1,1 0 0,0 17,7V5.73C16.4,5.39 16,4.74 16,4A2,2 0 0,1 18,2A2,2 0 0,1 20,4C20,4.74 19.6,5.39 19,5.73V7A3,3 0 0,1 16,10H15V11.26L22.24,18.5C22.64,18.9 22.64,19.54 22.24,19.94L19.94,22.24C19.54,22.64 18.9,22.64 18.5,22.24L12,15.74L5.5,22.24C5.1,22.64 4.46,22.64 4.06,22.24L1.76,19.94C1.36,19.54 1.36,18.9 1.76,18.5L9,11.26V10H8A3,3 0 0,1 5,7V5.73C4.4,5.39 4,4.74 4,4A2,2 0 0,1 6,2A2,2 0 0,1 8,4C8,4.74 7.6,5.39 7,5.73V7A1,1 0 0,0 8,8H10A1,1 0 0,0 11,7V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2Z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--gray-800);">步驟 2：AI 專業建議</h3>
                                <p style="margin: 0; font-size: 13px; color: var(--gray-500);">基於影片內容的智慧分析與建議</p>
                            </div>
                        </div>
                        <div style="background: #0284c7; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                            AI 分析
                        </div>
                    </div>
                    <div class="markdown-content ai-suggestions-content" style="line-height: 1.6; font-size: 14px;">${marked.parse(suggestions)}</div>
                    
                    <!-- 自定義分析區域 -->
                    <div style="margin-top: 20px; border-top: 1px solid var(--gray-200); padding-top: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center;">
                                <svg style="width: 16px; height: 16px; margin-right: 8px; color: #6b7280;" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"/>
                                </svg>
                                <span style="font-weight: 600; color: var(--gray-700); font-size: 14px;">需要更具體的建議？</span>
                            </div>
                            <button id="toggleCustomPrompt" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">
                                ✏️ 自定義分析
                            </button>
                        </div>
                        
                        <!-- 折疊式自定義區域 -->
                        <div id="customPromptSection" style="display: none;">
                            <div style="background: #f8fafc; border: 1px solid var(--gray-200); border-radius: 8px; padding: 16px;">
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
                                        💭 描述您的具體需求
                                    </label>
                                    <textarea 
                                        id="customPrompt" 
                                        placeholder="例如：這是一個產品展示影片，請重點關注產品特寫鏡頭；這是教學影片，請保持講師完整出現在畫面中；這是風景影片，請突出主要景觀..."
                                        style="width: 100%; height: 80px; padding: 12px; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical; font-size: 13px; line-height: 1.4; box-sizing: border-box;"
                                    ></textarea>
                                </div>
                                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                    <button id="cancelPromptBtn" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">
                                        取消
                                    </button>
                                    <button id="reAnalyzeBtn" class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">
                                        🔄 重新分析
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                suggestionsContainer.appendChild(aiSuggestionsCard);
                
                // 為自定義分析按鈕添加事件處理器
                const toggleCustomPromptBtn = aiSuggestionsCard.querySelector('#toggleCustomPrompt');
                const customPromptSection = aiSuggestionsCard.querySelector('#customPromptSection');
                const cancelPromptBtn = aiSuggestionsCard.querySelector('#cancelPromptBtn');
                const reAnalyzeBtn = aiSuggestionsCard.querySelector('#reAnalyzeBtn');
                const customPromptTextarea = aiSuggestionsCard.querySelector('#customPrompt');
                
                toggleCustomPromptBtn.addEventListener('click', () => {
                    if (customPromptSection.style.display === 'none') {
                        customPromptSection.style.display = 'block';
                        toggleCustomPromptBtn.innerHTML = '❌ 取消自定義';
                        customPromptTextarea.focus();
                    } else {
                        customPromptSection.style.display = 'none';
                        toggleCustomPromptBtn.innerHTML = '✏️ 自定義分析';
                        customPromptTextarea.value = '';
                    }
                });
                
                cancelPromptBtn.addEventListener('click', () => {
                    customPromptSection.style.display = 'none';
                    toggleCustomPromptBtn.innerHTML = '✏️ 自定義分析';
                    customPromptTextarea.value = '';
                });
                
                reAnalyzeBtn.addEventListener('click', async () => {
                    const customPrompt = customPromptTextarea.value.trim();
                    if (!customPrompt) {
                        showStatus('請輸入自定義分析需求', 'error');
                        return;
                    }
                    if (!fileId) {
                        showStatus('請先選擇影片', 'error');
                        return;
                    }
                    
                    // 隱藏自定義區域
                    customPromptSection.style.display = 'none';
                    toggleCustomPromptBtn.innerHTML = '✏️ 自定義分析';
                    
                    await runCustomAnalysis(fileId, customPrompt);
                });
            }

            // === 第五步：推薦尺寸模板 ===
            const recommendedTemplates = allTemplates.filter(t => recommendedNames.includes(t.name));
            if (recommendedTemplates.length === 0) {
                const noSuggestionCard = document.createElement('div');
                noSuggestionCard.style.cssText = `
                    background: #fef2f2; 
                    border: 1px solid #fecaca; 
                    border-radius: 12px; 
                    padding: 24px; 
                    text-align: center;
                `;
                noSuggestionCard.innerHTML = `
                    <svg style="width: 48px; height: 48px; color: #dc2626; margin-bottom: 16px;" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z"/>
                    </svg>
                    <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #dc2626;">未找到合適的建議尺寸</h3>
                    <p style="margin: 0; color: #991b1b; font-size: 14px;">請嘗試使用手動轉換功能或聯繫技術支援</p>
                `;
                suggestionsContainer.appendChild(noSuggestionCard);
                return;
            }

            const templatesCard = document.createElement('div');
            templatesCard.style.cssText = `
                background: white; 
                border: 1px solid var(--gray-200); 
                border-radius: 12px; 
                padding: 24px; 
                margin-bottom: 24px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            `;
            templatesCard.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center;">
                        <div style="background: #fef3c7; border-radius: 8px; padding: 8px; margin-right: 12px;">
                            <svg style="width: 20px; height: 20px; color: #d97706;" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--gray-800);">步驟 3：選擇推薦尺寸</h3>
                            <p style="margin: 0; font-size: 13px; color: var(--gray-500);">點擊「預覽」查看效果，確認後點擊「開始轉換」</p>
                        </div>
                    </div>
                    <div style="background: #d97706; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                        最後步驟
                    </div>
                </div>
                <div class="recommended-templates-grid"></div>
            `;
            suggestionsContainer.appendChild(templatesCard);

            const templatesGrid = templatesCard.querySelector('.recommended-templates-grid');
            recommendedTemplates.forEach(template => {
                const card = document.createElement('div');
                card.className = 'recommended-template-card';
                card.style.cssText = `
                    border: 1px solid var(--gray-200);
                    border-radius: 8px;
                    padding: 16px;
                    margin-bottom: 16px;
                    transition: all 0.3s ease;
                    hover-effect: border-color: var(--primary);
                `;
                card.addEventListener('mouseenter', () => {
                    card.style.borderColor = 'var(--primary)';
                    card.style.boxShadow = '0 4px 12px rgba(37, 99, 235, 0.15)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.borderColor = 'var(--gray-200)';
                    card.style.boxShadow = 'none';
                });

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <div style="font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px;">${template.name}</div>
                            <div style="font-size: 14px; color: var(--gray-600); margin-bottom: 4px;">${template.width} × ${template.height}</div>
                            <div style="font-size: 12px; color: var(--gray-500);">${template.description}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary preview-btn" style="font-size: 12px; padding: 6px 12px;">📱 預覽</button>
                        </div>
                    </div>
                    <div class="preview-section" style="display: none; border-top: 1px solid var(--gray-200); padding-top: 16px; margin-top: 12px;">
                        <div class="preview-loading" style="text-align: center; padding: 20px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 8px; font-size: 12px; color: var(--primary);">正在生成預覽...</p>
                        </div>
                        <div class="preview-result" style="display: none;">
                            <div style="display: flex; gap: 16px; align-items: flex-start;">
                                <div style="position: relative;">
                                    <div style="position: relative; display: inline-block;">
                                        <img class="preview-image" style="max-width: 200px; border-radius: 8px; border: 1px solid var(--gray-200); display: block;">
                                        <button class="template-preview-btn btn btn-secondary" style="position: absolute; top: 8px; right: 8px; font-size: 11px; padding: 4px 8px; display: none;">
                                            🎬 動態預覽
                                        </button>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div class="preview-warning" style="display: none; padding: 12px; border-radius: 8px; font-size: 12px; margin-bottom: 12px;">
                                    </div>
                                    <button class="btn btn-primary convert-btn" style="font-size: 14px; padding: 8px 16px; width: 100%; margin-bottom: 8px;"></button>
                                    <div class="frame-counter" style="display: none; font-size: 11px; color: var(--gray-400); text-align: center;">
                                    </div>
                                    <p style="font-size: 11px; color: var(--gray-500); margin: 8px 0 0 0; line-height: 1.4; text-align: center;">
                                        💡 預覽會展示多個關鍵影片片段的轉換效果
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const previewBtn = card.querySelector('.preview-btn');
                const convertBtn = card.querySelector('.convert-btn');
                const previewSection = card.querySelector('.preview-section');
                const previewLoading = card.querySelector('.preview-loading');
                const previewResult = card.querySelector('.preview-result');
                
                convertBtn.innerHTML = `🚀 開始轉換 ${template.name}`;

                previewBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    
                    if (previewSection.style.display === 'block') {
                        previewSection.style.display = 'none';
                        activePreviewSections.delete(template.name);
                        previewBtn.textContent = '📱 預覽';
                        return;
                    }
                    
                    previewBtn.textContent = '❌ 關閉預覽';
                    await generatePreview(template, previewSection, previewLoading, previewResult);
                });
                
                convertBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const center = calculateMultiSubjectCenter(selectedLLMSubjects);
                    startConversion(template, center);
                });
                
                templatesGrid.appendChild(card);
            });
        }

        function displayIntegratedLlmChoices(subjects) {
            const choicesContainer = document.getElementById('integratedSubjectChoices');
            choicesContainer.innerHTML = '';
            if (!subjects || subjects.length === 0) {
                choicesContainer.innerHTML = "<p style='color: var(--gray-500); font-size: 14px; text-align: center; padding: 16px;'>未偵測到主要對象</p>";
                return;
            }
            
            // 添加多選說明
            const multiSelectInfo = document.createElement('div');
            multiSelectInfo.className = 'multi-select-info';
            multiSelectInfo.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <svg style="width: 16px; height: 16px; margin-right: 8px; color: var(--primary);" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z"/>
                    </svg>
                    <strong style="color: var(--primary);">智慧多選模式</strong>
                </div>
                <p style="margin: 0; font-size: 12px; line-height: 1.4; color: var(--primary-dark);">
                    ✓ 可同時選擇多個重要物體<br>
                    ✓ AI 自動計算加權最佳中心點<br>
                    ✓ 支援重要性和信心度優化
                </p>
            `;
            choicesContainer.appendChild(multiSelectInfo);
            
            subjects.forEach((subject, index) => {
                const label = document.createElement('label');
                label.className = 'subject-choice';
                // 構建顯示文字，包含信心度和重要性
                let displayText = subject.subject;
                if (subject.confidence !== undefined) {
                    const confidencePercent = Math.round(subject.confidence * 100);
                    displayText += ` (${confidencePercent}%)`;
                }
                
                // 重要性標示
                let importanceIcon = '';
                if (subject.importance === 'high') {
                    importanceIcon = '🔥';
                } else if (subject.importance === 'medium') {
                    importanceIcon = '⭐';
                } else if (subject.importance === 'low') {
                    importanceIcon = '💡';
                }
                
                // 改為 checkbox 支援多選
                const subjectId = `subject_${index}`;
                label.innerHTML = `
                    <input type="checkbox" id="${subjectId}" name="llmSubjects" value='${JSON.stringify(subject)}' ${index === 0 ? 'checked' : ''}>
                    <img src="${subject.thumbnail}" alt="${subject.subject}">
                    <span>
                        ${importanceIcon} ${displayText}
                        ${subject.crop_strategy ? `<br><small>策略: ${subject.crop_strategy}</small>` : ''}
                    </span>
                `;
                
                const checkbox = label.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', async () => {
                    // 同步更新預覽區域的選中狀態
                    syncSubjectSelection();
                    
                    console.log(`🎯 AI 推薦區域主體選擇更新: ${selectedLLMSubjects.length} 個主體選中`);
                    
                    // 顯示全局狀態提示
                    const selectedNames = selectedLLMSubjects.map(s => s.subject).join('、');
                    showSubjectSwitchIndicator(selectedNames || '無選擇');
                    
                    // 重新生成AI專業建議
                    await updateAIRecommendations();
                    
                    // 重新生成所有已顯示的預覽
                    if (activePreviewSections.size > 0) {
                        console.log(`🔄 重新生成 ${activePreviewSections.size} 個預覽...`);
                        await refreshAllActivePreviews();
                    }
                    
                    // 隱藏全局狀態提示
                    hideSubjectSwitchIndicator();
                });
                choicesContainer.appendChild(label);
            });
            
            // 初始化選中的主體
            syncSubjectSelection();
        }
        
                 function updateSelectedSubjects() {
             const checkboxes = document.querySelectorAll('input[name="llmSubjects"]:checked');
             selectedLLMSubjects = Array.from(checkboxes).map(cb => JSON.parse(cb.value));
             console.log('🎯 已選中主體:', selectedLLMSubjects.map(s => s.subject));
         }
         
         function syncSubjectSelection() {
             // 從預覽區域獲取選中的主體
             const previewCheckboxes = document.querySelectorAll('input[name="previewLlmSubjects"]:checked');
             const previewSelected = Array.from(previewCheckboxes).map(cb => JSON.parse(cb.value));
             
             // 從 AI 推薦區域獲取選中的主體
             const aiCheckboxes = document.querySelectorAll('input[name="llmSubjects"]:checked');
             const aiSelected = Array.from(aiCheckboxes).map(cb => JSON.parse(cb.value));
             
             // 合併兩個區域的選擇（優先使用最近操作的區域）
             if (previewCheckboxes.length > 0) {
                 selectedLLMSubjects = previewSelected;
                 // 同步到 AI 推薦區域
                 syncCheckboxes('llmSubjects', selectedLLMSubjects);
             } else if (aiCheckboxes.length > 0) {
                 selectedLLMSubjects = aiSelected;
                 // 同步到預覽區域
                 syncCheckboxes('previewLlmSubjects', selectedLLMSubjects);
             } else {
                 selectedLLMSubjects = [];
             }
             
             console.log('🔄 同步後選中主體:', selectedLLMSubjects.map(s => s.subject));
         }
         
         function syncCheckboxes(targetName, selectedSubjects) {
             const targetCheckboxes = document.querySelectorAll(`input[name="${targetName}"]`);
             targetCheckboxes.forEach(checkbox => {
                 const subjectData = JSON.parse(checkbox.value);
                 const isSelected = selectedSubjects.some(s => s.subject === subjectData.subject);
                 checkbox.checked = isSelected;
             });
         }
         
         function calculateMultiSubjectCenter(subjects) {
             if (!subjects || subjects.length === 0) {
                 return null;
             }
             
             if (subjects.length === 1) {
                 return subjects[0].center;
             }
             
             // 計算多個主體的加權中心點
             let totalWeight = 0;
             let weightedX = 0;
             let weightedY = 0;
             
             subjects.forEach(subject => {
                 if (subject.center && Array.isArray(subject.center) && subject.center.length === 2) {
                     // 根據重要性和信心度計算權重
                     let weight = 1;
                     if (subject.importance === 'high') weight = 3;
                     else if (subject.importance === 'medium') weight = 2;
                     else if (subject.importance === 'low') weight = 1;
                     
                     if (subject.confidence) {
                         weight *= subject.confidence;
                     }
                     
                     weightedX += subject.center[0] * weight;
                     weightedY += subject.center[1] * weight;
                     totalWeight += weight;
                 }
             });
             
             if (totalWeight === 0) {
                 return null;
             }
             
             const centerX = Math.round(weightedX / totalWeight);
             const centerY = Math.round(weightedY / totalWeight);
             
             console.log(`🎯 計算多主體中心點: [${centerX}, ${centerY}] (基於 ${subjects.length} 個主體)`);
             return [centerX, centerY];
         }

        async function generatePreview(template, previewSection, previewLoading, previewResult) {
            previewSection.style.display = 'block';
            previewLoading.style.display = 'block';
            previewResult.style.display = 'none';
            
            // 記錄活動的預覽
            activePreviewSections.set(template.name, {
                section: previewSection,
                loading: previewLoading,
                result: previewResult
            });
            
            try {
                // 準備請求體
                const requestBody = {
                    file_id: fileId,
                    template_name: template.name
                };
                
                // 檢查是否有多選主體
                if (selectedLLMSubjects && selectedLLMSubjects.length > 0) {
                    // 收集所有選中主體的中心點
                    const selectedCenters = [];
                    selectedLLMSubjects.forEach(subjectName => {
                        const subject = allSubjects.find(s => s.subject === subjectName);
                        if (subject && subject.center) {
                            selectedCenters.push(subject.center);
                        }
                    });
                    
                    if (selectedCenters.length > 1) {
                        requestBody.centers = selectedCenters;
                    } else if (selectedCenters.length === 1) {
                        requestBody.center = selectedCenters[0];
                    }
                }
                
                const response = await fetch('/api/generate_preview', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error('預覽生成失敗');
                }
                
                const result = await response.json();
                console.log('🎬 預覽 API 返回結果:', result);
                
                previewLoading.style.display = 'none';
                previewResult.style.display = 'block';
                
                const previewImage = previewResult.querySelector('.preview-image');
                const previewWarning = previewResult.querySelector('.preview-warning');
                const frameCounter = previewResult.querySelector('.frame-counter');
                const templatePreviewBtn = previewResult.querySelector('.template-preview-btn');
                
                // 設置預覽圖和動態預覽按鈕
                if (result.preview_frames && result.preview_frames.length > 0) {
                    // 設置靜態預覽圖（第一幀）
                    previewImage.src = result.preview_frames[0];
                    console.log(`✅ 設置靜態預覽圖，共 ${result.preview_frames.length} 幀可用`);
                    
                    frameCounter.style.display = 'block';
                    let frameText = `📷 靜態預覽`;
                    if (result.preview_frames.length > 1) {
                        frameText = `📹 ${result.preview_frames.length} 個預覽幀`;
                    }
                    if (result.has_contours && result.subject_name) {
                        frameText += ` • 🎯 ${result.subject_name} 輪廓`;
                    }
                    frameCounter.textContent = frameText;
                    
                    // 如果有多幀，顯示動態預覽按鈕
                    if (result.preview_frames.length > 1 && templatePreviewBtn) {
                        templatePreviewBtn.style.display = 'block';
                        setupTemplatePreviewButton(templatePreviewBtn, previewImage, result.preview_frames, result.subject_name);
                    }
                } else {
                    console.error('❌ 沒有收到預覽幀數據:', result);
                }
                
                // 顯示裁切分析結果
                if (result.is_adjusted) {
                    previewWarning.style.display = 'block';
                    previewWarning.className = 'recommendation-info';
                    previewWarning.innerHTML = `${ICONS.adjust} <span>系統已最佳化調整影片構圖</span>`;
                } else {
                    previewWarning.style.display = 'none';
                }
                
                // 獲取智慧裁切分析
                fetchSmartCropAnalysis(template, null, previewWarning);
                
            } catch (error) {
                previewLoading.style.display = 'none';
                previewResult.innerHTML = `<p style="color: var(--error); font-size: 12px;">預覽生成失敗: ${error.message}</p>`;
                previewResult.style.display = 'block';
            }
        }

        function setupTemplatePreviewButton(previewBtn, imageElement, frames, subjectName) {
            console.log('🎬 設置模板預覽按鈕，幀數:', frames.length);
            
            let previewInterval = null;
            let previewFrames = frames;
            let isPlaying = false;
            
            // 設置按鈕點擊事件
            previewBtn.addEventListener('click', () => {
                if (isPlaying) {
                    stopTemplatePreview();
                } else {
                    startTemplatePreview();
                }
            });
            
            function startTemplatePreview() {
                if (isPlaying) return;
                
                console.log('🎬 開始模板動態預覽，總幀數:', previewFrames.length);
                isPlaying = true;
                previewBtn.textContent = '⏸️ 停止預覽';
                previewBtn.disabled = false;
                
                let currentFrame = 0;
                
                // 開始動畫
                previewInterval = setInterval(() => {
                    currentFrame = (currentFrame + 1) % previewFrames.length;
                    console.log(`📷 模板預覽切換到第 ${currentFrame + 1} 幀`);
                    imageElement.src = previewFrames[currentFrame];
                }, 800); // 每800ms切換一幀，與原始影片預覽相同
                
                const frameCountText = subjectName ? 
                    `🎬 ${previewFrames.length} 幀動態預覽 (${subjectName} 輪廓)` : 
                    `🎬 ${previewFrames.length} 幀動態預覽`;
                
                showStatus(frameCountText, 'success');
            }
            
            function stopTemplatePreview() {
                if (!isPlaying) return;
                
                isPlaying = false;
                
                if (previewInterval) {
                    clearInterval(previewInterval);
                    previewInterval = null;
                }
                
                // 恢復第一幀
                imageElement.src = previewFrames[0];
                
                previewBtn.textContent = '🎬 動態預覽';
                previewBtn.disabled = false;
                
                console.log('⏹️ 模板動態預覽已停止');
                showStatus('動態預覽已停止', 'info');
            }
        }

        function setupFrameAnimation(imageElement, frames) {
            console.log('🎬 開始設置幀動畫，幀數:', frames.length);
            let currentFrame = 0;
            let animationInterval;
            
            // 設置初始幀
            imageElement.src = frames[0];
            console.log('📷 設置初始幀:', frames[0].substring(0, 50) + '...');
            
            // 添加播放/暫停控制
            imageElement.style.cursor = 'pointer';
            imageElement.style.border = '2px solid var(--primary)';
            imageElement.style.borderRadius = 'var(--border-radius)';
            
            // 添加播放指示器
            const container = imageElement.parentElement;
            const playIndicator = document.createElement('div');
            playIndicator.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: rgba(37, 99, 235, 0.9); color: white; padding: 8px 12px; 
                            border-radius: 20px; font-size: 11px; pointer-events: none; 
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.3s ease;">
                    <svg style="width: 12px; height: 12px; margin-right: 4px; vertical-align: -1px;" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    點擊播放動態預覽
                </div>
            `;
            playIndicator.style.position = 'absolute';
            playIndicator.style.top = '0';
            playIndicator.style.left = '0';
            playIndicator.style.right = '0';
            playIndicator.style.bottom = '0';
            playIndicator.style.pointerEvents = 'none';
            
            // 確保容器是相對定位
            if (getComputedStyle(container).position === 'static') {
                container.style.position = 'relative';
            }
            container.appendChild(playIndicator);
            console.log('✅ 播放指示器已添加到容器');
            
            let isPlaying = false;
            
            const startAnimation = () => {
                if (isPlaying) return;
                console.log('🎬 開始播放動畫，總幀數:', frames.length);
                isPlaying = true;
                playIndicator.style.display = 'none';
                
                animationInterval = setInterval(() => {
                    currentFrame = (currentFrame + 1) % frames.length;
                    console.log(`📷 切換到第 ${currentFrame + 1} 幀`);
                    imageElement.src = frames[currentFrame];
                }, 600); // 每600ms切換一幀，更流暢
                
                // 播放完整循環後停止（至少4秒）
                const totalDuration = Math.max(4000, frames.length * 600 * 2);
                setTimeout(() => {
                    stopAnimation();
                }, totalDuration);
            };
            
            const stopAnimation = () => {
                if (!isPlaying) return;
                isPlaying = false;
                clearInterval(animationInterval);
                currentFrame = 0;
                imageElement.src = frames[0];
                playIndicator.style.display = 'block';
            };
            
            // 點擊播放/暫停
            imageElement.addEventListener('click', () => {
                if (isPlaying) {
                    stopAnimation();
                } else {
                    startAnimation();
                }
            });
            
            // 自動播放一次
            setTimeout(startAnimation, 500);
        }

        // 追蹤當前顯示的預覽
        let activePreviewSections = new Map(); // template.name -> {section, loading, result}

        function displayLlmChoices(subjects) {
            const choicesContainer = document.getElementById('subjectChoices');
            choicesContainer.innerHTML = '';
            if (!subjects || subjects.length === 0) {
                choicesContainer.innerHTML = "<p style='color: var(--gray-500); font-size: 14px; text-align: center; padding: 20px;'>🤖 AI 正在分析中...</p>";
                return;
            }
            
            // 分析完成後，主體選擇區域保持空白，狀態顯示已移到影片預覽下方
            choicesContainer.innerHTML = '';
        }

                 async function updateAIRecommendations() {
             if (!fileId || !selectedLLMSubjects || selectedLLMSubjects.length === 0) {
                 console.log('⚠️ 無有效的檔案ID或選中主體，跳過AI建議更新');
                 return;
             }
             
             console.log('🤖 開始更新AI專業建議，基於選中主體:', selectedLLMSubjects.map(s => s.subject));
             
             // 找到AI建議卡片
             const aiSuggestionsContainer = document.getElementById('aiSuggestions');
             const existingAiCard = aiSuggestionsContainer.querySelector('.ai-suggestions-content')?.closest('div');
             
             if (!existingAiCard) {
                 console.log('⚠️ 未找到現有的AI建議卡片，跳過更新');
                 return;
             }
             
             // 顯示加載狀態
             const aiSuggestionsContent = existingAiCard.querySelector('.ai-suggestions-content');
             if (aiSuggestionsContent) {
                 aiSuggestionsContent.innerHTML = `
                     <div style="display: flex; align-items: center; justify-content: center; padding: 20px;">
                         <div class="spinner" style="margin-right: 12px;"></div>
                         <span style="color: var(--primary);">🎯 根據您選擇的保護對象重新分析中...</span>
                     </div>
                 `;
             }
             
             try {
                 // 構造針對選中主體的分析請求
                 const analyzeRequestBody = {
                     file_id: fileId,
                     custom_prompt: `請針對用戶選中的保護對象「${selectedLLMSubjects.map(s => s.subject).join('、')}」重新分析影片內容並提供專業建議。

用戶選擇這些對象作為重點保護目標，請：
1. 分析這些對象在影片中的特點和重要性
2. 針對保護這些對象提供裁切和尺寸建議
3. 說明如何確保這些對象在轉換後的影片中得到最佳呈現
4. 提供具體的構圖和視覺建議

${currentCustomPrompt ? `\n用戶的原始需求：${currentCustomPrompt}` : ''}`
                 };
                 
                 const response = await fetch('/api/analyze', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify(analyzeRequestBody)
                 });
                 
                 if (!response.ok) {
                     throw new Error('AI建議更新失敗');
                 }
                 
                 const result = await response.json();
                 console.log('🤖 收到更新的AI建議:', result);
                 
                 // 更新AI建議內容
                 if (result.suggestions && aiSuggestionsContent) {
                     aiSuggestionsContent.innerHTML = `
                         <div style="background: #fff7ed; border: 1px solid #fed7aa; border-radius: 6px; padding: 12px; margin-bottom: 16px; font-size: 12px;">
                             <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                 <svg style="width: 14px; height: 14px; margin-right: 6px; color: #ea580c;" viewBox="0 0 24 24" fill="currentColor">
                                     <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7A1,1 0 0,0 14,8H16A1,1 0 0,0 17,7V5.73C16.4,5.39 16,4.74 16,4A2,2 0 0,1 18,2A2,2 0 0,1 20,4C20,4.74 19.6,5.39 19,5.73V7A3,3 0 0,1 16,10H15V11.26L22.24,18.5C22.64,18.9 22.64,19.54 22.24,19.94L19.94,22.24C19.54,22.64 18.9,22.64 18.5,22.24L12,15.74L5.5,22.24C5.1,22.64 4.46,22.64 4.06,22.24L1.76,19.94C1.36,19.54 1.36,18.9 1.76,18.5L9,11.26V10H8A3,3 0 0,1 5,7V5.73C4.4,5.39 4,4.74 4,4A2,2 0 0,1 6,2A2,2 0 0,1 8,4C8,4.74 7.6,5.39 7,5.73V7A1,1 0 0,0 8,8H10A1,1 0 0,0 11,7V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2Z"/>
                                 </svg>
                                 <strong style="color: #ea580c;">已根據您的保護對象選擇更新建議</strong>
                             </div>
                             <span style="color: #9a3412;">聚焦於：${selectedLLMSubjects.map(s => s.subject).join('、')}</span>
                         </div>
                         <div style="line-height: 1.6; font-size: 14px;">${marked.parse(result.suggestions)}</div>
                     `;
                     
                     // 平滑滾動到更新的建議
                     aiSuggestionsContent.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     
                     console.log('✅ AI專業建議已更新完成');
                 }
                 
             } catch (error) {
                 console.error('❌ AI建議更新失敗:', error);
                 
                 // 顯示錯誤狀態
                 if (aiSuggestionsContent) {
                     aiSuggestionsContent.innerHTML = `
                         <div style="display: flex; align-items: center; justify-content: center; padding: 20px; color: var(--error);">
                             <svg style="width: 16px; height: 16px; margin-right: 8px;" viewBox="0 0 24 24" fill="currentColor">
                                 <path d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z"/>
                             </svg>
                             <span>AI建議更新失敗: ${error.message}</span>
                         </div>
                         <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 6px; font-size: 12px; color: var(--gray-600);">
                             <strong>原始建議仍然有效</strong><br>
                             您可以繼續使用最初的AI分析建議，或嘗試重新選擇保護對象。
                         </div>
                     `;
                 }
                 
                 showStatus(`AI建議更新失敗: ${error.message}`, 'error');
             }
         }
         
         async function refreshAllActivePreviews() {
             const refreshPromises = [];
             
             for (const [templateName, previewElements] of activePreviewSections) {
                 // 找到對應的模板
                 const template = allTemplates.find(t => t.name === templateName);
                 if (!template) continue;
                 
                 console.log(`🔄 重新生成 ${templateName} 的預覽...`);
                 
                 // 檢查 DOM 元素是否存在，避免 null 錯誤
                 const { section, loading, result } = previewElements;
                 if (!loading || !result || !section) {
                     console.warn(`⚠️ ${templateName} 的預覽元素不完整，跳過更新`);
                     continue;
                 }
                 
                 // 顯示更新中狀態
                 try {
                     loading.style.display = 'block';
                     result.style.display = 'none';
                     loading.innerHTML = `
                         <div class="spinner"></div>
                         <p style="margin-top: 8px; font-size: 12px; color: var(--primary);">🎯 切換主體，重新生成預覽中...</p>
                     `;
                     
                     // 停止任何正在播放的預覽
                     const templatePreviewBtn = result.querySelector('.template-preview-btn');
                     if (templatePreviewBtn) {
                         templatePreviewBtn.style.display = 'none';
                         templatePreviewBtn.textContent = '🎬 動態預覽';
                     }
                     
                     // 異步生成預覽
                     refreshPromises.push(generatePreview(template, section, loading, result));
                 } catch (error) {
                     console.error(`❌ ${templateName} 預覽更新失敗:`, error);
                 }
             }
             
             // 等待所有預覽完成
             await Promise.all(refreshPromises);
             console.log('✅ 所有預覽已更新完成');
         }

         function showSubjectSwitchIndicator(subjectName) {
             // 在 AI 推薦結果區域顯示切換提示
             const aiSuggestionsContainer = document.getElementById('aiSuggestions');
             let indicator = document.getElementById('subjectSwitchIndicator');
             
             if (!indicator) {
                 indicator = document.createElement('div');
                 indicator.id = 'subjectSwitchIndicator';
                 indicator.style.cssText = `
                     position: sticky;
                     top: 10px;
                     background: linear-gradient(135deg, var(--primary), var(--primary-dark));
                     color: white;
                     padding: 12px 16px;
                     border-radius: var(--border-radius);
                     font-size: 12px;
                     text-align: center;
                     box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
                     z-index: 100;
                     margin-bottom: 16px;
                     animation: slideDown 0.3s ease-out;
                 `;
                 
                 // 插入到 AI 推薦結果的頂部
                 aiSuggestionsContainer.insertBefore(indicator, aiSuggestionsContainer.firstChild);
             }
             
             indicator.innerHTML = `
                 <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                     <svg style="width: 16px; height: 16px; animation: spin 1s linear infinite;" viewBox="0 0 24 24" fill="currentColor">
                         <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
                     </svg>
                     <span>🎯 已切換至「${subjectName}」，正在更新AI建議與預覽...</span>
                 </div>
             `;
             indicator.style.display = 'block';
         }

         function hideSubjectSwitchIndicator() {
             const indicator = document.getElementById('subjectSwitchIndicator');
             if (indicator) {
                 indicator.style.animation = 'slideUp 0.3s ease-out';
                 setTimeout(() => {
                     indicator.style.display = 'none';
                 }, 300);
             }
         }

         async function fetchSmartCropAnalysis(template, center, warningElement) {
             try {
                 // 準備請求體
                 const requestBody = {
                     file_id: fileId,
                     template_name: template.name
                 };
                 
                 // 檢查是否有多選主體
                 if (selectedLLMSubjects && selectedLLMSubjects.length > 0) {
                     // 收集所有選中主體的中心點
                     const selectedCenters = [];
                     selectedLLMSubjects.forEach(subjectName => {
                         const subject = allSubjects.find(s => s.subject === subjectName);
                         if (subject && subject.center) {
                             selectedCenters.push(subject.center);
                         }
                     });
                     
                     if (selectedCenters.length > 1) {
                         requestBody.centers = selectedCenters;
                     } else if (selectedCenters.length === 1) {
                         requestBody.center = selectedCenters[0];
                     } else if (center) {
                         requestBody.center = center;
                     }
                 } else if (center) {
                     requestBody.center = center;
                 }
                 
                 const response = await fetch('/api/smart_crop_analysis', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify(requestBody)
                 });
                 
                 if (response.ok) {
                     const analysis = await response.json();
                     displayCropAnalysis(analysis, warningElement);
                 }
             } catch (error) {
                 console.error('智慧裁切分析失敗:', error);
             }
         }

         function displayCropAnalysis(analysis, warningElement) {
             let analysisHTML = '';
             let className = 'recommendation-info';
             
             if (analysis.is_perfect_fit) {
                 analysisHTML = `
                     <span style="color: var(--success);">
                         ✅ 完美適配 - 主體能完整顯示在目標尺寸中
                     </span>
                 `;
                 className = 'recommendation-success';
             } else if (analysis.recommendation === '良好適配') {
                 analysisHTML = `
                     <span style="color: var(--primary);">
                         ⭐ 良好適配 - 主體基本完整，微調 ${analysis.offset_x > analysis.offset_y ? 'X' : 'Y'} 軸 ${Math.max(analysis.offset_x, analysis.offset_y)}px
                     </span>
                 `;
             } else {
                 analysisHTML = `
                     <span style="color: var(--warning);">
                         ⚠️ 需要調整 - 主體可能被裁切，偏移 X:${analysis.offset_x}px Y:${analysis.offset_y}px
                     </span>
                 `;
                 className = 'recommendation-warning';
             }
             
             // 添加詳細資訊
             analysisHTML += `
                 <br><small style="color: var(--gray-500); font-size: 10px;">
                     縮放: ${analysis.scale_factor}x | 覆蓋率: ${Math.min(analysis.coverage_x, analysis.coverage_y)}%
                 </small>
             `;
             
             warningElement.innerHTML = analysisHTML;
             warningElement.className = className;
             warningElement.style.display = 'block';
         }

        function setupManualTab() {
            const grid = document.getElementById('templatesGridManual');
            grid.innerHTML = '';
            allTemplates.forEach(t => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.innerHTML = `<div class="template-name">${t.name}</div><div class="template-size">${t.width}×${t.height}</div><div class="template-desc">${t.description}</div>`;
                card.onclick = () => {
                    document.querySelectorAll('#templatesGridManual .template-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedTemplate = t;
                    document.getElementById('convertBtnManual').disabled = false;
                };
                grid.appendChild(card);
            });
            const llmCropOption = document.querySelector('.crop-option-group label:last-child');
            if (allSubjects && allSubjects.length > 0 && llmCropOption) {
                llmCropOption.style.display = 'flex';
            }
        }
        
        async function startConversion(template, center) {
            if (!fileId || !template) return showStatus('請先選擇影片和目標尺寸', 'error');
            showProgress(true);
            updateProgress(0, '準備轉換...');
            
            // 確定裁切模式和中心點
            let cropMode = 'center';
            let finalCenter = null;
            let finalCenters = null;
            
            // 檢查是否有多選主體
            if (selectedLLMSubjects && selectedLLMSubjects.length > 0) {
                cropMode = 'llm';
                
                // 收集所有選中主體的中心點
                const selectedCenters = [];
                selectedLLMSubjects.forEach(subjectName => {
                    const subject = allSubjects.find(s => s.subject === subjectName);
                    if (subject && subject.center) {
                        selectedCenters.push(subject.center);
                    }
                });
                
                if (selectedCenters.length > 1) {
                    finalCenters = selectedCenters;
                    console.log('🎯 使用多主體 AI 智慧裁切模式，中心點:', selectedCenters);
                } else if (selectedCenters.length === 1) {
                    finalCenter = selectedCenters[0];
                    console.log('🎯 使用單主體 AI 智慧裁切模式，中心點:', selectedCenters[0]);
                } else {
                    console.log('⚠️ 沒有找到有效的主體中心點，使用置中裁切');
                    cropMode = 'center';
                }
            } else if (center && Array.isArray(center) && center.length === 2) {
                // 向後相容：支援直接傳入的中心點
                cropMode = 'llm';
                finalCenter = center;
                console.log('🎯 使用傳入的 AI 智慧裁切模式，中心點:', center);
            } else {
                console.log('📐 使用置中裁切模式');
            }
            
            const body = {
                file_id: fileId,
                width: template.width,
                height: template.height,
                crop_mode: cropMode
            };
            
            // 根據情況添加中心點參數
            if (finalCenters) {
                body.centers = finalCenters;
            } else if (finalCenter) {
                body.center = finalCenter;
            }
            try {
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                updateProgress(50, '轉換中...');
                if (!response.ok) throw new Error((await response.json()).error || '轉換失敗');
                const result = await response.json();
                updateProgress(100);
                setTimeout(() => {
                    showProgress(false);
                    showResult(result.download_url, result.filename);
                    showStatus('轉換成功', 'success');
                }, 500);
            } catch (error) {
                showProgress(false);
                showStatus('轉換失敗: ' + error.message, 'error');
            }
        }
        
        function showResult(finalUrl, finalFilename) {
            const resultSection = document.getElementById('resultSection');
            resultSection.style.display = 'block';
            const originalVideo = document.getElementById('originalVideo');
            const convertedVideo = document.getElementById('convertedVideo');
            
            // 設定原始影片來源
            if(selectedFile) {
                // 如果是新上傳的文件，使用本地對象 URL
                console.log('使用本地檔案:', selectedFile.name);
                originalVideo.src = URL.createObjectURL(selectedFile);
            } else if(fileId) {
                // 如果是從歷史記錄選擇的文件，構建伺服器 URL
                const originalFileName = getOriginalFileName(fileId);
                console.log('使用伺服器檔案:', originalFileName);
                originalVideo.src = `/uploads/${originalFileName}`;
                // 設定錯誤處理
                originalVideo.onerror = () => {
                    console.error('原始影片載入失敗:', originalVideo.src);
                    originalVideo.poster = originalThumbnail;
                    originalVideo.src = '';
                };
            } else {
                console.log('無檔案資訊，只顯示縮圖');
                originalVideo.poster = originalThumbnail;
                originalVideo.src = '';
            }
            
            convertedVideo.src = finalUrl;
            
            // 優化影片顯示尺寸和比例
            optimizeVideoDisplay(originalVideo, convertedVideo);
            
            const downloadSection = document.getElementById('downloadSection');
            downloadSection.style.display = 'block';
            downloadSection.innerHTML = `
                <div class="status-message success">
                    ${ICONS.check} 轉換完成
                </div>
                <a href="${finalUrl}" class="btn btn-primary" download="${finalFilename}">${ICONS.download} 下載影片</a>
            `;
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function optimizeVideoDisplay(originalVideo, convertedVideo) {
            // 等待影片元數據載入
            Promise.all([
                new Promise(resolve => {
                    if (originalVideo.videoWidth && originalVideo.videoHeight) {
                        resolve();
                    } else {
                        originalVideo.addEventListener('loadedmetadata', resolve, { once: true });
                    }
                }),
                new Promise(resolve => {
                    if (convertedVideo.videoWidth && convertedVideo.videoHeight) {
                        resolve();
                    } else {
                        convertedVideo.addEventListener('loadedmetadata', resolve, { once: true });
                    }
                })
            ]).then(() => {
                console.log('📐 開始優化影片顯示尺寸');
                updateVideoDisplaySizes(originalVideo, convertedVideo);
            }).catch(error => {
                console.error('影片元數據載入失敗:', error);
                // 使用預設尺寸
                setDefaultVideoSizes(originalVideo, convertedVideo);
            });
        }
        
        function updateVideoDisplaySizes(originalVideo, convertedVideo) {
            const originalWidth = originalVideo.videoWidth || videoInfo.width || 1920;
            const originalHeight = originalVideo.videoHeight || videoInfo.height || 1080;
            const convertedWidth = convertedVideo.videoWidth || selectedTemplate?.width || 1080;
            const convertedHeight = convertedVideo.videoHeight || selectedTemplate?.height || 1920;
            
            console.log(`📐 原始影片尺寸: ${originalWidth}×${originalHeight}`);
            console.log(`📐 轉換後影片尺寸: ${convertedWidth}×${convertedHeight}`);
            
            // 計算比例
            const originalAspect = originalWidth / originalHeight;
            const convertedAspect = convertedWidth / convertedHeight;
            
            // 設定最佳顯示尺寸 - 讓兩個影片的顯示大小更接近
            const maxDisplayWidth = 400;  // 最大顯示寬度
            const maxDisplayHeight = 300; // 最大顯示高度
            
            // 原始影片顯示尺寸計算
            let originalDisplayWidth, originalDisplayHeight;
            if (originalAspect > maxDisplayWidth / maxDisplayHeight) {
                // 寬比例影片
                originalDisplayWidth = Math.min(maxDisplayWidth, originalWidth * 0.4);
                originalDisplayHeight = originalDisplayWidth / originalAspect;
            } else {
                // 高比例影片
                originalDisplayHeight = Math.min(maxDisplayHeight, originalHeight * 0.4);
                originalDisplayWidth = originalDisplayHeight * originalAspect;
            }
            
            // 轉換後影片顯示尺寸計算
            let convertedDisplayWidth, convertedDisplayHeight;
            if (convertedAspect > maxDisplayWidth / maxDisplayHeight) {
                // 寬比例影片
                convertedDisplayWidth = Math.min(maxDisplayWidth, convertedWidth * 0.4);
                convertedDisplayHeight = convertedDisplayWidth / convertedAspect;
            } else {
                // 高比例影片  
                convertedDisplayHeight = Math.min(maxDisplayHeight, convertedHeight * 0.4);
                convertedDisplayWidth = convertedDisplayHeight * convertedAspect;
            }
            
            // 調整兩個影片的尺寸，使其更接近
            const originalArea = originalDisplayWidth * originalDisplayHeight;
            const convertedArea = convertedDisplayWidth * convertedDisplayHeight;
            const areaRatio = Math.sqrt(originalArea / convertedArea);
            
            // 如果面積差異太大，調整較小的那個
            if (areaRatio > 1.5) {
                // 原始影片面積較大，縮小轉換後影片
                const scaleFactor = Math.min(1.5, areaRatio);
                convertedDisplayWidth *= scaleFactor;
                convertedDisplayHeight *= scaleFactor;
            } else if (areaRatio < 0.67) {
                // 轉換後影片面積較大，縮小原始影片
                const scaleFactor = Math.max(0.67, areaRatio);
                originalDisplayWidth /= scaleFactor;
                originalDisplayHeight /= scaleFactor;
            }
            
            console.log(`📱 優化後顯示尺寸 - 原始: ${Math.round(originalDisplayWidth)}×${Math.round(originalDisplayHeight)}, 轉換後: ${Math.round(convertedDisplayWidth)}×${Math.round(convertedDisplayHeight)}`);
            
            // 應用新的尺寸
            originalVideo.style.width = `${Math.round(originalDisplayWidth)}px`;
            originalVideo.style.height = `${Math.round(originalDisplayHeight)}px`;
            originalVideo.style.maxWidth = '100%';
            originalVideo.style.objectFit = 'contain';
            
            convertedVideo.style.width = `${Math.round(convertedDisplayWidth)}px`;
            convertedVideo.style.height = `${Math.round(convertedDisplayHeight)}px`;
            convertedVideo.style.maxWidth = '100%';
            convertedVideo.style.objectFit = 'contain';
            
            // 更新標題顯示比例信息
            updateVideoTitles(originalWidth, originalHeight, convertedWidth, convertedHeight, originalAspect, convertedAspect);
        }
        
        function setDefaultVideoSizes(originalVideo, convertedVideo) {
            console.log('📐 使用預設影片顯示尺寸');
            // 設定合理的預設尺寸
            originalVideo.style.width = '320px';
            originalVideo.style.height = '240px';
            originalVideo.style.maxWidth = '100%';
            originalVideo.style.objectFit = 'contain';
            
            convertedVideo.style.width = '240px';
            convertedVideo.style.height = '320px';  
            convertedVideo.style.maxWidth = '100%';
            convertedVideo.style.objectFit = 'contain';
            
            // 使用已知信息更新標題
            const originalWidth = videoInfo.width || 1920;
            const originalHeight = videoInfo.height || 1080;
            const convertedWidth = selectedTemplate?.width || 1080;
            const convertedHeight = selectedTemplate?.height || 1920;
            const originalAspect = originalWidth / originalHeight;
            const convertedAspect = convertedWidth / convertedHeight;
            
            updateVideoTitles(originalWidth, originalHeight, convertedWidth, convertedHeight, originalAspect, convertedAspect);
        }
        
        function updateVideoTitles(originalWidth, originalHeight, convertedWidth, convertedHeight, originalAspect, convertedAspect) {
            // 更新標題以顯示更多信息
            const originalContainer = document.querySelector('#resultSection .content-section > div:nth-child(2) > div:first-child');
            const convertedContainer = document.querySelector('#resultSection .content-section > div:nth-child(2) > div:last-child');
            
            if (originalContainer) {
                const aspectRatioText = formatAspectRatio(originalAspect);
                originalContainer.querySelector('h4').innerHTML = `
                    原始影片 
                    <span style="font-size: 12px; color: var(--gray-500); font-weight: normal;">
                        (${originalWidth}×${originalHeight} • ${aspectRatioText})
                    </span>
                `;
            }
            
            if (convertedContainer) {
                const aspectRatioText = formatAspectRatio(convertedAspect);
                const templateName = selectedTemplate?.name || '轉換尺寸';
                convertedContainer.querySelector('h4').innerHTML = `
                    轉換後影片
                    <span style="font-size: 12px; color: var(--gray-500); font-weight: normal;">
                        (${convertedWidth}×${convertedHeight} • ${aspectRatioText})
                    </span>
                    <br>
                    <span style="font-size: 11px; color: var(--primary); font-weight: normal;">
                        📱 ${templateName}
                    </span>
                `;
            }
            
            // 添加比例對比信息
            addAspectRatioComparison(originalAspect, convertedAspect);
        }
        
        function formatAspectRatio(aspectRatio) {
            // 識別常見的比例
            const commonRatios = [
                { ratio: 16/9, text: '16:9' },
                { ratio: 9/16, text: '9:16' },
                { ratio: 4/3, text: '4:3' },
                { ratio: 3/4, text: '3:4' },
                { ratio: 1, text: '1:1' },
                { ratio: 21/9, text: '21:9' },
                { ratio: 9/21, text: '9:21' }
            ];
            
            for (const common of commonRatios) {
                if (Math.abs(aspectRatio - common.ratio) < 0.05) {
                    return common.text;
                }
            }
            
            // 計算最接近的整數比例
            const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
            const denominator = 100;
            const numerator = Math.round(aspectRatio * denominator);
            const divisor = gcd(numerator, denominator);
            
            return `${numerator/divisor}:${denominator/divisor}`;
        }
        
        function addAspectRatioComparison(originalAspect, convertedAspect) {
            // 在轉換結果區域添加比例對比信息
            const resultSection = document.getElementById('resultSection');
            const existingComparison = resultSection.querySelector('.aspect-ratio-comparison');
            if (existingComparison) {
                existingComparison.remove();
            }
            
            const comparisonDiv = document.createElement('div');
            comparisonDiv.className = 'aspect-ratio-comparison';
            comparisonDiv.style.cssText = `
                background: #f8fafc;
                border: 1px solid var(--gray-200);
                border-radius: 8px;
                padding: 16px;
                margin: 16px 0;
                text-align: center;
                font-size: 13px;
            `;
            
            const ratioChange = convertedAspect / originalAspect;
            let changeDescription = '';
            let changeIcon = '';
            
            if (ratioChange > 1.2) {
                changeDescription = '轉換為更寬的比例';
                changeIcon = '↔️';
            } else if (ratioChange < 0.8) {
                changeDescription = '轉換為更高的比例';
                changeIcon = '↕️';
            } else {
                changeDescription = '比例變化較小';
                changeIcon = '🔄';
            }
            
                         comparisonDiv.innerHTML = `
                 <div style="color: var(--gray-600); margin-bottom: 12px;">
                     <strong>📐 比例轉換效果</strong>
                 </div>
                 <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px;">
                     <span style="color: var(--gray-700);">${formatAspectRatio(originalAspect)}</span>
                     <span style="font-size: 16px;">${changeIcon}</span>
                     <span style="color: var(--primary); font-weight: 600;">${formatAspectRatio(convertedAspect)}</span>
                 </div>
                 <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;">
                     <div style="display: flex; flex-direction: column; align-items: center;">
                         <div style="font-size: 10px; color: var(--gray-500); margin-bottom: 2px;">原始</div>
                         <div style="
                             width: ${Math.min(60, Math.max(20, originalAspect * 30))}px;
                             height: ${Math.min(60, Math.max(20, 30 / originalAspect))}px;
                             background: var(--gray-400);
                             border: 1px solid var(--gray-300);
                             border-radius: 2px;
                         "></div>
                     </div>
                     <div style="color: var(--gray-400); font-size: 12px;">vs</div>
                     <div style="display: flex; flex-direction: column; align-items: center;">
                         <div style="font-size: 10px; color: var(--gray-500); margin-bottom: 2px;">轉換後</div>
                         <div style="
                             width: ${Math.min(60, Math.max(20, convertedAspect * 30))}px;
                             height: ${Math.min(60, Math.max(20, 30 / convertedAspect))}px;
                             background: var(--primary);
                             border: 1px solid var(--primary-dark);
                             border-radius: 2px;
                         "></div>
                     </div>
                 </div>
                 <div style="color: var(--gray-500); font-size: 12px;">
                     ${changeDescription} • 比例變化: ${(ratioChange * 100).toFixed(0)}%
                 </div>
             `;
            
            // 插入到影片顯示區域後面
            const videoGrid = resultSection.querySelector('.content-section > div:nth-child(2)');
            videoGrid.insertAdjacentElement('afterend', comparisonDiv);
        }

        function resetUIForNewVideo() {
            console.log('重置 UI 為新影片狀態');
            
            // 隱藏所有主要區域
            document.getElementById('videoPreviewContainer').style.display = 'none';
            document.getElementById('tabsSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            
            // 清理比例對比信息
            const existingComparison = document.querySelector('.aspect-ratio-comparison');
            if (existingComparison) {
                existingComparison.remove();
            }
            
            // 重置分析結果區域
            document.getElementById('aiSuggestions').innerHTML = '<div class="spinner"></div><p style="text-align: center; color: var(--gray-500); margin-top: 12px;">AI 分析中...</p>';
            document.getElementById('subjectChoices').innerHTML = '';
            
            // 重置影片縮圖
            const videoThumbnail = document.getElementById('videoThumbnail');
            videoThumbnail.removeAttribute('src');
            videoThumbnail.style.display = 'none';
            
            // 重置手動轉換區域
            document.getElementById('templatesGridManual').innerHTML = '';
            const centerRadio = document.querySelector('input[name="cropModeManual"][value="center"]');
            if (centerRadio) centerRadio.checked = true;
            
            // 隱藏分析狀態區域
            document.getElementById('analysisStatusSection').style.display = 'none';
            
            // 重置自定義分析狀態（清空可能的自定義分析輸入框）
            const existingCustomPromptInputs = document.querySelectorAll('#customPrompt');
            existingCustomPromptInputs.forEach(input => {
                if (input) input.value = '';
            });
            
            // 停止並隱藏原始影片動態預覽
            if (originalPreviewInterval) {
                clearInterval(originalPreviewInterval);
                originalPreviewInterval = null;
            }
            document.getElementById('originalPreviewBtn').style.display = 'none';
            document.getElementById('originalPreviewBtn').textContent = '🎬 動態預覽';
            document.getElementById('originalPreviewBtn').disabled = false;
            
            // 清理影片資訊顯示
            clearVideoInfo();
            
            // 清理預覽追蹤
            activePreviewSections.clear();
            
            // 重置檔案輸入
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
            
            // 重置所有變數
            selectedFile = null;
            fileId = null;
            videoInfo = {};
            allSubjects = [];
            selectedTemplate = null;
            selectedLLMSubjects = [];
            originalThumbnail = '';
            originalFilename = '';
            currentCustomPrompt = '';
            conversationHistory = []; // 新增：重置對話歷史
        }

        function displayVideoInfo(filename, vInfo, fileSize) {
            // 更新檔案名稱
            const fileNameElement = document.getElementById('videoFileName');
            fileNameElement.textContent = filename || '-';
            fileNameElement.title = filename || ''; // 設置 title 屬性用於懸停顯示完整名稱
            
            // 更新影片格式（從檔案名稱提取）
            const fileExtension = filename ? filename.split('.').pop().toUpperCase() : '-';
            document.getElementById('videoFormat').textContent = fileExtension;
            
            // 更新解析度
            if (vInfo && vInfo.width && vInfo.height) {
                document.getElementById('videoResolution').textContent = `${vInfo.width} × ${vInfo.height}`;
            } else {
                document.getElementById('videoResolution').textContent = '-';
            }
            
            // 更新影片時長
            if (vInfo && vInfo.duration) {
                const duration = parseFloat(vInfo.duration);
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                document.getElementById('videoDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                document.getElementById('videoDuration').textContent = '-';
            }
            
            // 更新幀率
            if (vInfo && vInfo.fps) {
                document.getElementById('videoFPS').textContent = `${Math.round(vInfo.fps)} fps`;
            } else {
                document.getElementById('videoFPS').textContent = '-';
            }
            
            // 更新檔案大小
            if (fileSize) {
                const sizeMB = (fileSize / (1024 * 1024)).toFixed(1);
                document.getElementById('videoFileSize').textContent = `${sizeMB} MB`;
            } else {
                document.getElementById('videoFileSize').textContent = '-';
            }
        }

        function clearVideoInfo() {
            const infoElements = ['videoFileName', 'videoFormat', 'videoResolution', 'videoDuration', 'videoFPS', 'videoFileSize'];
            infoElements.forEach(id => {
                document.getElementById(id).textContent = '-';
            });
        }

        async function generateOriginalPreview() {
            const previewBtn = document.getElementById('originalPreviewBtn');
            const videoThumbnail = document.getElementById('videoThumbnail');
            
            // 如果已經在播放動態預覽，則停止
            if (previewBtn.textContent.includes('停止')) {
                stopOriginalPreview();
                return;
            }
            
            previewBtn.textContent = '⏳ 載入中...';
            previewBtn.disabled = true;
            
            try {
                const response = await fetch('/api/generate_original_preview', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        file_id: fileId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('原始影片預覽生成失敗');
                }
                
                const result = await response.json();
                console.log('🎬 原始影片預覽 API 返回結果:', result);
                
                if (result.preview_frames && result.preview_frames.length > 1) {
                    console.log(`✅ 設置原始影片多幀動畫，共 ${result.preview_frames.length} 幀`);
                    setupOriginalFrameAnimation(videoThumbnail, result.preview_frames, previewBtn);
                } else if (result.preview_frames && result.preview_frames.length === 1) {
                    console.log('📷 原始影片只有單幀');
                    videoThumbnail.src = result.preview_frames[0];
                    previewBtn.textContent = '🎬 動態預覽';
                    previewBtn.disabled = false;
                    showStatus('影片太短，無法生成動態預覽', 'info');
                } else {
                    throw new Error('沒有收到預覽幀數據');
                }
                
            } catch (error) {
                console.error('原始影片預覽生成失敗:', error);
                showStatus(`動態預覽失敗: ${error.message}`, 'error');
                previewBtn.textContent = '🎬 動態預覽';
                previewBtn.disabled = false;
            }
        }

        let originalPreviewInterval = null;
        let originalPreviewFrames = null;

        function setupOriginalFrameAnimation(imageElement, frames, controlBtn) {
            console.log('🎬 開始設置原始影片幀動畫，幀數:', frames.length);
            
            originalPreviewFrames = frames;
            let currentFrame = 0;
            
            // 設置初始幀
            imageElement.src = frames[0];
            console.log('📷 設置原始影片初始幀');
            
            controlBtn.textContent = '⏸️ 停止預覽';
            controlBtn.disabled = false;
            
            // 開始動畫
            originalPreviewInterval = setInterval(() => {
                currentFrame = (currentFrame + 1) % frames.length;
                console.log(`📷 原始影片切換到第 ${currentFrame + 1} 幀`);
                imageElement.src = frames[currentFrame];
            }, 800); // 每800ms切換一幀，稍慢一些以便觀看
            
            showStatus(`🎬 原始影片動態預覽已啟動 (${frames.length} 幀)`, 'success');
        }

        function stopOriginalPreview() {
            const previewBtn = document.getElementById('originalPreviewBtn');
            const videoThumbnail = document.getElementById('videoThumbnail');
            
            if (originalPreviewInterval) {
                clearInterval(originalPreviewInterval);
                originalPreviewInterval = null;
            }
            
            // 恢復原始縮圖
            if (originalThumbnail) {
                videoThumbnail.src = originalThumbnail;
            }
            
            previewBtn.textContent = '🎬 動態預覽';
            previewBtn.disabled = false;
            
            console.log('⏹️ 原始影片動態預覽已停止');
            showStatus('動態預覽已停止', 'info');
        }

        async function loadHistoryPage() {
            const container = document.getElementById('history-content');
            container.innerHTML = '<div class="spinner"></div>';
            try {
                const response = await fetch('/api/uploaded_videos');
                const videos = await response.json();
                container.innerHTML = '';
                if (videos.length === 0) {
                    container.innerHTML = '<p>暫無歷史紀錄</p>';
                    return;
                }
                videos.forEach(video => {
                    const card = document.createElement('div');
                    card.style.cssText = 'border: 1px solid var(--gray-200); border-radius: var(--border-radius); padding: 16px; margin-bottom: 12px; display: flex; gap: 16px;';
                    let convertedListHTML = '<div><h4 style="margin-bottom: 8px; font-size: 14px;">轉換結果:</h4><ul style="margin: 0; padding-left: 16px;">';
                    if (video.converted_videos && video.converted_videos.length > 0) {
                        video.converted_videos.forEach(converted => {
                            const downloadUrl = `/outputs/${converted.filename}`;
                            convertedListHTML += `
                                <li style="margin-bottom: 4px; font-size: 12px;">
                                    <a href="${downloadUrl}" download style="color: var(--primary); text-decoration: none;">${converted.filename}</a>
                                    <span style="color: var(--gray-500); margin-left: 8px;">(${new Date(converted.timestamp).toLocaleDateString()})</span>
                                </li>
                            `;
                        });
                    } else {
                        convertedListHTML += '<li style="color: var(--gray-500); font-size: 12px;">尚無轉換結果</li>';
                    }
                    convertedListHTML += '</ul></div>';
                    card.innerHTML = `
                        <img src="${video.thumbnail}" style="width: 100px; height: 60px; object-fit: cover; border-radius: var(--border-radius); border: 1px solid var(--gray-200);">
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 8px; font-size: 14px; color: var(--gray-900);">${video.filename}</h3>
                            ${convertedListHTML}
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error("Failed to load history page:", error);
                container.innerHTML = '<p style="color:red;">載入失敗</p>';
            }
        }

        function showProgress(show) {
            document.getElementById('progressBar').style.display = show ? 'block' : 'none';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            if (text) showStatus(text, 'info');
        }

        function getOriginalFileName(fId) {
            // 默認使用 .mp4 擴展名（最常見的格式）
            // 後端統一使用這個命名格式：{file_id}_original.{ext}
            return `${fId}_original.mp4`;
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            setTimeout(() => { statusEl.style.display = 'none';}, type === 'info' ? 6000 : 3000);
        }
    </script>
</body>
</html> 