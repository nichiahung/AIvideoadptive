<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdaptVideo - å½±ç‰‡å°ºå¯¸è½‰æ›å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* === å°ˆæ¥­å·¥å…·è»Ÿé«”è¨­è¨ˆç³»çµ± === */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: #dbeafe;
            --primary-dark: #1e40af;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --success: #059669;
            --warning: #d97706;
            --error: #dc2626;
            --sidebar-width: 240px;
            --border-radius: 6px;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.5;
            font-size: 14px;
        }

        .app-container { display: flex; min-height: 100vh; }

        /* === å´é‚Šæ¬„ === */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: 20px 0;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 20px;
        }

        .sidebar-header h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .nav-menu { list-style: none; }

        .nav-item a {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            color: var(--gray-600);
            text-decoration: none;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .nav-item a:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .nav-item.active a {
            background: var(--primary-light);
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .nav-item .icon { margin-right: 8px; }

        /* === ä¸»å…§å®¹ === */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .container { max-width: 900px; margin: 0 auto; }
        .page { display: none; }
        .page.active { display: block; }

        /* === å…§å®¹å€å¡Š === */
        .content-section {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* === å½±ç‰‡ä¾†æºé¸æ“‡ === */
        .video-source-selection {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .source-option {
            position: relative;
        }

        /* === ä¸Šå‚³å€åŸŸ === */
        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--gray-50);
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .upload-icon { font-size: 32px; color: var(--gray-400); margin-bottom: 12px; }
        .upload-text { font-size: 16px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px; }
        .upload-hint { font-size: 13px; color: var(--gray-500); }

        .upload-divider {
            margin: 20px 0;
            text-align: center;
            position: relative;
        }

        .upload-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gray-200);
        }

        .upload-divider span {
            background: white;
            padding: 0 12px;
            color: var(--gray-500);
            font-size: 12px;
            position: relative;
        }

        .file-input { display: none; }

        /* === æŒ‰éˆ• === */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* === Tab === */
        .tab-navigation {
            display: flex;
            background: var(--gray-100);
            border-radius: var(--border-radius);
            padding: 4px;
            margin-bottom: 20px;
        }

        .tab-nav-item {
            flex: 1;
            padding: 8px 16px;
            text-align: center;
            cursor: pointer;
            border-radius: calc(var(--border-radius) - 4px);
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.15s ease;
        }

        .tab-nav-item.active {
            background: white;
            color: var(--gray-900);
            box-shadow: var(--shadow);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* === å½±ç‰‡é è¦½ === */
        .video-preview {
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 16px;
            align-items: start;
            margin-top: 16px;
        }

        .video-thumbnail {
            width: 100%;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
        }
        
        .subject-choices { display: flex; flex-direction: column; gap: 8px; }

        .subject-choice {
            display: flex;
            align-items: center;
            padding: 8px;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .subject-choice:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .subject-choice input[type="radio"], 
        .subject-choice input[type="checkbox"] { margin-right: 8px; }
        .subject-choice img {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            margin-right: 8px;
            object-fit: cover;
        }

        /* === å·¥å…·æ¨£å¼ === */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .template-card {
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .template-card:hover, .template-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .template-name { font-weight: 600; color: var(--gray-900); margin-bottom: 4px; }
        .template-size { font-size: 12px; color: var(--gray-600); margin-bottom: 6px; }
        .template-desc { font-size: 11px; color: var(--gray-500); }

        .crop-options { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }

        .crop-option {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .crop-option:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .crop-option input[type="radio"] { margin-right: 8px; margin-top: 2px; }
        .option-content strong { display: block; font-weight: 600; color: var(--gray-900); margin-bottom: 2px; }
        .option-content p { font-size: 12px; color: var(--gray-600); margin: 0; }

        /* === é€²åº¦èˆ‡ç‹€æ…‹ === */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .status-message {
            padding: 10px 12px;
            border-radius: var(--border-radius);
            margin: 12px 0;
            font-size: 13px;
            font-weight: 500;
        }

        .status-message.success {
            background: #dcfce7;
            color: var(--success);
            border: 1px solid #bbf7d0;
        }

        .status-message.error {
            background: #fef2f2;
            color: var(--error);
            border: 1px solid #fecaca;
        }

        .status-message.info {
            background: var(--primary-light);
            color: var(--primary);
            border: 1px solid #93c5fd;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-200);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 16px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            0% { 
                opacity: 0;
                transform: translateY(-10px);
            }
            100% { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            0% { 
                opacity: 1;
                transform: translateY(0);
            }
            100% { 
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* === Modal === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: var(--border-radius);
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-header h2 { font-size: 16px; font-weight: 600; color: var(--gray-900); }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-400);
            padding: 4px;
            border-radius: 4px;
        }

        .close-btn:hover { background: var(--gray-100); color: var(--gray-600); }

        #videoHistoryGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .history-thumb-card {
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .history-thumb-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .history-thumb-card img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .history-thumb-card p {
            padding: 8px;
            font-size: 11px;
            color: var(--gray-600);
            background: var(--gray-50);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* === æ•´åˆçš„ä¸»é«”é¸æ“‡æ¨£å¼ === */
        .integrated-subject-choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .multi-select-info {
            background: var(--primary-light);
            border: 1px solid #93c5fd;
            border-radius: 6px;
            padding: 12px;
            font-size: 13px;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .subjects-selection-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.1);
        }

        .recommended-templates-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .ai-analysis-overview {
            position: relative;
            overflow: hidden;
        }

        .ai-analysis-overview::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 20%, transparent 70%);
            pointer-events: none;
        }

        /* === Markdown å…§å®¹æ¨£å¼ === */
        .markdown-content {
            font-size: 14px;
            color: var(--gray-700);
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .markdown-content p {
            margin-bottom: 8px;
        }
        .markdown-content ul {
            margin-left: 20px;
            margin-bottom: 12px;
            list-style-type: disc;
        }
        .markdown-content li {
            margin-bottom: 4px;
        }
        .markdown-content strong {
            font-weight: 600;
            color: var(--gray-900);
        }

        /* === éŸ¿æ‡‰å¼ === */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; order: 2; border-right: none; border-top: 1px solid var(--gray-200); }
            .main-content { order: 1; padding: 12px; }
            .video-preview { grid-template-columns: 1fr; gap: 12px; }
            
            /* å°è¢å¹•æ™‚å½±ç‰‡è³‡è¨Šä½¿ç”¨å–®åˆ—ä½ˆå±€ */
            .video-info-grid { grid-template-columns: 1fr !important; }
            
            /* å°è¢å¹•æ™‚å½±ç‰‡ä¾†æºé¸æ“‡ä¿æŒå‚ç›´ä½ˆå±€ */
            .video-source-selection { gap: 12px; }
        }

        .recommendation-warning {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-800);
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            background-color: #fffbeb;
            border-left: 4px solid var(--warning);
        }
        .recommendation-warning .icon-svg {
            color: var(--warning);
        }

        .recommendation-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-800);
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            background-color: #f0f9ff;
            border-left: 4px solid var(--primary);
        }
        .recommendation-info .icon-svg {
            color: var(--primary);
        }

        .recommendation-success {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #15803d;
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            background-color: #f0f9ff;
            border-left: 4px solid #22c55e;
        }

        .recommendation-warning {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #d97706;
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .recommendation-text .markdown-content {
            font-size: 14px;
            color: var(--gray-700);
        }

        .icon-svg {
            width: 1.1em;
            height: 1.1em;
            vertical-align: -0.2em;
            flex-shrink: 0;
        }

        /* === å½±ç‰‡è³‡è¨Šæ¨£å¼å„ªåŒ– === */
        .video-info-section {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 16px;
        }

        .video-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px 16px;
            font-size: 14px; /* å¾ 11px å¢åŠ åˆ° 14px */
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            color: var(--gray-600);
            font-size: 12px; /* å¾ 10px å¢åŠ åˆ° 12px */
            font-weight: 500;
        }

        .info-value {
            color: var(--gray-900);
            font-weight: 600;
            font-size: 15px; /* å¾ 11px å¢åŠ åˆ° 15px */
            line-height: 1.3;
        }

        /* æª”æ¡ˆåç¨±ç‰¹æ®Šè™•ç† */
        .info-item.filename {
            grid-column: 1 / -1;
        }

        .info-item.filename .info-value {
            font-size: 13px; /* æª”æ¡ˆåç¨±ç¨å°ä¸€é» */
            max-height: 32px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2; /* æ¨™æº–å±¬æ€§ï¼Œæä¾›æ›´å¥½çš„å…¼å®¹æ€§ */
        }

        /* === AI è­˜åˆ¥è³‡è¨Šå„ªåŒ– === */
        .ai-analysis-section {
            background: var(--primary-light);
            border: 1px solid var(--primary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
        }

        .ai-analysis-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            font-size: 16px; /* å¢å¤§æ¨™é¡Œå­—é«” */
            font-weight: 600;
            color: var(--primary);
        }

        .ai-analysis-content {
            font-size: 15px; /* å¢å¤§å…§å®¹å­—é«” */
            line-height: 1.6;
            color: var(--gray-800);
        }

        /* === ä¸»é«”é¸æ“‡å€åŸŸå„ªåŒ– === */
        .subject-choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .subject-choice {
            display: flex;
            align-items: center;
            padding: 12px; /* å¢åŠ å…§é‚Šè· */
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .subject-choice:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .subject-choice input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2); /* å¢å¤§è¤‡é¸æ¡† */
        }

        .subject-choice img {
            width: 40px; /* å¾ 32px å¢åŠ åˆ° 40px */
            height: 40px;
            border-radius: 6px;
            margin-right: 12px;
            object-fit: cover;
        }

        .subject-choice span {
            font-size: 14px; /* å¾ 12px å¢åŠ åˆ° 14px */
            font-weight: 500;
            line-height: 1.4;
        }

        .subject-choice small {
            font-size: 12px; /* å¾ 10px å¢åŠ åˆ° 12px */
            color: var(--gray-500);
        }

        /* === å¤šé¸èªªæ˜å„ªåŒ– === */
        .multi-select-info {
            background: var(--primary-light);
            border: 1px solid var(--primary);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 13px; /* å¾ 11px å¢åŠ åˆ° 13px */
            color: var(--primary-dark);
            font-weight: 500;
        }

        /* === æ¨è–¦æ¨¡æ¿å€åŸŸå„ªåŒ– === */
        .templates-title {
            display: flex;
            align-items: center;
            margin: 24px 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 16px; /* å¢å¤§æ¨™é¡Œå­—é«” */
            font-weight: 600;
            color: var(--gray-800);
        }

        .template-card {
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 16px; /* å¢åŠ å…§é‚Šè· */
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 16px;
        }

        .template-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 6px;
            font-size: 15px; /* å¢å¤§å­—é«” */
        }

        .template-size {
            font-size: 13px; /* å¾ 12px å¢åŠ åˆ° 13px */
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        /* === éŸ¿æ‡‰å¼è¨­è¨ˆå„ªåŒ– === */
        @media (max-width: 768px) {
            .video-info-grid {
                grid-template-columns: 1fr;
                font-size: 13px;
            }
            
            .info-value {
                font-size: 14px;
            }
            
            .ai-analysis-header {
                font-size: 15px;
            }
            
            .ai-analysis-content {
                font-size: 14px;
            }
            
            /* å½±ç‰‡æ¯”è¼ƒå€åŸŸéŸ¿æ‡‰å¼ */
            .video-comparison-grid {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }
            
            .aspect-ratio-comparison {
                margin: 12px 0 !important;
                padding: 12px !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>AdaptVideo</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-page="converter">
                    <a href="#"><span class="icon">ğŸ”§</span>å½±ç‰‡è½‰æ›</a>
                </li>
                <li class="nav-item" data-page="history">
                    <a href="#"><span class="icon">ğŸ“</span>æ­·å²ç´€éŒ„</a>
                </li>
                <li class="nav-item" data-page="guide">
                    <a href="#"><span class="icon">â“</span>ä½¿ç”¨èªªæ˜</a>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <div id="page-converter" class="page active">
                <div class="container">
                    <!-- å½±ç‰‡ä¾†æº -->
                    <div class="content-section">
                        <div class="section-title">
                            <span class="icon">ğŸ“‚</span>å½±ç‰‡ä¾†æº
                        </div>
                        
                        <!-- å½±ç‰‡ä¾†æºé¸æ“‡ -->
                        <div class="video-source-selection">
                            <div class="source-option" id="uploadOption">
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-icon">ğŸ“¤</div>
                                    <div class="upload-text">é»æ“Šé¸æ“‡å½±ç‰‡æª”æ¡ˆæˆ–æ‹–æ‹½åˆ°æ­¤è™•</div>
                                    <div class="upload-hint">æ”¯æ´ MP4, MOV æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°é™åˆ¶ 500MB</div>
                                </div>
                                <input type="file" id="fileInput" class="file-input" accept="video/*">
                            </div>
                            
                            <div class="upload-divider"><span>æˆ–</span></div>
                            
                            <div class="source-option" id="historyOption">
                                <button id="showHistoryBtn" class="btn btn-secondary" style="width: 100%; padding: 16px; font-size: 14px;">
                                    ğŸ“ å¾æ­·å²ç´€éŒ„é¸æ“‡å½±ç‰‡
                                </button>
                            </div>
                        </div>
                        
                        <!-- å½±ç‰‡é è¦½ -->
                        <div id="videoPreviewContainer" style="display:none;">
                            <div class="section-title" style="margin-top: 20px;">
                                <span class="icon">ğŸ‘ï¸</span>å½±ç‰‡é è¦½
                            </div>
                            <div class="video-preview">
                                <div style="position: relative; display: inline-block;">
                                    <img id="videoThumbnail" class="video-thumbnail" src="" alt="å½±ç‰‡ç¸®åœ–"/>
                                    <button id="originalPreviewBtn" class="btn btn-secondary" style="position: absolute; top: 8px; right: 8px; font-size: 11px; padding: 4px 8px; display: none;">
                                        ğŸ¬ å‹•æ…‹é è¦½
                                    </button>
                                </div>
                                
                                <!-- å³å´å€åŸŸï¼šä¸»é«”é¸æ“‡ + å½±ç‰‡è³‡è¨Š -->
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <!-- ä¸»é«”é¸æ“‡å€åŸŸ -->
                                    <div id="subjectChoices" class="subject-choices"></div>
                                    
                                    <!-- å½±ç‰‡è³‡è¨Š -->
                                    <div id="videoInfoSection" class="video-info-section">
                                        <div class="section-title" style="margin: 0 0 12px 0; font-size: 15px; font-weight: 600;">
                                            <span class="icon">ğŸ“Š</span>å½±ç‰‡è³‡è¨Š
                                        </div>
                                        <div class="video-info-grid">
                                            <div class="info-item filename">
                                                <span class="info-label">ğŸ“ æª”æ¡ˆåç¨±</span>
                                                <span id="videoFileName" class="info-value" title="">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">ğŸ¬ æ ¼å¼</span>
                                                <span id="videoFormat" class="info-value">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">ğŸ“ è§£æåº¦</span>
                                                <span id="videoResolution" class="info-value">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">â±ï¸ æ™‚é•·</span>
                                                <span id="videoDuration" class="info-value">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">ğŸï¸ å¹€ç‡</span>
                                                <span id="videoFPS" class="info-value">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">ğŸ’¾ å¤§å°</span>
                                                <span id="videoFileSize" class="info-value">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI åˆ†æç‹€æ…‹å€åŸŸ -->
                            <div id="analysisStatusSection" style="display: none; margin-top: 16px;">
                                <div id="analysisStatus" style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    padding: 12px 16px;
                                    background: #f6ffed;
                                    border: 1px solid #b7eb8f;
                                    border-radius: 6px;
                                    font-size: 14px;
                                    color: #52c41a;
                                ">
                                    <svg style="width: 16px; height: 16px; margin-right: 8px;" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.91,10.59L6.5,12L11,16.5Z"/>
                                    </svg>
                                    <span>åˆ†æå®Œæˆ</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è½‰æ›è¨­å®š -->
                    <div id="tabsSection" style="display:none;">
                        <div class="content-section">
                            <nav class="tab-navigation">
                                <div class="tab-nav-item active" data-tab="smart">æ™ºæ…§è½‰æ›</div>
                                <div class="tab-nav-item" data-tab="manual">æ‰‹å‹•è½‰æ›</div>
                            </nav>
                            
                            <!-- æ™ºæ…§è½‰æ› -->
                            <div id="tab-smart" class="tab-content active">

                                
                                <div class="section-title"><span class="icon">ğŸ¤–</span>AI æ¨è–¦çµæœ</div>
                                
                                <div id="aiSuggestions">
                                    <div class="spinner"></div>
                                    <p style="text-align: center; color: var(--gray-500); margin-top: 12px;">æ­£åœ¨åˆ†æå½±ç‰‡å…§å®¹...</p>
                                </div>
                            </div>

                            <!-- æ‰‹å‹•è½‰æ› -->
                            <div id="tab-manual" class="tab-content">
                                <div class="section-title"><span class="icon">âš™ï¸</span>é¸æ“‡è¼¸å‡ºå°ºå¯¸</div>
                                <div id="templatesGridManual" class="templates-grid"></div>
                                
                                <div class="section-title" style="margin-top: 24px;"><span class="icon">âœ‚ï¸</span>è£åˆ‡æ¨¡å¼</div>
                                <div class="crop-options">
                                    <label class="crop-option">
                                        <input type="radio" name="cropModeManual" value="center" checked>
                                        <div class="option-content">
                                            <strong>ç½®ä¸­è£åˆ‡</strong>
                                            <p>å¾å½±ç‰‡ä¸­å¿ƒé€²è¡Œè£åˆ‡</p>
                                        </div>
                                    </label>
                                    <label class="crop-option" style="display:none;">
                                        <input type="radio" name="cropModeManual" value="llm">
                                        <div class="option-content">
                                            <strong>æ™ºæ…§è£åˆ‡</strong>
                                            <p>æ ¹æ“š AI è­˜åˆ¥çš„ä¸»è¦å°è±¡é€²è¡Œè£åˆ‡</p>
                                        </div>
                                    </label>
                                </div>

                                                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" id="convertBtnManual" disabled>
                        <svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="play-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true">
                            <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path>
                            <path d="M719.4 499.1l-296.1-215A15.9 15.9 0 00398 297v430c0 13.1 14.8 20.5 25.3 12.9l296.1-215a15.9 15.9 0 000-25.8zm-257.6 134V390.9L628.5 512 461.8 633.1z"></path>
                        </svg>
                        é–‹å§‹è½‰æ›
                    </button>
                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è½‰æ›çµæœ -->
                    <div id="resultSection" style="display: none;">
                        <div class="content-section">
                            <div class="section-title">
                                <svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="check-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true">
                                    <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path>
                                    <path d="M699.1 316.2c-4.9-4.9-12.8-4.9-17.7 0L469 528.4 342.9 402.3c-4.9-4.9-12.8-4.9-17.7 0s-4.9 12.8 0 17.7l138.4 138.4c4.9 4.9 12.8 4.9 17.7 0l224.5-224.5c4.8-4.9 4.8-12.8-.1-17.7z"></path>
                                </svg>
                                è½‰æ›çµæœ
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center; justify-items: center;" class="video-comparison-grid">
                                <div style="text-align: center; max-width: 100%;">
                                    <h4 style="margin-bottom: 12px; color: var(--gray-700); font-size: 14px; line-height: 1.4;">åŸå§‹å½±ç‰‡</h4>
                                    <video id="originalVideo" controls muted playsinline style="border-radius: var(--border-radius); border: 1px solid var(--gray-200); background: #000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 100%;"></video>
                                </div>
                                <div style="text-align: center; max-width: 100%;">
                                    <h4 style="margin-bottom: 12px; color: var(--gray-700); font-size: 14px; line-height: 1.4;">è½‰æ›å¾Œå½±ç‰‡</h4>
                                    <video id="convertedVideo" controls muted playsinline style="border-radius: var(--border-radius); border: 1px solid var(--gray-200); background: #000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 100%;"></video>
                                </div>
                            </div>
                            <div id="downloadSection" style="display: none; margin-top: 20px; text-align: center;"></div>
                        </div>
                    </div>

                    <!-- é€²åº¦èˆ‡ç‹€æ…‹ -->
                    <div class="progress-bar" id="progressBar" style="display: none;">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="status-message" id="statusMessage"></div>
                </div>
            </div>

            <!-- å…¶ä»–é é¢ -->
            <div id="page-history" class="page" style="display: none;">
                <div class="container">
                    <div class="content-section">
                        <div class="section-title"><span class="icon">ğŸ“</span>æ­·å²ç´€éŒ„</div>
                        <div id="history-content"></div>
                    </div>
                </div>
            </div>

            <div id="page-guide" class="page" style="display: none;">
                <div class="container">
                    <div class="content-section">
                        <div class="section-title"><span class="icon">â“</span>ä½¿ç”¨èªªæ˜</div>
                        <div style="line-height: 1.6;">
                            <h3 style="color: var(--gray-800); margin: 16px 0 8px;">åŸºæœ¬æ“ä½œ</h3>
                            <ol style="margin-left: 20px; color: var(--gray-600);">
                                <li>é¸æ“‡å½±ç‰‡æª”æ¡ˆæˆ–å¾æ­·å²ç´€éŒ„ä¸­é¸æ“‡</li>
                                <li>ç­‰å¾… AI è‡ªå‹•åˆ†æå½±ç‰‡å…§å®¹</li>
                                <li>åœ¨ã€Œæ™ºæ…§è½‰æ›ã€ä¸­æŸ¥çœ‹ AI æ¨è–¦çš„å°ºå¯¸</li>
                                <li>æˆ–åˆ‡æ›åˆ°ã€Œæ‰‹å‹•è½‰æ›ã€è‡ªè¡Œé¸æ“‡è¨­å®š</li>
                                <li>é»æ“Šé–‹å§‹è½‰æ›ä¸¦ç­‰å¾…è™•ç†å®Œæˆ</li>
                            </ol>
                            
                            <h3 style="color: var(--gray-800); margin: 20px 0 8px;">æ”¯æ´æ ¼å¼</h3>
                            <p style="color: var(--gray-600);">MP4, MOV ç­‰å¸¸è¦‹å½±ç‰‡æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°é™åˆ¶ 500MB</p>
                            
                            <h3 style="color: var(--gray-800); margin: 20px 0 8px;">è£åˆ‡æ¨¡å¼</h3>
                            <ul style="margin-left: 20px; color: var(--gray-600);">
                                <li><strong>ç½®ä¸­è£åˆ‡ï¼š</strong>å¾å½±ç‰‡ä¸­å¿ƒä½ç½®é€²è¡Œè£åˆ‡</li>
                                <li><strong>æ™ºæ…§è£åˆ‡ï¼š</strong>AI è‡ªå‹•è­˜åˆ¥ä¸»è¦å°è±¡ä¸¦ä»¥å…¶ç‚ºä¸­å¿ƒè£åˆ‡</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- æ­·å²ç´€éŒ„ Modal -->
    <div id="videoHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>é¸æ“‡å½±ç‰‡</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div id="videoHistoryGrid"></div>
        </div>
    </div>

    <script>
        const ICONS = {
            check: `<svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="check-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M699.1 316.2c-4.9-4.9-12.8-4.9-17.7 0L469 528.4 342.9 402.3c-4.9-4.9-12.8-4.9-17.7 0s-4.9 12.8 0 17.7l138.4 138.4c4.9 4.9 12.8 4.9 17.7 0l224.5-224.5c4.8-4.9 4.8-12.8-.1-17.7z"></path></svg>`,
            warning: `<svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="exclamation-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M496 632h32c4.4 0 8-3.6 8-8V448c0-4.4-3.6-8-8-8h-32c-4.4 0-8 3.6-8 8v176c0 4.4 3.6 8 8 8zm0-240h32c4.4 0 8-3.6 8-8v-32c0-4.4-3.6-8-8-8h-32c-4.4 0-8 3.6-8 8v32c0 4.4 3.6 8 8 8z"></path></svg>`,
            download: `<svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="download" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M505.7 661a8 8 0 0012.6 0l112-141.7c4.1-5.2.4-12.9-6.3-12.9h-74.1V168c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v338.3H400c-6.7 0-10.4 7.7-6.3 12.9l112 141.8zM878 626h-138c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h138c35.3 0 64-28.7 64-64V465c0-35.3-28.7-64-64-64h-138c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h138v154zM146 626h138c4.4 0 8 3.6 8 8v60c0 4.4-3.6 8-8 8H146c-35.3 0-64-28.7-64-64V465c0-35.3 28.7-64 64-64h138c4.4 0 8 3.6 8 8v60c0 4.4-3.6-8-8 8H146v154z"></path></svg>`,
            adjust: `<svg class="icon-svg" viewBox="64 64 896 896" focusable="false" data-icon="setting" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M924.8 625.7l-65.5-56c3.1-19 4.7-38.4 4.7-57.8s-1.6-38.8-4.7-57.8l65.5-56a32.03 32.03 0 009.3-35.2l-.9-2.6a443.74 443.74 0 00-79.7-137.9l-1.8-2.1a32.12 32.12 0 00-35.1-9.5l-81.3 28.9c-30-24.6-63.5-44-99.7-57.6l-15.7-85a32.05 32.05 0 00-25.8-25.7l-2.7-.5c-52.1-9.4-106.9-9.4-159 0l-2.7.5a32.05 32.05 0 00-25.8 25.7l-15.8 85.4a351.86 351.86 0 00-99 57.4l-81.9-29.1a32 32 0 00-35.1 9.5l-1.8 2.1a446.02 446.02 0 00-79.7 137.9l-.9 2.6c-4.5 12.5-.8 26.5 9.3 35.2l66.3 56.6c-3.1 18.8-4.6 38-4.6 57.1 0 19.2 1.5 38.4 4.6 57.1L99 625.5a32.03 32.03 0 00-9.3 35.2l.9 2.6c18.1 50.4 44.9 96.9 79.7 137.9l1.8 2.1a32.12 32.12 0 0035.1 9.5l81.9-29.1c29.8 24.5 63.1 43.9 99 57.4l15.8 85.4a32.05 32.05 0 0025.8 25.7l2.7.5a449.4 449.4 0 00159 0l2.7-.5a32.05 32.05 0 0025.8-25.7l15.7-85a350 350 0 0099.7-57.6l81.3 28.9a32 32 0 0035.1-9.5l1.8-2.1c34.8-41.1 61.6-87.5 79.7-137.9l.9-2.6c4.5-12.3.8-26.3-9.3-35.2zM788.3 465.9c2.5 15.1 3.8 30.6 3.8 46.1s-1.3 31-3.8 46.1l-6.6 40.1 74.7 63.9a370.03 370.03 0 01-42.6 73.6L721 702.8l-31.4 25.8c-23.9 19.6-50.5 35-79.3 45.8l-38.1 14.3-17.9 97a377.5 377.5 0 01-85 0l-17.9-97.2-37.8-14.5c-28.5-10.8-55-26.2-78.7-45.7l-31.4-25.9-93.4 33.2c-17-22.9-31.2-47.6-42.6-73.6l75.5-64.5-6.5-40c-2.4-14.9-3.7-30.3-3.7-45.5 0-15.3 1.2-30.6 3.7-45.5l6.5-40-75.5-64.5c11.3-26.1 25.6-50.7 42.6-73.6l93.4 33.2 31.4-25.9c23.7-19.5 50.2-34.9 78.7-45.7l37.9-14.3 17.9-97.2c28.1-3.2 56.8-3.2 85 0l17.9 97 38.1 14.3c28.7 10.8 55.4 26.2 79.3 45.8l31.4 25.8 92.8-32.9c17 22.9 31.2 47.6 42.6 73.6L781.8 426l6.5 39.9zM512 326c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176-78.8-176-176-176zm79.2 255.2A111.6 111.6 0 01512 614c-29.9 0-58-11.7-79.2-32.8A111.6 111.6 0 01400 502c0-29.9 11.7-58 32.8-79.2C454 401.6 482.1 390 512 390c29.9 0 58 11.6 79.2 32.8A111.6 111.6 0 01624 502c0 29.9-11.7 58-32.8 79.2z"></path></svg>`
        };

        // ä¿æŒåŸæœ‰çš„ JavaScript é‚è¼¯
        let selectedFile = null, selectedTemplate = null, fileId = null, selectedLLMSubjects = []; // æ”¹ç‚ºé™£åˆ—æ”¯æ´å¤šé¸
        let originalThumbnail = '';
        let videoInfo = {};
        let allTemplates = [];
        let allSubjects = [];
        let originalFilename = '';
        let currentCustomPrompt = '';
        let conversationHistory = []; // æ–°å¢ï¼šç”¨æ–¼å­˜å„²å°è©±æ­·å²
        // æ³¨æ„ï¼šactivePreviewSections å·²åœ¨å…¶ä»–å€å¡Šå®£å‘Šï¼Œé¿å…é‡è¤‡å®£å‘Š

        document.addEventListener('DOMContentLoaded', () => {
            // å°èˆª
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    const page = document.getElementById(`page-${item.dataset.page}`);
                    page.classList.add('active');
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                    if (item.dataset.page === 'history') loadHistoryPage();
                });
            });

            // Tab
            document.querySelectorAll('.tab-nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const tabId = `tab-${item.dataset.tab}`;
                    document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    document.querySelectorAll('.tab-nav-item').forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                    if(item.dataset.tab === 'manual' && fileId) setupManualTab();
                });
            });

            // Modal
            const modal = document.getElementById('videoHistoryModal');
            const showHistoryBtn = document.getElementById('showHistoryBtn');
            const closeBtn = document.querySelector('.close-btn');

            // æ­·å²è¨˜éŒ„æŒ‰éˆ•è™•ç†
            showHistoryBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                resetUIForNewVideo();
                modal.style.display = 'block';
                loadVideoHistory();
            });
            closeBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target == modal) modal.style.display = 'none';
            }

            // æª”æ¡ˆä¸Šå‚³è™•ç†
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // é»æ“Šä¸Šå‚³å€åŸŸé¸æ“‡æª”æ¡ˆ
            uploadArea.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });
            
            // æª”æ¡ˆé¸æ“‡è®Šæ›´è™•ç†
            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // æ‹–æ‹½ä¸Šå‚³è™•ç†
            ['dragover', 'dragleave', 'drop'].forEach(evt => {
                uploadArea.addEventListener(evt, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (evt === 'dragover') {
                        uploadArea.classList.add('dragover');
                    } else if (evt === 'dragleave') {
                        uploadArea.classList.remove('dragover');
                    } else if (evt === 'drop') {
                        uploadArea.classList.remove('dragover');
                        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                            handleFile(e.dataTransfer.files[0]);
                        }
                    }
                });
            });

            document.getElementById('convertBtnManual').addEventListener('click', () => {
                const cropMode = document.querySelector('input[name="cropModeManual"]:checked').value;
                let center = null;
                if(cropMode === 'llm') {
                    const selectedSubjectRadio = document.querySelector('input[name="manualSubjectSelect"]:checked');
                    if (selectedSubjectRadio) {
                        center = JSON.parse(selectedSubjectRadio.value);
                    } else if (allSubjects.length > 0) {
                        center = allSubjects[0].center;
                    }
                }
                startConversion(selectedTemplate, center);
            });



            // åŸå§‹å½±ç‰‡å‹•æ…‹é è¦½åŠŸèƒ½
            document.getElementById('originalPreviewBtn').addEventListener('click', async () => {
                if (!fileId) {
                    showStatus('è«‹å…ˆé¸æ“‡å½±ç‰‡', 'error');
                    return;
                }
                await generateOriginalPreview();
            });

            loadAllTemplates();
        });

        // æ‰€æœ‰å…¶ä»– JavaScript å‡½å¼ä¿æŒèˆ‡åŸç‰ˆæœ¬ç›¸åŒçš„é‚è¼¯
        async function loadAllTemplates() {
            try {
                const response = await fetch('/api/templates');
                allTemplates = await response.json();
            } catch (error) {
                console.error("Failed to load templates", error);
            }
        }

        async function loadVideoHistory() {
            const grid = document.getElementById('videoHistoryGrid');
            grid.innerHTML = '<div class="spinner"></div>';
            try {
                const response = await fetch('/api/uploaded_videos');
                const videos = await response.json();
                grid.innerHTML = '';
                if(videos.length === 0){
                    grid.innerHTML = '<p>æš«ç„¡æ­·å²ç´€éŒ„</p>';
                    return;
                }
                videos.forEach(v => {
                    const card = document.createElement('div');
                    card.className = 'history-thumb-card';
                    card.innerHTML = `<img src="${v.thumbnail}" alt="${v.filename}"><p>${v.filename}</p>`;
                    card.addEventListener('click', () => {
                        handleExistingVideo(v.file_id, v.thumbnail, v.video_info, v.filename);
                        document.getElementById('videoHistoryModal').style.display = 'none';
                    });
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error("Failed to load video history", error);
                grid.innerHTML = '<p style="color:red;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        function handleFile(file) {
            if (!file) {
                console.log('æ²’æœ‰é¸æ“‡æª”æ¡ˆ');
                return;
            }
            
            if (file.size > 500 * 1024 * 1024) {
                showStatus('æª”æ¡ˆå¤§å°è¶…é500MBé™åˆ¶', 'error');
                return;
            }
            
            console.log('è™•ç†æª”æ¡ˆ:', file.name, 'å¤§å°:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
            
            // é‡ç½® UI ä¸¦è¨­å®šç‚ºæª”æ¡ˆä¸Šå‚³æ¨¡å¼
            resetUIForNewVideo();
            selectedFile = file;
            fileId = null; // æ¸…é™¤æ­·å²è¨˜éŒ„çš„ fileId
            
            uploadAndAnalyze(file);
        }

        async function handleExistingVideo(fId, thumb, vInfo, filename) {
            console.log('é¸æ“‡æ­·å²å½±ç‰‡:', filename, 'fileId:', fId);
            
            // é‡ç½® UI ä¸¦è¨­å®šç‚ºæ­·å²è¨˜éŒ„æ¨¡å¼
            resetUIForNewVideo();
            selectedFile = null;  // æ˜ç¢ºç¢ºä¿æ²’æœ‰æœ¬åœ°æª”æ¡ˆ
            fileId = fId;
            originalFilename = filename || '';
            
            if (thumb) {
                originalThumbnail = thumb;
                const videoThumbnailEl = document.getElementById('videoThumbnail');
                videoThumbnailEl.src = originalThumbnail;
                videoThumbnailEl.style.display = 'block';
                
                // é¡¯ç¤ºå‹•æ…‹é è¦½æŒ‰éˆ•
                document.getElementById('originalPreviewBtn').style.display = 'block';
            }
            
            if (vInfo) {
                videoInfo = vInfo;
                displayVideoInfo(filename, vInfo, null); // æ­·å²å½±ç‰‡æ²’æœ‰æª”æ¡ˆå¤§å°è³‡è¨Š
            }
            
            document.getElementById('videoPreviewContainer').style.display = 'block';
            document.getElementById('tabsSection').style.display = 'block';
            
            // æ¸…é™¤æª”æ¡ˆè¼¸å…¥
            const fileInput = document.getElementById('fileInput');
            fileInput.value = '';
            
            await runAnalysis(fileId);
        }

        async function uploadAndAnalyze(file) {
            const formData = new FormData();
            formData.append('video', file);
            showProgress(true);
            updateProgress(20, 'ä¸Šå‚³ä¸­...');
            resetUIForNewVideo();
            try {
                const uploadResponse = await fetch('/api/upload', { method: 'POST', body: formData });
                if (!uploadResponse.ok) throw new Error('ä¸Šå‚³å¤±æ•—');
                const uploadResult = await uploadResponse.json();
                fileId = uploadResult.file_id;
                videoInfo = uploadResult.video_info;
                originalThumbnail = uploadResult.thumbnail;
                document.getElementById('videoPreviewContainer').style.display = 'block';
                const videoThumbnailEl = document.getElementById('videoThumbnail');
                videoThumbnailEl.src = originalThumbnail;
                videoThumbnailEl.style.display = 'block';
                
                // é¡¯ç¤ºå‹•æ…‹é è¦½æŒ‰éˆ•
                document.getElementById('originalPreviewBtn').style.display = 'block';
                
                // é¡¯ç¤ºå½±ç‰‡è³‡è¨Š
                displayVideoInfo(file.name, videoInfo, file.size);
                
                document.getElementById('tabsSection').style.display = 'block';
                await runAnalysis(fileId);
            } catch (error) {
                showProgress(false);
                showStatus(error.message, 'error');
            }
        }
        
        async function runAnalysis(fId) {
            // æ¸…ç©ºè‡ªå®šç¾© prompt å’Œå°è©±æ­·å²ï¼Œå› ç‚ºé€™æ˜¯æ¨™æº–åˆ†æ
            currentCustomPrompt = '';
            conversationHistory = [];

            updateProgress(40, 'AI åˆ†æä¸­...');
            document.getElementById('aiSuggestions').innerHTML = `<div class="spinner"></div><p style="text-align: center; color: var(--gray-500); margin-top: 12px;">AI æ­£åœ¨åˆ†æå½±ç‰‡å…§å®¹...</p>`;
            try {
                const analyzeResponse = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        file_id: fId,
                        conversation_history: [] // å‚³éç©ºæ­·å²è¨˜éŒ„ä»¥é–‹å§‹æ–°å°è©±
                    })
                });
                if (!analyzeResponse.ok) throw new Error((await analyzeResponse.json()).error || 'åˆ†æå¤±æ•—');
                const analyzeResult = await analyzeResponse.json();
                
                // å°‡ AI çš„ç¬¬ä¸€å€‹å»ºè­°å­˜å…¥å°è©±æ­·å²
                if (analyzeResult.suggestions) {
                    conversationHistory.push({ role: 'assistant', content: analyzeResult.suggestions });
                }

                updateProgress(100);
                setTimeout(() => {
                    showProgress(false);
                    allSubjects = analyzeResult.analysis_options || [];
                    selectedLLMSubjects = allSubjects.length > 0 ? [allSubjects[0]] : [];
                    displayLlmChoices(allSubjects);
                    displaySuggestions(analyzeResult.suggestions, analyzeResult.recommended_template_names);
                    showStatus('åˆ†æå®Œæˆ', 'success');
                    // é¡¯ç¤ºåˆ†æç‹€æ…‹å€åŸŸ
                    document.getElementById('analysisStatusSection').style.display = 'block';
                }, 500);
            } catch(e) {
                showProgress(false);
                showStatus(`åˆ†æå¤±æ•—: ${e.message}`, 'error');
            }
        }

        async function runCustomAnalysis(fId, customPrompt) {
            // ä¿å­˜ç•¶å‰çš„è‡ªå®šç¾© prompt
            currentCustomPrompt = customPrompt;
            
            // å°‡ç”¨æˆ¶çš„è‡ªå®šç¾©éœ€æ±‚æ·»åŠ åˆ°å°è©±æ­·å²
            conversationHistory.push({ role: 'user', content: customPrompt });

            updateProgress(40, 'æ ¹æ“šæ‚¨çš„éœ€æ±‚é‡æ–°åˆ†æä¸­...');
            document.getElementById('aiSuggestions').innerHTML = `
                <div class="spinner"></div>
                <p style="text-align: center; color: var(--gray-500); margin-top: 12px;">AI æ­£åœ¨æ ¹æ“šæ‚¨çš„éœ€æ±‚é‡æ–°åˆ†æå½±ç‰‡...</p>
                <div style="background: var(--primary-light); border: 1px solid var(--primary); border-radius: var(--border-radius); padding: 12px; margin-top: 16px; font-size: 13px;">
                    <strong>åˆ†æéœ€æ±‚ï¼š</strong>${customPrompt}
                </div>
            `;
            try {
                const analyzeResponse = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        file_id: fId,
                        conversation_history: conversationHistory // å‚³éå®Œæ•´å°è©±æ­·å²
                    })
                });
                if (!analyzeResponse.ok) throw new Error((await analyzeResponse.json()).error || 'è‡ªå®šç¾©åˆ†æå¤±æ•—');
                const analyzeResult = await analyzeResponse.json();

                // å°‡ AI çš„æ–°å»ºè­°æ·»åŠ åˆ°å°è©±æ­·å²
                if (analyzeResult.suggestions) {
                    conversationHistory.push({ role: 'assistant', content: analyzeResult.suggestions });
                }

                updateProgress(100);
                setTimeout(() => {
                    showProgress(false);
                    allSubjects = analyzeResult.analysis_options || [];
                    selectedLLMSubjects = allSubjects.length > 0 ? [allSubjects[0]] : [];
                    displayLlmChoices(allSubjects);
                    displaySuggestions(analyzeResult.suggestions, analyzeResult.recommended_template_names, customPrompt);
                    showStatus('è‡ªå®šç¾©åˆ†æå®Œæˆ', 'success');
                    // é¡¯ç¤ºåˆ†æç‹€æ…‹å€åŸŸ
                    document.getElementById('analysisStatusSection').style.display = 'block';
                }, 500);
            } catch(e) {
                showProgress(false);
                showStatus(`è‡ªå®šç¾©åˆ†æå¤±æ•—: ${e.message}`, 'error');
            }
        }

        function displaySuggestions(suggestions, recommendedNames, customPrompt = null) {
            const suggestionsContainer = document.getElementById('aiSuggestions');
            suggestionsContainer.innerHTML = '';
            
            // === AI åˆ†æçµæœç°¡æ½”å¡ç‰‡ ===
            const analysisCard = document.createElement('div');
            analysisCard.style.cssText = `
                background: #f6ffed;
                border: 1px solid #b7eb8f;
                border-radius: 6px;
                padding: 16px;
                margin-bottom: 24px;
            `;
            
            const objectNames = allSubjects.map(s => s.subject).join('ã€');
            
            analysisCard.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <svg style="width: 16px; height: 16px; margin-right: 8px; color: #52c41a;" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.91,10.59L6.5,12L11,16.5Z"/>
                    </svg>
                    <span style="font-weight: 600; color: #389e0d; font-size: 14px;">AI åˆ†æå®Œæˆ</span>
                </div>
                <div style="color: #52c41a; font-size: 14px; margin-bottom: 8px;">
                    è­˜åˆ¥åˆ° ${allSubjects.length} å€‹ä¸»è¦ç‰©é«”ï¼š${objectNames}
                </div>
                <div style="color: #389e0d; font-size: 12px;">
                    è«‹ä¾åºå®Œæˆä»¥ä¸‹æ­¥é©Ÿé€²è¡Œå½±ç‰‡è½‰æ›
                </div>
            `;
            suggestionsContainer.appendChild(analysisCard);

            // === ç¬¬äºŒæ­¥ï¼šä¸»é«”é¸æ“‡å€åŸŸ ===
            if (allSubjects && allSubjects.length > 0) {
                const subjectsCard = document.createElement('div');
                subjectsCard.className = 'subjects-selection-card';
                subjectsCard.style.cssText = `
                    background: white; 
                    border: 1px solid var(--gray-200); 
                    border-radius: 12px; 
                    padding: 24px; 
                    margin-bottom: 24px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                    transition: all 0.3s ease;
                `;
                subjectsCard.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center;">
                            <div style="background: var(--primary-light); border-radius: 8px; padding: 8px; margin-right: 12px;">
                                <svg style="width: 20px; height: 20px; color: var(--primary);" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--gray-800);">æ­¥é©Ÿ 1ï¼šé¸æ“‡ä¿è­·å°è±¡</h3>
                                <p style="margin: 0; font-size: 13px; color: var(--gray-500);">å¤šé¸æ”¯æ´ï¼ŒAI æœƒè‡ªå‹•è¨ˆç®—æœ€ä½³ä¸­å¿ƒé»</p>
                            </div>
                        </div>
                        <div style="background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                            å¿…å¡«é …ç›®
                        </div>
                    </div>
                    <div id="integratedSubjectChoices" class="integrated-subject-choices"></div>
                `;
                suggestionsContainer.appendChild(subjectsCard);
                
                // æ¸²æŸ“ä¸»é«”é¸æ“‡
                displayIntegratedLlmChoices(allSubjects);
            }

            // === ç¬¬ä¸‰æ­¥ï¼šå¦‚æœæœ‰è‡ªå®šç¾© promptï¼Œé¡¯ç¤ºç”¨æˆ¶éœ€æ±‚ ===
            if (customPrompt) {
                const customPromptCard = document.createElement('div');
                customPromptCard.style.cssText = `
                    background: white; 
                    border: 1px solid var(--primary); 
                    border-radius: 12px; 
                    padding: 24px; 
                    margin-bottom: 24px;
                    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
                `;
                customPromptCard.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center;">
                            <div style="background: var(--primary-light); border-radius: 8px; padding: 8px; margin-right: 12px;">
                                <svg style="width: 20px; height: 20px; color: var(--primary);" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--gray-800);">æ‚¨çš„è‡ªå®šç¾©éœ€æ±‚</h3>
                                <p style="margin: 0; font-size: 13px; color: var(--gray-500);">åŸºæ–¼æ­¤éœ€æ±‚é€²è¡Œå®¢è£½åŒ–åˆ†æ</p>
                            </div>
                        </div>
                        <div style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                            è‡ªå®šç¾©åˆ†æ
                        </div>
                    </div>
                    <div style="background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; padding: 16px; white-space: pre-wrap; line-height: 1.6; font-size: 14px; color: var(--gray-700);">${customPrompt}</div>
                `;
                suggestionsContainer.appendChild(customPromptCard);
            }

            // === ç¬¬å››æ­¥ï¼šAI å°ˆæ¥­å»ºè­° ===
            if (suggestions && suggestions.trim()) {
                const aiSuggestionsCard = document.createElement('div');
                aiSuggestionsCard.style.cssText = `
                    background: white; 
                    border: 1px solid var(--gray-200); 
                    border-radius: 12px; 
                    padding: 24px; 
                    margin-bottom: 24px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                `;
                aiSuggestionsCard.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center;">
                            <div style="background: #f0f9ff; border-radius: 8px; padding: 8px; margin-right: 12px;">
                                <svg style="width: 20px; height: 20px; color: #0284c7;" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7A1,1 0 0,0 14,8H16A1,1 0 0,0 17,7V5.73C16.4,5.39 16,4.74 16,4A2,2 0 0,1 18,2A2,2 0 0,1 20,4C20,4.74 19.6,5.39 19,5.73V7A3,3 0 0,1 16,10H15V11.26L22.24,18.5C22.64,18.9 22.64,19.54 22.24,19.94L19.94,22.24C19.54,22.64 18.9,22.64 18.5,22.24L12,15.74L5.5,22.24C5.1,22.64 4.46,22.64 4.06,22.24L1.76,19.94C1.36,19.54 1.36,18.9 1.76,18.5L9,11.26V10H8A3,3 0 0,1 5,7V5.73C4.4,5.39 4,4.74 4,4A2,2 0 0,1 6,2A2,2 0 0,1 8,4C8,4.74 7.6,5.39 7,5.73V7A1,1 0 0,0 8,8H10A1,1 0 0,0 11,7V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2Z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--gray-800);">æ­¥é©Ÿ 2ï¼šAI å°ˆæ¥­å»ºè­°</h3>
                                <p style="margin: 0; font-size: 13px; color: var(--gray-500);">åŸºæ–¼å½±ç‰‡å…§å®¹çš„æ™ºæ…§åˆ†æèˆ‡å»ºè­°</p>
                            </div>
                        </div>
                        <div style="background: #0284c7; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                            AI åˆ†æ
                        </div>
                    </div>
                    <div class="markdown-content ai-suggestions-content" style="line-height: 1.6; font-size: 14px;">${marked.parse(suggestions)}</div>
                    
                    <!-- è‡ªå®šç¾©åˆ†æå€åŸŸ -->
                    <div style="margin-top: 20px; border-top: 1px solid var(--gray-200); padding-top: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center;">
                                <svg style="width: 16px; height: 16px; margin-right: 8px; color: #6b7280;" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"/>
                                </svg>
                                <span style="font-weight: 600; color: var(--gray-700); font-size: 14px;">éœ€è¦æ›´å…·é«”çš„å»ºè­°ï¼Ÿ</span>
                            </div>
                            <button id="toggleCustomPrompt" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">
                                âœï¸ è‡ªå®šç¾©åˆ†æ
                            </button>
                        </div>
                        
                        <!-- æŠ˜ç–Šå¼è‡ªå®šç¾©å€åŸŸ -->
                        <div id="customPromptSection" style="display: none;">
                            <div style="background: #f8fafc; border: 1px solid var(--gray-200); border-radius: 8px; padding: 16px;">
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px;">
                                        ğŸ’­ æè¿°æ‚¨çš„å…·é«”éœ€æ±‚
                                    </label>
                                    <textarea 
                                        id="customPrompt" 
                                        placeholder="ä¾‹å¦‚ï¼šé€™æ˜¯ä¸€å€‹ç”¢å“å±•ç¤ºå½±ç‰‡ï¼Œè«‹é‡é»é—œæ³¨ç”¢å“ç‰¹å¯«é¡é ­ï¼›é€™æ˜¯æ•™å­¸å½±ç‰‡ï¼Œè«‹ä¿æŒè¬›å¸«å®Œæ•´å‡ºç¾åœ¨ç•«é¢ä¸­ï¼›é€™æ˜¯é¢¨æ™¯å½±ç‰‡ï¼Œè«‹çªå‡ºä¸»è¦æ™¯è§€..."
                                        style="width: 100%; height: 80px; padding: 12px; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical; font-size: 13px; line-height: 1.4; box-sizing: border-box;"
                                    ></textarea>
                                </div>
                                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                    <button id="cancelPromptBtn" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">
                                        å–æ¶ˆ
                                    </button>
                                    <button id="reAnalyzeBtn" class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">
                                        ğŸ”„ é‡æ–°åˆ†æ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                suggestionsContainer.appendChild(aiSuggestionsCard);
                
                // ç‚ºè‡ªå®šç¾©åˆ†ææŒ‰éˆ•æ·»åŠ äº‹ä»¶è™•ç†å™¨
                const toggleCustomPromptBtn = aiSuggestionsCard.querySelector('#toggleCustomPrompt');
                const customPromptSection = aiSuggestionsCard.querySelector('#customPromptSection');
                const cancelPromptBtn = aiSuggestionsCard.querySelector('#cancelPromptBtn');
                const reAnalyzeBtn = aiSuggestionsCard.querySelector('#reAnalyzeBtn');
                const customPromptTextarea = aiSuggestionsCard.querySelector('#customPrompt');
                
                toggleCustomPromptBtn.addEventListener('click', () => {
                    if (customPromptSection.style.display === 'none') {
                        customPromptSection.style.display = 'block';
                        toggleCustomPromptBtn.innerHTML = 'âŒ å–æ¶ˆè‡ªå®šç¾©';
                        customPromptTextarea.focus();
                    } else {
                        customPromptSection.style.display = 'none';
                        toggleCustomPromptBtn.innerHTML = 'âœï¸ è‡ªå®šç¾©åˆ†æ';
                        customPromptTextarea.value = '';
                    }
                });
                
                cancelPromptBtn.addEventListener('click', () => {
                    customPromptSection.style.display = 'none';
                    toggleCustomPromptBtn.innerHTML = 'âœï¸ è‡ªå®šç¾©åˆ†æ';
                    customPromptTextarea.value = '';
                });
                
                reAnalyzeBtn.addEventListener('click', async () => {
                    const customPrompt = customPromptTextarea.value.trim();
                    if (!customPrompt) {
                        showStatus('è«‹è¼¸å…¥è‡ªå®šç¾©åˆ†æéœ€æ±‚', 'error');
                        return;
                    }
                    if (!fileId) {
                        showStatus('è«‹å…ˆé¸æ“‡å½±ç‰‡', 'error');
                        return;
                    }
                    
                    // éš±è—è‡ªå®šç¾©å€åŸŸ
                    customPromptSection.style.display = 'none';
                    toggleCustomPromptBtn.innerHTML = 'âœï¸ è‡ªå®šç¾©åˆ†æ';
                    
                    await runCustomAnalysis(fileId, customPrompt);
                });
            }

            // === ç¬¬äº”æ­¥ï¼šæ¨è–¦å°ºå¯¸æ¨¡æ¿ ===
            const recommendedTemplates = allTemplates.filter(t => recommendedNames.includes(t.name));
            if (recommendedTemplates.length === 0) {
                const noSuggestionCard = document.createElement('div');
                noSuggestionCard.style.cssText = `
                    background: #fef2f2; 
                    border: 1px solid #fecaca; 
                    border-radius: 12px; 
                    padding: 24px; 
                    text-align: center;
                `;
                noSuggestionCard.innerHTML = `
                    <svg style="width: 48px; height: 48px; color: #dc2626; margin-bottom: 16px;" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z"/>
                    </svg>
                    <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #dc2626;">æœªæ‰¾åˆ°åˆé©çš„å»ºè­°å°ºå¯¸</h3>
                    <p style="margin: 0; color: #991b1b; font-size: 14px;">è«‹å˜—è©¦ä½¿ç”¨æ‰‹å‹•è½‰æ›åŠŸèƒ½æˆ–è¯ç¹«æŠ€è¡“æ”¯æ´</p>
                `;
                suggestionsContainer.appendChild(noSuggestionCard);
                return;
            }

            const templatesCard = document.createElement('div');
            templatesCard.style.cssText = `
                background: white; 
                border: 1px solid var(--gray-200); 
                border-radius: 12px; 
                padding: 24px; 
                margin-bottom: 24px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            `;
            templatesCard.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center;">
                        <div style="background: #fef3c7; border-radius: 8px; padding: 8px; margin-right: 12px;">
                            <svg style="width: 20px; height: 20px; color: #d97706;" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--gray-800);">æ­¥é©Ÿ 3ï¼šé¸æ“‡æ¨è–¦å°ºå¯¸</h3>
                            <p style="margin: 0; font-size: 13px; color: var(--gray-500);">é»æ“Šã€Œé è¦½ã€æŸ¥çœ‹æ•ˆæœï¼Œç¢ºèªå¾Œé»æ“Šã€Œé–‹å§‹è½‰æ›ã€</p>
                        </div>
                    </div>
                    <div style="background: #d97706; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                        æœ€å¾Œæ­¥é©Ÿ
                    </div>
                </div>
                <div class="recommended-templates-grid"></div>
            `;
            suggestionsContainer.appendChild(templatesCard);

            const templatesGrid = templatesCard.querySelector('.recommended-templates-grid');
            recommendedTemplates.forEach(template => {
                const card = document.createElement('div');
                card.className = 'recommended-template-card';
                card.style.cssText = `
                    border: 1px solid var(--gray-200);
                    border-radius: 8px;
                    padding: 16px;
                    margin-bottom: 16px;
                    transition: all 0.3s ease;
                    hover-effect: border-color: var(--primary);
                `;
                card.addEventListener('mouseenter', () => {
                    card.style.borderColor = 'var(--primary)';
                    card.style.boxShadow = '0 4px 12px rgba(37, 99, 235, 0.15)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.borderColor = 'var(--gray-200)';
                    card.style.boxShadow = 'none';
                });

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <div style="font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px;">${template.name}</div>
                            <div style="font-size: 14px; color: var(--gray-600); margin-bottom: 4px;">${template.width} Ã— ${template.height}</div>
                            <div style="font-size: 12px; color: var(--gray-500);">${template.description}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary preview-btn" style="font-size: 12px; padding: 6px 12px;">ğŸ“± é è¦½</button>
                        </div>
                    </div>
                    <div class="preview-section" style="display: none; border-top: 1px solid var(--gray-200); padding-top: 16px; margin-top: 12px;">
                        <div class="preview-loading" style="text-align: center; padding: 20px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 8px; font-size: 12px; color: var(--primary);">æ­£åœ¨ç”Ÿæˆé è¦½...</p>
                        </div>
                        <div class="preview-result" style="display: none;">
                            <div style="display: flex; gap: 16px; align-items: flex-start;">
                                <div style="position: relative;">
                                    <div style="position: relative; display: inline-block;">
                                        <img class="preview-image" style="max-width: 200px; border-radius: 8px; border: 1px solid var(--gray-200); display: block;">
                                        <button class="template-preview-btn btn btn-secondary" style="position: absolute; top: 8px; right: 8px; font-size: 11px; padding: 4px 8px; display: none;">
                                            ğŸ¬ å‹•æ…‹é è¦½
                                        </button>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div class="preview-warning" style="display: none; padding: 12px; border-radius: 8px; font-size: 12px; margin-bottom: 12px;">
                                    </div>
                                    <button class="btn btn-primary convert-btn" style="font-size: 14px; padding: 8px 16px; width: 100%; margin-bottom: 8px;"></button>
                                    <div class="frame-counter" style="display: none; font-size: 11px; color: var(--gray-400); text-align: center;">
                                    </div>
                                    <p style="font-size: 11px; color: var(--gray-500); margin: 8px 0 0 0; line-height: 1.4; text-align: center;">
                                        ğŸ’¡ é è¦½æœƒå±•ç¤ºå¤šå€‹é—œéµå½±ç‰‡ç‰‡æ®µçš„è½‰æ›æ•ˆæœ
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const previewBtn = card.querySelector('.preview-btn');
                const convertBtn = card.querySelector('.convert-btn');
                const previewSection = card.querySelector('.preview-section');
                const previewLoading = card.querySelector('.preview-loading');
                const previewResult = card.querySelector('.preview-result');
                
                convertBtn.innerHTML = `ğŸš€ é–‹å§‹è½‰æ› ${template.name}`;

                previewBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    
                    if (previewSection.style.display === 'block') {
                        previewSection.style.display = 'none';
                        activePreviewSections.delete(template.name);
                        previewBtn.textContent = 'ğŸ“± é è¦½';
                        return;
                    }
                    
                    previewBtn.textContent = 'âŒ é—œé–‰é è¦½';
                    await generatePreview(template, previewSection, previewLoading, previewResult);
                });
                
                convertBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const center = calculateMultiSubjectCenter(selectedLLMSubjects);
                    startConversion(template, center);
                });
                
                templatesGrid.appendChild(card);
            });
        }

        function displayIntegratedLlmChoices(subjects) {
            const choicesContainer = document.getElementById('integratedSubjectChoices');
            choicesContainer.innerHTML = '';
            if (!subjects || subjects.length === 0) {
                choicesContainer.innerHTML = "<p style='color: var(--gray-500); font-size: 14px; text-align: center; padding: 16px;'>æœªåµæ¸¬åˆ°ä¸»è¦å°è±¡</p>";
                return;
            }
            
            // æ·»åŠ å¤šé¸èªªæ˜
            const multiSelectInfo = document.createElement('div');
            multiSelectInfo.className = 'multi-select-info';
            multiSelectInfo.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <svg style="width: 16px; height: 16px; margin-right: 8px; color: var(--primary);" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z"/>
                    </svg>
                    <strong style="color: var(--primary);">æ™ºæ…§å¤šé¸æ¨¡å¼</strong>
                </div>
                <p style="margin: 0; font-size: 12px; line-height: 1.4; color: var(--primary-dark);">
                    âœ“ å¯åŒæ™‚é¸æ“‡å¤šå€‹é‡è¦ç‰©é«”<br>
                    âœ“ AI è‡ªå‹•è¨ˆç®—åŠ æ¬Šæœ€ä½³ä¸­å¿ƒé»<br>
                    âœ“ æ”¯æ´é‡è¦æ€§å’Œä¿¡å¿ƒåº¦å„ªåŒ–
                </p>
            `;
            choicesContainer.appendChild(multiSelectInfo);
            
            subjects.forEach((subject, index) => {
                const label = document.createElement('label');
                label.className = 'subject-choice';
                // æ§‹å»ºé¡¯ç¤ºæ–‡å­—ï¼ŒåŒ…å«ä¿¡å¿ƒåº¦å’Œé‡è¦æ€§
                let displayText = subject.subject;
                if (subject.confidence !== undefined) {
                    const confidencePercent = Math.round(subject.confidence * 100);
                    displayText += ` (${confidencePercent}%)`;
                }
                
                // é‡è¦æ€§æ¨™ç¤º
                let importanceIcon = '';
                if (subject.importance === 'high') {
                    importanceIcon = 'ğŸ”¥';
                } else if (subject.importance === 'medium') {
                    importanceIcon = 'â­';
                } else if (subject.importance === 'low') {
                    importanceIcon = 'ğŸ’¡';
                }
                
                // æ”¹ç‚º checkbox æ”¯æ´å¤šé¸
                const subjectId = `subject_${index}`;
                label.innerHTML = `
                    <input type="checkbox" id="${subjectId}" name="llmSubjects" value='${JSON.stringify(subject)}' ${index === 0 ? 'checked' : ''}>
                    <img src="${subject.thumbnail}" alt="${subject.subject}">
                    <span>
                        ${importanceIcon} ${displayText}
                        ${subject.crop_strategy ? `<br><small>ç­–ç•¥: ${subject.crop_strategy}</small>` : ''}
                    </span>
                `;
                
                const checkbox = label.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', async () => {
                    // åŒæ­¥æ›´æ–°é è¦½å€åŸŸçš„é¸ä¸­ç‹€æ…‹
                    syncSubjectSelection();
                    
                    console.log(`ğŸ¯ AI æ¨è–¦å€åŸŸä¸»é«”é¸æ“‡æ›´æ–°: ${selectedLLMSubjects.length} å€‹ä¸»é«”é¸ä¸­`);
                    
                    // é¡¯ç¤ºå…¨å±€ç‹€æ…‹æç¤º
                    const selectedNames = selectedLLMSubjects.map(s => s.subject).join('ã€');
                    showSubjectSwitchIndicator(selectedNames || 'ç„¡é¸æ“‡');
                    
                    // é‡æ–°ç”ŸæˆAIå°ˆæ¥­å»ºè­°
                    await updateAIRecommendations();
                    
                    // é‡æ–°ç”Ÿæˆæ‰€æœ‰å·²é¡¯ç¤ºçš„é è¦½
                    if (activePreviewSections.size > 0) {
                        console.log(`ğŸ”„ é‡æ–°ç”Ÿæˆ ${activePreviewSections.size} å€‹é è¦½...`);
                        await refreshAllActivePreviews();
                    }
                    
                    // éš±è—å…¨å±€ç‹€æ…‹æç¤º
                    hideSubjectSwitchIndicator();
                });
                choicesContainer.appendChild(label);
            });
            
            // åˆå§‹åŒ–é¸ä¸­çš„ä¸»é«”
            syncSubjectSelection();
        }
        
                 function updateSelectedSubjects() {
             const checkboxes = document.querySelectorAll('input[name="llmSubjects"]:checked');
             selectedLLMSubjects = Array.from(checkboxes).map(cb => JSON.parse(cb.value));
             console.log('ğŸ¯ å·²é¸ä¸­ä¸»é«”:', selectedLLMSubjects.map(s => s.subject));
         }
         
         function syncSubjectSelection() {
             // å¾é è¦½å€åŸŸç²å–é¸ä¸­çš„ä¸»é«”
             const previewCheckboxes = document.querySelectorAll('input[name="previewLlmSubjects"]:checked');
             const previewSelected = Array.from(previewCheckboxes).map(cb => JSON.parse(cb.value));
             
             // å¾ AI æ¨è–¦å€åŸŸç²å–é¸ä¸­çš„ä¸»é«”
             const aiCheckboxes = document.querySelectorAll('input[name="llmSubjects"]:checked');
             const aiSelected = Array.from(aiCheckboxes).map(cb => JSON.parse(cb.value));
             
             // åˆä½µå…©å€‹å€åŸŸçš„é¸æ“‡ï¼ˆå„ªå…ˆä½¿ç”¨æœ€è¿‘æ“ä½œçš„å€åŸŸï¼‰
             if (previewCheckboxes.length > 0) {
                 selectedLLMSubjects = previewSelected;
                 // åŒæ­¥åˆ° AI æ¨è–¦å€åŸŸ
                 syncCheckboxes('llmSubjects', selectedLLMSubjects);
             } else if (aiCheckboxes.length > 0) {
                 selectedLLMSubjects = aiSelected;
                 // åŒæ­¥åˆ°é è¦½å€åŸŸ
                 syncCheckboxes('previewLlmSubjects', selectedLLMSubjects);
             } else {
                 selectedLLMSubjects = [];
             }
             
             console.log('ğŸ”„ åŒæ­¥å¾Œé¸ä¸­ä¸»é«”:', selectedLLMSubjects.map(s => s.subject));
         }
         
         function syncCheckboxes(targetName, selectedSubjects) {
             const targetCheckboxes = document.querySelectorAll(`input[name="${targetName}"]`);
             targetCheckboxes.forEach(checkbox => {
                 const subjectData = JSON.parse(checkbox.value);
                 const isSelected = selectedSubjects.some(s => s.subject === subjectData.subject);
                 checkbox.checked = isSelected;
             });
         }
         
         function calculateMultiSubjectCenter(subjects) {
             if (!subjects || subjects.length === 0) {
                 return null;
             }
             
             if (subjects.length === 1) {
                 return subjects[0].center;
             }
             
             // è¨ˆç®—å¤šå€‹ä¸»é«”çš„åŠ æ¬Šä¸­å¿ƒé»
             let totalWeight = 0;
             let weightedX = 0;
             let weightedY = 0;
             
             subjects.forEach(subject => {
                 if (subject.center && Array.isArray(subject.center) && subject.center.length === 2) {
                     // æ ¹æ“šé‡è¦æ€§å’Œä¿¡å¿ƒåº¦è¨ˆç®—æ¬Šé‡
                     let weight = 1;
                     if (subject.importance === 'high') weight = 3;
                     else if (subject.importance === 'medium') weight = 2;
                     else if (subject.importance === 'low') weight = 1;
                     
                     if (subject.confidence) {
                         weight *= subject.confidence;
                     }
                     
                     weightedX += subject.center[0] * weight;
                     weightedY += subject.center[1] * weight;
                     totalWeight += weight;
                 }
             });
             
             if (totalWeight === 0) {
                 return null;
             }
             
             const centerX = Math.round(weightedX / totalWeight);
             const centerY = Math.round(weightedY / totalWeight);
             
             console.log(`ğŸ¯ è¨ˆç®—å¤šä¸»é«”ä¸­å¿ƒé»: [${centerX}, ${centerY}] (åŸºæ–¼ ${subjects.length} å€‹ä¸»é«”)`);
             return [centerX, centerY];
         }

        async function generatePreview(template, previewSection, previewLoading, previewResult) {
            previewSection.style.display = 'block';
            previewLoading.style.display = 'block';
            previewResult.style.display = 'none';
            
            // è¨˜éŒ„æ´»å‹•çš„é è¦½
            activePreviewSections.set(template.name, {
                section: previewSection,
                loading: previewLoading,
                result: previewResult
            });
            
            try {
                // æº–å‚™è«‹æ±‚é«”
                const requestBody = {
                    file_id: fileId,
                    template_name: template.name
                };
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å¤šé¸ä¸»é«”
                if (selectedLLMSubjects && selectedLLMSubjects.length > 0) {
                    // æ”¶é›†æ‰€æœ‰é¸ä¸­ä¸»é«”çš„ä¸­å¿ƒé»
                    const selectedCenters = [];
                    selectedLLMSubjects.forEach(subjectName => {
                        const subject = allSubjects.find(s => s.subject === subjectName);
                        if (subject && subject.center) {
                            selectedCenters.push(subject.center);
                        }
                    });
                    
                    if (selectedCenters.length > 1) {
                        requestBody.centers = selectedCenters;
                    } else if (selectedCenters.length === 1) {
                        requestBody.center = selectedCenters[0];
                    }
                }
                
                const response = await fetch('/api/generate_preview', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error('é è¦½ç”Ÿæˆå¤±æ•—');
                }
                
                const result = await response.json();
                console.log('ğŸ¬ é è¦½ API è¿”å›çµæœ:', result);
                
                previewLoading.style.display = 'none';
                previewResult.style.display = 'block';
                
                const previewImage = previewResult.querySelector('.preview-image');
                const previewWarning = previewResult.querySelector('.preview-warning');
                const frameCounter = previewResult.querySelector('.frame-counter');
                const templatePreviewBtn = previewResult.querySelector('.template-preview-btn');
                
                // è¨­ç½®é è¦½åœ–å’Œå‹•æ…‹é è¦½æŒ‰éˆ•
                if (result.preview_frames && result.preview_frames.length > 0) {
                    // è¨­ç½®éœæ…‹é è¦½åœ–ï¼ˆç¬¬ä¸€å¹€ï¼‰
                    previewImage.src = result.preview_frames[0];
                    console.log(`âœ… è¨­ç½®éœæ…‹é è¦½åœ–ï¼Œå…± ${result.preview_frames.length} å¹€å¯ç”¨`);
                    
                    frameCounter.style.display = 'block';
                    let frameText = `ğŸ“· éœæ…‹é è¦½`;
                    if (result.preview_frames.length > 1) {
                        frameText = `ğŸ“¹ ${result.preview_frames.length} å€‹é è¦½å¹€`;
                    }
                    if (result.has_contours && result.subject_name) {
                        frameText += ` â€¢ ğŸ¯ ${result.subject_name} è¼ªå»“`;
                    }
                    frameCounter.textContent = frameText;
                    
                    // å¦‚æœæœ‰å¤šå¹€ï¼Œé¡¯ç¤ºå‹•æ…‹é è¦½æŒ‰éˆ•
                    if (result.preview_frames.length > 1 && templatePreviewBtn) {
                        templatePreviewBtn.style.display = 'block';
                        setupTemplatePreviewButton(templatePreviewBtn, previewImage, result.preview_frames, result.subject_name);
                    }
                } else {
                    console.error('âŒ æ²’æœ‰æ”¶åˆ°é è¦½å¹€æ•¸æ“š:', result);
                }
                
                // é¡¯ç¤ºè£åˆ‡åˆ†æçµæœ
                if (result.is_adjusted) {
                    previewWarning.style.display = 'block';
                    previewWarning.className = 'recommendation-info';
                    previewWarning.innerHTML = `${ICONS.adjust} <span>ç³»çµ±å·²æœ€ä½³åŒ–èª¿æ•´å½±ç‰‡æ§‹åœ–</span>`;
                } else {
                    previewWarning.style.display = 'none';
                }
                
                // ç²å–æ™ºæ…§è£åˆ‡åˆ†æ
                fetchSmartCropAnalysis(template, null, previewWarning);
                
            } catch (error) {
                previewLoading.style.display = 'none';
                previewResult.innerHTML = `<p style="color: var(--error); font-size: 12px;">é è¦½ç”Ÿæˆå¤±æ•—: ${error.message}</p>`;
                previewResult.style.display = 'block';
            }
        }

        function setupTemplatePreviewButton(previewBtn, imageElement, frames, subjectName) {
            console.log('ğŸ¬ è¨­ç½®æ¨¡æ¿é è¦½æŒ‰éˆ•ï¼Œå¹€æ•¸:', frames.length);
            
            let previewInterval = null;
            let previewFrames = frames;
            let isPlaying = false;
            
            // è¨­ç½®æŒ‰éˆ•é»æ“Šäº‹ä»¶
            previewBtn.addEventListener('click', () => {
                if (isPlaying) {
                    stopTemplatePreview();
                } else {
                    startTemplatePreview();
                }
            });
            
            function startTemplatePreview() {
                if (isPlaying) return;
                
                console.log('ğŸ¬ é–‹å§‹æ¨¡æ¿å‹•æ…‹é è¦½ï¼Œç¸½å¹€æ•¸:', previewFrames.length);
                isPlaying = true;
                previewBtn.textContent = 'â¸ï¸ åœæ­¢é è¦½';
                previewBtn.disabled = false;
                
                let currentFrame = 0;
                
                // é–‹å§‹å‹•ç•«
                previewInterval = setInterval(() => {
                    currentFrame = (currentFrame + 1) % previewFrames.length;
                    console.log(`ğŸ“· æ¨¡æ¿é è¦½åˆ‡æ›åˆ°ç¬¬ ${currentFrame + 1} å¹€`);
                    imageElement.src = previewFrames[currentFrame];
                }, 800); // æ¯800msåˆ‡æ›ä¸€å¹€ï¼Œèˆ‡åŸå§‹å½±ç‰‡é è¦½ç›¸åŒ
                
                const frameCountText = subjectName ? 
                    `ğŸ¬ ${previewFrames.length} å¹€å‹•æ…‹é è¦½ (${subjectName} è¼ªå»“)` : 
                    `ğŸ¬ ${previewFrames.length} å¹€å‹•æ…‹é è¦½`;
                
                showStatus(frameCountText, 'success');
            }
            
            function stopTemplatePreview() {
                if (!isPlaying) return;
                
                isPlaying = false;
                
                if (previewInterval) {
                    clearInterval(previewInterval);
                    previewInterval = null;
                }
                
                // æ¢å¾©ç¬¬ä¸€å¹€
                imageElement.src = previewFrames[0];
                
                previewBtn.textContent = 'ğŸ¬ å‹•æ…‹é è¦½';
                previewBtn.disabled = false;
                
                console.log('â¹ï¸ æ¨¡æ¿å‹•æ…‹é è¦½å·²åœæ­¢');
                showStatus('å‹•æ…‹é è¦½å·²åœæ­¢', 'info');
            }
        }

        function setupFrameAnimation(imageElement, frames) {
            console.log('ğŸ¬ é–‹å§‹è¨­ç½®å¹€å‹•ç•«ï¼Œå¹€æ•¸:', frames.length);
            let currentFrame = 0;
            let animationInterval;
            
            // è¨­ç½®åˆå§‹å¹€
            imageElement.src = frames[0];
            console.log('ğŸ“· è¨­ç½®åˆå§‹å¹€:', frames[0].substring(0, 50) + '...');
            
            // æ·»åŠ æ’­æ”¾/æš«åœæ§åˆ¶
            imageElement.style.cursor = 'pointer';
            imageElement.style.border = '2px solid var(--primary)';
            imageElement.style.borderRadius = 'var(--border-radius)';
            
            // æ·»åŠ æ’­æ”¾æŒ‡ç¤ºå™¨
            const container = imageElement.parentElement;
            const playIndicator = document.createElement('div');
            playIndicator.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: rgba(37, 99, 235, 0.9); color: white; padding: 8px 12px; 
                            border-radius: 20px; font-size: 11px; pointer-events: none; 
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.3s ease;">
                    <svg style="width: 12px; height: 12px; margin-right: 4px; vertical-align: -1px;" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    é»æ“Šæ’­æ”¾å‹•æ…‹é è¦½
                </div>
            `;
            playIndicator.style.position = 'absolute';
            playIndicator.style.top = '0';
            playIndicator.style.left = '0';
            playIndicator.style.right = '0';
            playIndicator.style.bottom = '0';
            playIndicator.style.pointerEvents = 'none';
            
            // ç¢ºä¿å®¹å™¨æ˜¯ç›¸å°å®šä½
            if (getComputedStyle(container).position === 'static') {
                container.style.position = 'relative';
            }
            container.appendChild(playIndicator);
            console.log('âœ… æ’­æ”¾æŒ‡ç¤ºå™¨å·²æ·»åŠ åˆ°å®¹å™¨');
            
            let isPlaying = false;
            
            const startAnimation = () => {
                if (isPlaying) return;
                console.log('ğŸ¬ é–‹å§‹æ’­æ”¾å‹•ç•«ï¼Œç¸½å¹€æ•¸:', frames.length);
                isPlaying = true;
                playIndicator.style.display = 'none';
                
                animationInterval = setInterval(() => {
                    currentFrame = (currentFrame + 1) % frames.length;
                    console.log(`ğŸ“· åˆ‡æ›åˆ°ç¬¬ ${currentFrame + 1} å¹€`);
                    imageElement.src = frames[currentFrame];
                }, 600); // æ¯600msåˆ‡æ›ä¸€å¹€ï¼Œæ›´æµæš¢
                
                // æ’­æ”¾å®Œæ•´å¾ªç’°å¾Œåœæ­¢ï¼ˆè‡³å°‘4ç§’ï¼‰
                const totalDuration = Math.max(4000, frames.length * 600 * 2);
                setTimeout(() => {
                    stopAnimation();
                }, totalDuration);
            };
            
            const stopAnimation = () => {
                if (!isPlaying) return;
                isPlaying = false;
                clearInterval(animationInterval);
                currentFrame = 0;
                imageElement.src = frames[0];
                playIndicator.style.display = 'block';
            };
            
            // é»æ“Šæ’­æ”¾/æš«åœ
            imageElement.addEventListener('click', () => {
                if (isPlaying) {
                    stopAnimation();
                } else {
                    startAnimation();
                }
            });
            
            // è‡ªå‹•æ’­æ”¾ä¸€æ¬¡
            setTimeout(startAnimation, 500);
        }

        // è¿½è¹¤ç•¶å‰é¡¯ç¤ºçš„é è¦½
        let activePreviewSections = new Map(); // template.name -> {section, loading, result}

        function displayLlmChoices(subjects) {
            const choicesContainer = document.getElementById('subjectChoices');
            choicesContainer.innerHTML = '';
            if (!subjects || subjects.length === 0) {
                choicesContainer.innerHTML = "<p style='color: var(--gray-500); font-size: 14px; text-align: center; padding: 20px;'>ğŸ¤– AI æ­£åœ¨åˆ†æä¸­...</p>";
                return;
            }
            
            // åˆ†æå®Œæˆå¾Œï¼Œä¸»é«”é¸æ“‡å€åŸŸä¿æŒç©ºç™½ï¼Œç‹€æ…‹é¡¯ç¤ºå·²ç§»åˆ°å½±ç‰‡é è¦½ä¸‹æ–¹
            choicesContainer.innerHTML = '';
        }

                 async function updateAIRecommendations() {
             if (!fileId || !selectedLLMSubjects || selectedLLMSubjects.length === 0) {
                 console.log('âš ï¸ ç„¡æœ‰æ•ˆçš„æª”æ¡ˆIDæˆ–é¸ä¸­ä¸»é«”ï¼Œè·³éAIå»ºè­°æ›´æ–°');
                 return;
             }
             
             console.log('ğŸ¤– é–‹å§‹æ›´æ–°AIå°ˆæ¥­å»ºè­°ï¼ŒåŸºæ–¼é¸ä¸­ä¸»é«”:', selectedLLMSubjects.map(s => s.subject));
             
             // æ‰¾åˆ°AIå»ºè­°å¡ç‰‡
             const aiSuggestionsContainer = document.getElementById('aiSuggestions');
             const existingAiCard = aiSuggestionsContainer.querySelector('.ai-suggestions-content')?.closest('div');
             
             if (!existingAiCard) {
                 console.log('âš ï¸ æœªæ‰¾åˆ°ç¾æœ‰çš„AIå»ºè­°å¡ç‰‡ï¼Œè·³éæ›´æ–°');
                 return;
             }
             
             // é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹
             const aiSuggestionsContent = existingAiCard.querySelector('.ai-suggestions-content');
             if (aiSuggestionsContent) {
                 aiSuggestionsContent.innerHTML = `
                     <div style="display: flex; align-items: center; justify-content: center; padding: 20px;">
                         <div class="spinner" style="margin-right: 12px;"></div>
                         <span style="color: var(--primary);">ğŸ¯ æ ¹æ“šæ‚¨é¸æ“‡çš„ä¿è­·å°è±¡é‡æ–°åˆ†æä¸­...</span>
                     </div>
                 `;
             }
             
             try {
                 // æ§‹é€ é‡å°é¸ä¸­ä¸»é«”çš„åˆ†æè«‹æ±‚
                 const analyzeRequestBody = {
                     file_id: fileId,
                     custom_prompt: `è«‹é‡å°ç”¨æˆ¶é¸ä¸­çš„ä¿è­·å°è±¡ã€Œ${selectedLLMSubjects.map(s => s.subject).join('ã€')}ã€é‡æ–°åˆ†æå½±ç‰‡å…§å®¹ä¸¦æä¾›å°ˆæ¥­å»ºè­°ã€‚

ç”¨æˆ¶é¸æ“‡é€™äº›å°è±¡ä½œç‚ºé‡é»ä¿è­·ç›®æ¨™ï¼Œè«‹ï¼š
1. åˆ†æé€™äº›å°è±¡åœ¨å½±ç‰‡ä¸­çš„ç‰¹é»å’Œé‡è¦æ€§
2. é‡å°ä¿è­·é€™äº›å°è±¡æä¾›è£åˆ‡å’Œå°ºå¯¸å»ºè­°
3. èªªæ˜å¦‚ä½•ç¢ºä¿é€™äº›å°è±¡åœ¨è½‰æ›å¾Œçš„å½±ç‰‡ä¸­å¾—åˆ°æœ€ä½³å‘ˆç¾
4. æä¾›å…·é«”çš„æ§‹åœ–å’Œè¦–è¦ºå»ºè­°

${currentCustomPrompt ? `\nç”¨æˆ¶çš„åŸå§‹éœ€æ±‚ï¼š${currentCustomPrompt}` : ''}`
                 };
                 
                 const response = await fetch('/api/analyze', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify(analyzeRequestBody)
                 });
                 
                 if (!response.ok) {
                     throw new Error('AIå»ºè­°æ›´æ–°å¤±æ•—');
                 }
                 
                 const result = await response.json();
                 console.log('ğŸ¤– æ”¶åˆ°æ›´æ–°çš„AIå»ºè­°:', result);
                 
                 // æ›´æ–°AIå»ºè­°å…§å®¹
                 if (result.suggestions && aiSuggestionsContent) {
                     aiSuggestionsContent.innerHTML = `
                         <div style="background: #fff7ed; border: 1px solid #fed7aa; border-radius: 6px; padding: 12px; margin-bottom: 16px; font-size: 12px;">
                             <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                 <svg style="width: 14px; height: 14px; margin-right: 6px; color: #ea580c;" viewBox="0 0 24 24" fill="currentColor">
                                     <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7A1,1 0 0,0 14,8H16A1,1 0 0,0 17,7V5.73C16.4,5.39 16,4.74 16,4A2,2 0 0,1 18,2A2,2 0 0,1 20,4C20,4.74 19.6,5.39 19,5.73V7A3,3 0 0,1 16,10H15V11.26L22.24,18.5C22.64,18.9 22.64,19.54 22.24,19.94L19.94,22.24C19.54,22.64 18.9,22.64 18.5,22.24L12,15.74L5.5,22.24C5.1,22.64 4.46,22.64 4.06,22.24L1.76,19.94C1.36,19.54 1.36,18.9 1.76,18.5L9,11.26V10H8A3,3 0 0,1 5,7V5.73C4.4,5.39 4,4.74 4,4A2,2 0 0,1 6,2A2,2 0 0,1 8,4C8,4.74 7.6,5.39 7,5.73V7A1,1 0 0,0 8,8H10A1,1 0 0,0 11,7V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2Z"/>
                                 </svg>
                                 <strong style="color: #ea580c;">å·²æ ¹æ“šæ‚¨çš„ä¿è­·å°è±¡é¸æ“‡æ›´æ–°å»ºè­°</strong>
                             </div>
                             <span style="color: #9a3412;">èšç„¦æ–¼ï¼š${selectedLLMSubjects.map(s => s.subject).join('ã€')}</span>
                         </div>
                         <div style="line-height: 1.6; font-size: 14px;">${marked.parse(result.suggestions)}</div>
                     `;
                     
                     // å¹³æ»‘æ»¾å‹•åˆ°æ›´æ–°çš„å»ºè­°
                     aiSuggestionsContent.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     
                     console.log('âœ… AIå°ˆæ¥­å»ºè­°å·²æ›´æ–°å®Œæˆ');
                 }
                 
             } catch (error) {
                 console.error('âŒ AIå»ºè­°æ›´æ–°å¤±æ•—:', error);
                 
                 // é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
                 if (aiSuggestionsContent) {
                     aiSuggestionsContent.innerHTML = `
                         <div style="display: flex; align-items: center; justify-content: center; padding: 20px; color: var(--error);">
                             <svg style="width: 16px; height: 16px; margin-right: 8px;" viewBox="0 0 24 24" fill="currentColor">
                                 <path d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z"/>
                             </svg>
                             <span>AIå»ºè­°æ›´æ–°å¤±æ•—: ${error.message}</span>
                         </div>
                         <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 6px; font-size: 12px; color: var(--gray-600);">
                             <strong>åŸå§‹å»ºè­°ä»ç„¶æœ‰æ•ˆ</strong><br>
                             æ‚¨å¯ä»¥ç¹¼çºŒä½¿ç”¨æœ€åˆçš„AIåˆ†æå»ºè­°ï¼Œæˆ–å˜—è©¦é‡æ–°é¸æ“‡ä¿è­·å°è±¡ã€‚
                         </div>
                     `;
                 }
                 
                 showStatus(`AIå»ºè­°æ›´æ–°å¤±æ•—: ${error.message}`, 'error');
             }
         }
         
         async function refreshAllActivePreviews() {
             const refreshPromises = [];
             
             for (const [templateName, previewElements] of activePreviewSections) {
                 // æ‰¾åˆ°å°æ‡‰çš„æ¨¡æ¿
                 const template = allTemplates.find(t => t.name === templateName);
                 if (!template) continue;
                 
                 console.log(`ğŸ”„ é‡æ–°ç”Ÿæˆ ${templateName} çš„é è¦½...`);
                 
                 // æª¢æŸ¥ DOM å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé¿å… null éŒ¯èª¤
                 const { section, loading, result } = previewElements;
                 if (!loading || !result || !section) {
                     console.warn(`âš ï¸ ${templateName} çš„é è¦½å…ƒç´ ä¸å®Œæ•´ï¼Œè·³éæ›´æ–°`);
                     continue;
                 }
                 
                 // é¡¯ç¤ºæ›´æ–°ä¸­ç‹€æ…‹
                 try {
                     loading.style.display = 'block';
                     result.style.display = 'none';
                     loading.innerHTML = `
                         <div class="spinner"></div>
                         <p style="margin-top: 8px; font-size: 12px; color: var(--primary);">ğŸ¯ åˆ‡æ›ä¸»é«”ï¼Œé‡æ–°ç”Ÿæˆé è¦½ä¸­...</p>
                     `;
                     
                     // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„é è¦½
                     const templatePreviewBtn = result.querySelector('.template-preview-btn');
                     if (templatePreviewBtn) {
                         templatePreviewBtn.style.display = 'none';
                         templatePreviewBtn.textContent = 'ğŸ¬ å‹•æ…‹é è¦½';
                     }
                     
                     // ç•°æ­¥ç”Ÿæˆé è¦½
                     refreshPromises.push(generatePreview(template, section, loading, result));
                 } catch (error) {
                     console.error(`âŒ ${templateName} é è¦½æ›´æ–°å¤±æ•—:`, error);
                 }
             }
             
             // ç­‰å¾…æ‰€æœ‰é è¦½å®Œæˆ
             await Promise.all(refreshPromises);
             console.log('âœ… æ‰€æœ‰é è¦½å·²æ›´æ–°å®Œæˆ');
         }

         function showSubjectSwitchIndicator(subjectName) {
             // åœ¨ AI æ¨è–¦çµæœå€åŸŸé¡¯ç¤ºåˆ‡æ›æç¤º
             const aiSuggestionsContainer = document.getElementById('aiSuggestions');
             let indicator = document.getElementById('subjectSwitchIndicator');
             
             if (!indicator) {
                 indicator = document.createElement('div');
                 indicator.id = 'subjectSwitchIndicator';
                 indicator.style.cssText = `
                     position: sticky;
                     top: 10px;
                     background: linear-gradient(135deg, var(--primary), var(--primary-dark));
                     color: white;
                     padding: 12px 16px;
                     border-radius: var(--border-radius);
                     font-size: 12px;
                     text-align: center;
                     box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
                     z-index: 100;
                     margin-bottom: 16px;
                     animation: slideDown 0.3s ease-out;
                 `;
                 
                 // æ’å…¥åˆ° AI æ¨è–¦çµæœçš„é ‚éƒ¨
                 aiSuggestionsContainer.insertBefore(indicator, aiSuggestionsContainer.firstChild);
             }
             
             indicator.innerHTML = `
                 <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                     <svg style="width: 16px; height: 16px; animation: spin 1s linear infinite;" viewBox="0 0 24 24" fill="currentColor">
                         <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
                     </svg>
                     <span>ğŸ¯ å·²åˆ‡æ›è‡³ã€Œ${subjectName}ã€ï¼Œæ­£åœ¨æ›´æ–°AIå»ºè­°èˆ‡é è¦½...</span>
                 </div>
             `;
             indicator.style.display = 'block';
         }

         function hideSubjectSwitchIndicator() {
             const indicator = document.getElementById('subjectSwitchIndicator');
             if (indicator) {
                 indicator.style.animation = 'slideUp 0.3s ease-out';
                 setTimeout(() => {
                     indicator.style.display = 'none';
                 }, 300);
             }
         }

         async function fetchSmartCropAnalysis(template, center, warningElement) {
             try {
                 // æº–å‚™è«‹æ±‚é«”
                 const requestBody = {
                     file_id: fileId,
                     template_name: template.name
                 };
                 
                 // æª¢æŸ¥æ˜¯å¦æœ‰å¤šé¸ä¸»é«”
                 if (selectedLLMSubjects && selectedLLMSubjects.length > 0) {
                     // æ”¶é›†æ‰€æœ‰é¸ä¸­ä¸»é«”çš„ä¸­å¿ƒé»
                     const selectedCenters = [];
                     selectedLLMSubjects.forEach(subjectName => {
                         const subject = allSubjects.find(s => s.subject === subjectName);
                         if (subject && subject.center) {
                             selectedCenters.push(subject.center);
                         }
                     });
                     
                     if (selectedCenters.length > 1) {
                         requestBody.centers = selectedCenters;
                     } else if (selectedCenters.length === 1) {
                         requestBody.center = selectedCenters[0];
                     } else if (center) {
                         requestBody.center = center;
                     }
                 } else if (center) {
                     requestBody.center = center;
                 }
                 
                 const response = await fetch('/api/smart_crop_analysis', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify(requestBody)
                 });
                 
                 if (response.ok) {
                     const analysis = await response.json();
                     displayCropAnalysis(analysis, warningElement);
                 }
             } catch (error) {
                 console.error('æ™ºæ…§è£åˆ‡åˆ†æå¤±æ•—:', error);
             }
         }

         function displayCropAnalysis(analysis, warningElement) {
             let analysisHTML = '';
             let className = 'recommendation-info';
             
             if (analysis.is_perfect_fit) {
                 analysisHTML = `
                     <span style="color: var(--success);">
                         âœ… å®Œç¾é©é… - ä¸»é«”èƒ½å®Œæ•´é¡¯ç¤ºåœ¨ç›®æ¨™å°ºå¯¸ä¸­
                     </span>
                 `;
                 className = 'recommendation-success';
             } else if (analysis.recommendation === 'è‰¯å¥½é©é…') {
                 analysisHTML = `
                     <span style="color: var(--primary);">
                         â­ è‰¯å¥½é©é… - ä¸»é«”åŸºæœ¬å®Œæ•´ï¼Œå¾®èª¿ ${analysis.offset_x > analysis.offset_y ? 'X' : 'Y'} è»¸ ${Math.max(analysis.offset_x, analysis.offset_y)}px
                     </span>
                 `;
             } else {
                 analysisHTML = `
                     <span style="color: var(--warning);">
                         âš ï¸ éœ€è¦èª¿æ•´ - ä¸»é«”å¯èƒ½è¢«è£åˆ‡ï¼Œåç§» X:${analysis.offset_x}px Y:${analysis.offset_y}px
                     </span>
                 `;
                 className = 'recommendation-warning';
             }
             
             // æ·»åŠ è©³ç´°è³‡è¨Š
             analysisHTML += `
                 <br><small style="color: var(--gray-500); font-size: 10px;">
                     ç¸®æ”¾: ${analysis.scale_factor}x | è¦†è“‹ç‡: ${Math.min(analysis.coverage_x, analysis.coverage_y)}%
                 </small>
             `;
             
             warningElement.innerHTML = analysisHTML;
             warningElement.className = className;
             warningElement.style.display = 'block';
         }

        function setupManualTab() {
            const grid = document.getElementById('templatesGridManual');
            grid.innerHTML = '';
            allTemplates.forEach(t => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.innerHTML = `<div class="template-name">${t.name}</div><div class="template-size">${t.width}Ã—${t.height}</div><div class="template-desc">${t.description}</div>`;
                card.onclick = () => {
                    document.querySelectorAll('#templatesGridManual .template-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedTemplate = t;
                    document.getElementById('convertBtnManual').disabled = false;
                };
                grid.appendChild(card);
            });
            const llmCropOption = document.querySelector('.crop-option-group label:last-child');
            if (allSubjects && allSubjects.length > 0 && llmCropOption) {
                llmCropOption.style.display = 'flex';
            }
        }
        
        async function startConversion(template, center) {
            if (!fileId || !template) return showStatus('è«‹å…ˆé¸æ“‡å½±ç‰‡å’Œç›®æ¨™å°ºå¯¸', 'error');
            showProgress(true);
            updateProgress(0, 'æº–å‚™è½‰æ›...');
            
            // ç¢ºå®šè£åˆ‡æ¨¡å¼å’Œä¸­å¿ƒé»
            let cropMode = 'center';
            let finalCenter = null;
            let finalCenters = null;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å¤šé¸ä¸»é«”
            if (selectedLLMSubjects && selectedLLMSubjects.length > 0) {
                cropMode = 'llm';
                
                // æ”¶é›†æ‰€æœ‰é¸ä¸­ä¸»é«”çš„ä¸­å¿ƒé»
                const selectedCenters = [];
                selectedLLMSubjects.forEach(subjectName => {
                    const subject = allSubjects.find(s => s.subject === subjectName);
                    if (subject && subject.center) {
                        selectedCenters.push(subject.center);
                    }
                });
                
                if (selectedCenters.length > 1) {
                    finalCenters = selectedCenters;
                    console.log('ğŸ¯ ä½¿ç”¨å¤šä¸»é«” AI æ™ºæ…§è£åˆ‡æ¨¡å¼ï¼Œä¸­å¿ƒé»:', selectedCenters);
                } else if (selectedCenters.length === 1) {
                    finalCenter = selectedCenters[0];
                    console.log('ğŸ¯ ä½¿ç”¨å–®ä¸»é«” AI æ™ºæ…§è£åˆ‡æ¨¡å¼ï¼Œä¸­å¿ƒé»:', selectedCenters[0]);
                } else {
                    console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸»é«”ä¸­å¿ƒé»ï¼Œä½¿ç”¨ç½®ä¸­è£åˆ‡');
                    cropMode = 'center';
                }
            } else if (center && Array.isArray(center) && center.length === 2) {
                // å‘å¾Œç›¸å®¹ï¼šæ”¯æ´ç›´æ¥å‚³å…¥çš„ä¸­å¿ƒé»
                cropMode = 'llm';
                finalCenter = center;
                console.log('ğŸ¯ ä½¿ç”¨å‚³å…¥çš„ AI æ™ºæ…§è£åˆ‡æ¨¡å¼ï¼Œä¸­å¿ƒé»:', center);
            } else {
                console.log('ğŸ“ ä½¿ç”¨ç½®ä¸­è£åˆ‡æ¨¡å¼');
            }
            
            const body = {
                file_id: fileId,
                width: template.width,
                height: template.height,
                crop_mode: cropMode
            };
            
            // æ ¹æ“šæƒ…æ³æ·»åŠ ä¸­å¿ƒé»åƒæ•¸
            if (finalCenters) {
                body.centers = finalCenters;
            } else if (finalCenter) {
                body.center = finalCenter;
            }
            try {
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                updateProgress(50, 'è½‰æ›ä¸­...');
                if (!response.ok) throw new Error((await response.json()).error || 'è½‰æ›å¤±æ•—');
                const result = await response.json();
                updateProgress(100);
                setTimeout(() => {
                    showProgress(false);
                    showResult(result.download_url, result.filename);
                    showStatus('è½‰æ›æˆåŠŸ', 'success');
                }, 500);
            } catch (error) {
                showProgress(false);
                showStatus('è½‰æ›å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        function showResult(finalUrl, finalFilename) {
            const resultSection = document.getElementById('resultSection');
            resultSection.style.display = 'block';
            const originalVideo = document.getElementById('originalVideo');
            const convertedVideo = document.getElementById('convertedVideo');
            
            // è¨­å®šåŸå§‹å½±ç‰‡ä¾†æº
            if(selectedFile) {
                // å¦‚æœæ˜¯æ–°ä¸Šå‚³çš„æ–‡ä»¶ï¼Œä½¿ç”¨æœ¬åœ°å°è±¡ URL
                console.log('ä½¿ç”¨æœ¬åœ°æª”æ¡ˆ:', selectedFile.name);
                originalVideo.src = URL.createObjectURL(selectedFile);
            } else if(fileId) {
                // å¦‚æœæ˜¯å¾æ­·å²è¨˜éŒ„é¸æ“‡çš„æ–‡ä»¶ï¼Œæ§‹å»ºä¼ºæœå™¨ URL
                const originalFileName = getOriginalFileName(fileId);
                console.log('ä½¿ç”¨ä¼ºæœå™¨æª”æ¡ˆ:', originalFileName);
                originalVideo.src = `/uploads/${originalFileName}`;
                // è¨­å®šéŒ¯èª¤è™•ç†
                originalVideo.onerror = () => {
                    console.error('åŸå§‹å½±ç‰‡è¼‰å…¥å¤±æ•—:', originalVideo.src);
                    originalVideo.poster = originalThumbnail;
                    originalVideo.src = '';
                };
            } else {
                console.log('ç„¡æª”æ¡ˆè³‡è¨Šï¼Œåªé¡¯ç¤ºç¸®åœ–');
                originalVideo.poster = originalThumbnail;
                originalVideo.src = '';
            }
            
            convertedVideo.src = finalUrl;
            
            // å„ªåŒ–å½±ç‰‡é¡¯ç¤ºå°ºå¯¸å’Œæ¯”ä¾‹
            optimizeVideoDisplay(originalVideo, convertedVideo);
            
            const downloadSection = document.getElementById('downloadSection');
            downloadSection.style.display = 'block';
            downloadSection.innerHTML = `
                <div class="status-message success">
                    ${ICONS.check} è½‰æ›å®Œæˆ
                </div>
                <a href="${finalUrl}" class="btn btn-primary" download="${finalFilename}">${ICONS.download} ä¸‹è¼‰å½±ç‰‡</a>
            `;
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function optimizeVideoDisplay(originalVideo, convertedVideo) {
            // ç­‰å¾…å½±ç‰‡å…ƒæ•¸æ“šè¼‰å…¥
            Promise.all([
                new Promise(resolve => {
                    if (originalVideo.videoWidth && originalVideo.videoHeight) {
                        resolve();
                    } else {
                        originalVideo.addEventListener('loadedmetadata', resolve, { once: true });
                    }
                }),
                new Promise(resolve => {
                    if (convertedVideo.videoWidth && convertedVideo.videoHeight) {
                        resolve();
                    } else {
                        convertedVideo.addEventListener('loadedmetadata', resolve, { once: true });
                    }
                })
            ]).then(() => {
                console.log('ğŸ“ é–‹å§‹å„ªåŒ–å½±ç‰‡é¡¯ç¤ºå°ºå¯¸');
                updateVideoDisplaySizes(originalVideo, convertedVideo);
            }).catch(error => {
                console.error('å½±ç‰‡å…ƒæ•¸æ“šè¼‰å…¥å¤±æ•—:', error);
                // ä½¿ç”¨é è¨­å°ºå¯¸
                setDefaultVideoSizes(originalVideo, convertedVideo);
            });
        }
        
        function updateVideoDisplaySizes(originalVideo, convertedVideo) {
            const originalWidth = originalVideo.videoWidth || videoInfo.width || 1920;
            const originalHeight = originalVideo.videoHeight || videoInfo.height || 1080;
            const convertedWidth = convertedVideo.videoWidth || selectedTemplate?.width || 1080;
            const convertedHeight = convertedVideo.videoHeight || selectedTemplate?.height || 1920;
            
            console.log(`ğŸ“ åŸå§‹å½±ç‰‡å°ºå¯¸: ${originalWidth}Ã—${originalHeight}`);
            console.log(`ğŸ“ è½‰æ›å¾Œå½±ç‰‡å°ºå¯¸: ${convertedWidth}Ã—${convertedHeight}`);
            
            // è¨ˆç®—æ¯”ä¾‹
            const originalAspect = originalWidth / originalHeight;
            const convertedAspect = convertedWidth / convertedHeight;
            
            // è¨­å®šæœ€ä½³é¡¯ç¤ºå°ºå¯¸ - è®“å…©å€‹å½±ç‰‡çš„é¡¯ç¤ºå¤§å°æ›´æ¥è¿‘
            const maxDisplayWidth = 400;  // æœ€å¤§é¡¯ç¤ºå¯¬åº¦
            const maxDisplayHeight = 300; // æœ€å¤§é¡¯ç¤ºé«˜åº¦
            
            // åŸå§‹å½±ç‰‡é¡¯ç¤ºå°ºå¯¸è¨ˆç®—
            let originalDisplayWidth, originalDisplayHeight;
            if (originalAspect > maxDisplayWidth / maxDisplayHeight) {
                // å¯¬æ¯”ä¾‹å½±ç‰‡
                originalDisplayWidth = Math.min(maxDisplayWidth, originalWidth * 0.4);
                originalDisplayHeight = originalDisplayWidth / originalAspect;
            } else {
                // é«˜æ¯”ä¾‹å½±ç‰‡
                originalDisplayHeight = Math.min(maxDisplayHeight, originalHeight * 0.4);
                originalDisplayWidth = originalDisplayHeight * originalAspect;
            }
            
            // è½‰æ›å¾Œå½±ç‰‡é¡¯ç¤ºå°ºå¯¸è¨ˆç®—
            let convertedDisplayWidth, convertedDisplayHeight;
            if (convertedAspect > maxDisplayWidth / maxDisplayHeight) {
                // å¯¬æ¯”ä¾‹å½±ç‰‡
                convertedDisplayWidth = Math.min(maxDisplayWidth, convertedWidth * 0.4);
                convertedDisplayHeight = convertedDisplayWidth / convertedAspect;
            } else {
                // é«˜æ¯”ä¾‹å½±ç‰‡  
                convertedDisplayHeight = Math.min(maxDisplayHeight, convertedHeight * 0.4);
                convertedDisplayWidth = convertedDisplayHeight * convertedAspect;
            }
            
            // èª¿æ•´å…©å€‹å½±ç‰‡çš„å°ºå¯¸ï¼Œä½¿å…¶æ›´æ¥è¿‘
            const originalArea = originalDisplayWidth * originalDisplayHeight;
            const convertedArea = convertedDisplayWidth * convertedDisplayHeight;
            const areaRatio = Math.sqrt(originalArea / convertedArea);
            
            // å¦‚æœé¢ç©å·®ç•°å¤ªå¤§ï¼Œèª¿æ•´è¼ƒå°çš„é‚£å€‹
            if (areaRatio > 1.5) {
                // åŸå§‹å½±ç‰‡é¢ç©è¼ƒå¤§ï¼Œç¸®å°è½‰æ›å¾Œå½±ç‰‡
                const scaleFactor = Math.min(1.5, areaRatio);
                convertedDisplayWidth *= scaleFactor;
                convertedDisplayHeight *= scaleFactor;
            } else if (areaRatio < 0.67) {
                // è½‰æ›å¾Œå½±ç‰‡é¢ç©è¼ƒå¤§ï¼Œç¸®å°åŸå§‹å½±ç‰‡
                const scaleFactor = Math.max(0.67, areaRatio);
                originalDisplayWidth /= scaleFactor;
                originalDisplayHeight /= scaleFactor;
            }
            
            console.log(`ğŸ“± å„ªåŒ–å¾Œé¡¯ç¤ºå°ºå¯¸ - åŸå§‹: ${Math.round(originalDisplayWidth)}Ã—${Math.round(originalDisplayHeight)}, è½‰æ›å¾Œ: ${Math.round(convertedDisplayWidth)}Ã—${Math.round(convertedDisplayHeight)}`);
            
            // æ‡‰ç”¨æ–°çš„å°ºå¯¸
            originalVideo.style.width = `${Math.round(originalDisplayWidth)}px`;
            originalVideo.style.height = `${Math.round(originalDisplayHeight)}px`;
            originalVideo.style.maxWidth = '100%';
            originalVideo.style.objectFit = 'contain';
            
            convertedVideo.style.width = `${Math.round(convertedDisplayWidth)}px`;
            convertedVideo.style.height = `${Math.round(convertedDisplayHeight)}px`;
            convertedVideo.style.maxWidth = '100%';
            convertedVideo.style.objectFit = 'contain';
            
            // æ›´æ–°æ¨™é¡Œé¡¯ç¤ºæ¯”ä¾‹ä¿¡æ¯
            updateVideoTitles(originalWidth, originalHeight, convertedWidth, convertedHeight, originalAspect, convertedAspect);
        }
        
        function setDefaultVideoSizes(originalVideo, convertedVideo) {
            console.log('ğŸ“ ä½¿ç”¨é è¨­å½±ç‰‡é¡¯ç¤ºå°ºå¯¸');
            // è¨­å®šåˆç†çš„é è¨­å°ºå¯¸
            originalVideo.style.width = '320px';
            originalVideo.style.height = '240px';
            originalVideo.style.maxWidth = '100%';
            originalVideo.style.objectFit = 'contain';
            
            convertedVideo.style.width = '240px';
            convertedVideo.style.height = '320px';  
            convertedVideo.style.maxWidth = '100%';
            convertedVideo.style.objectFit = 'contain';
            
            // ä½¿ç”¨å·²çŸ¥ä¿¡æ¯æ›´æ–°æ¨™é¡Œ
            const originalWidth = videoInfo.width || 1920;
            const originalHeight = videoInfo.height || 1080;
            const convertedWidth = selectedTemplate?.width || 1080;
            const convertedHeight = selectedTemplate?.height || 1920;
            const originalAspect = originalWidth / originalHeight;
            const convertedAspect = convertedWidth / convertedHeight;
            
            updateVideoTitles(originalWidth, originalHeight, convertedWidth, convertedHeight, originalAspect, convertedAspect);
        }
        
        function updateVideoTitles(originalWidth, originalHeight, convertedWidth, convertedHeight, originalAspect, convertedAspect) {
            // æ›´æ–°æ¨™é¡Œä»¥é¡¯ç¤ºæ›´å¤šä¿¡æ¯
            const originalContainer = document.querySelector('#resultSection .content-section > div:nth-child(2) > div:first-child');
            const convertedContainer = document.querySelector('#resultSection .content-section > div:nth-child(2) > div:last-child');
            
            if (originalContainer) {
                const aspectRatioText = formatAspectRatio(originalAspect);
                originalContainer.querySelector('h4').innerHTML = `
                    åŸå§‹å½±ç‰‡ 
                    <span style="font-size: 12px; color: var(--gray-500); font-weight: normal;">
                        (${originalWidth}Ã—${originalHeight} â€¢ ${aspectRatioText})
                    </span>
                `;
            }
            
            if (convertedContainer) {
                const aspectRatioText = formatAspectRatio(convertedAspect);
                const templateName = selectedTemplate?.name || 'è½‰æ›å°ºå¯¸';
                convertedContainer.querySelector('h4').innerHTML = `
                    è½‰æ›å¾Œå½±ç‰‡
                    <span style="font-size: 12px; color: var(--gray-500); font-weight: normal;">
                        (${convertedWidth}Ã—${convertedHeight} â€¢ ${aspectRatioText})
                    </span>
                    <br>
                    <span style="font-size: 11px; color: var(--primary); font-weight: normal;">
                        ğŸ“± ${templateName}
                    </span>
                `;
            }
            
            // æ·»åŠ æ¯”ä¾‹å°æ¯”ä¿¡æ¯
            addAspectRatioComparison(originalAspect, convertedAspect);
        }
        
        function formatAspectRatio(aspectRatio) {
            // è­˜åˆ¥å¸¸è¦‹çš„æ¯”ä¾‹
            const commonRatios = [
                { ratio: 16/9, text: '16:9' },
                { ratio: 9/16, text: '9:16' },
                { ratio: 4/3, text: '4:3' },
                { ratio: 3/4, text: '3:4' },
                { ratio: 1, text: '1:1' },
                { ratio: 21/9, text: '21:9' },
                { ratio: 9/21, text: '9:21' }
            ];
            
            for (const common of commonRatios) {
                if (Math.abs(aspectRatio - common.ratio) < 0.05) {
                    return common.text;
                }
            }
            
            // è¨ˆç®—æœ€æ¥è¿‘çš„æ•´æ•¸æ¯”ä¾‹
            const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
            const denominator = 100;
            const numerator = Math.round(aspectRatio * denominator);
            const divisor = gcd(numerator, denominator);
            
            return `${numerator/divisor}:${denominator/divisor}`;
        }
        
        function addAspectRatioComparison(originalAspect, convertedAspect) {
            // åœ¨è½‰æ›çµæœå€åŸŸæ·»åŠ æ¯”ä¾‹å°æ¯”ä¿¡æ¯
            const resultSection = document.getElementById('resultSection');
            const existingComparison = resultSection.querySelector('.aspect-ratio-comparison');
            if (existingComparison) {
                existingComparison.remove();
            }
            
            const comparisonDiv = document.createElement('div');
            comparisonDiv.className = 'aspect-ratio-comparison';
            comparisonDiv.style.cssText = `
                background: #f8fafc;
                border: 1px solid var(--gray-200);
                border-radius: 8px;
                padding: 16px;
                margin: 16px 0;
                text-align: center;
                font-size: 13px;
            `;
            
            const ratioChange = convertedAspect / originalAspect;
            let changeDescription = '';
            let changeIcon = '';
            
            if (ratioChange > 1.2) {
                changeDescription = 'è½‰æ›ç‚ºæ›´å¯¬çš„æ¯”ä¾‹';
                changeIcon = 'â†”ï¸';
            } else if (ratioChange < 0.8) {
                changeDescription = 'è½‰æ›ç‚ºæ›´é«˜çš„æ¯”ä¾‹';
                changeIcon = 'â†•ï¸';
            } else {
                changeDescription = 'æ¯”ä¾‹è®ŠåŒ–è¼ƒå°';
                changeIcon = 'ğŸ”„';
            }
            
                         comparisonDiv.innerHTML = `
                 <div style="color: var(--gray-600); margin-bottom: 12px;">
                     <strong>ğŸ“ æ¯”ä¾‹è½‰æ›æ•ˆæœ</strong>
                 </div>
                 <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px;">
                     <span style="color: var(--gray-700);">${formatAspectRatio(originalAspect)}</span>
                     <span style="font-size: 16px;">${changeIcon}</span>
                     <span style="color: var(--primary); font-weight: 600;">${formatAspectRatio(convertedAspect)}</span>
                 </div>
                 <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;">
                     <div style="display: flex; flex-direction: column; align-items: center;">
                         <div style="font-size: 10px; color: var(--gray-500); margin-bottom: 2px;">åŸå§‹</div>
                         <div style="
                             width: ${Math.min(60, Math.max(20, originalAspect * 30))}px;
                             height: ${Math.min(60, Math.max(20, 30 / originalAspect))}px;
                             background: var(--gray-400);
                             border: 1px solid var(--gray-300);
                             border-radius: 2px;
                         "></div>
                     </div>
                     <div style="color: var(--gray-400); font-size: 12px;">vs</div>
                     <div style="display: flex; flex-direction: column; align-items: center;">
                         <div style="font-size: 10px; color: var(--gray-500); margin-bottom: 2px;">è½‰æ›å¾Œ</div>
                         <div style="
                             width: ${Math.min(60, Math.max(20, convertedAspect * 30))}px;
                             height: ${Math.min(60, Math.max(20, 30 / convertedAspect))}px;
                             background: var(--primary);
                             border: 1px solid var(--primary-dark);
                             border-radius: 2px;
                         "></div>
                     </div>
                 </div>
                 <div style="color: var(--gray-500); font-size: 12px;">
                     ${changeDescription} â€¢ æ¯”ä¾‹è®ŠåŒ–: ${(ratioChange * 100).toFixed(0)}%
                 </div>
             `;
            
            // æ’å…¥åˆ°å½±ç‰‡é¡¯ç¤ºå€åŸŸå¾Œé¢
            const videoGrid = resultSection.querySelector('.content-section > div:nth-child(2)');
            videoGrid.insertAdjacentElement('afterend', comparisonDiv);
        }

        function resetUIForNewVideo() {
            console.log('é‡ç½® UI ç‚ºæ–°å½±ç‰‡ç‹€æ…‹');
            
            // éš±è—æ‰€æœ‰ä¸»è¦å€åŸŸ
            document.getElementById('videoPreviewContainer').style.display = 'none';
            document.getElementById('tabsSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            
            // æ¸…ç†æ¯”ä¾‹å°æ¯”ä¿¡æ¯
            const existingComparison = document.querySelector('.aspect-ratio-comparison');
            if (existingComparison) {
                existingComparison.remove();
            }
            
            // é‡ç½®åˆ†æçµæœå€åŸŸ
            document.getElementById('aiSuggestions').innerHTML = '<div class="spinner"></div><p style="text-align: center; color: var(--gray-500); margin-top: 12px;">AI åˆ†æä¸­...</p>';
            document.getElementById('subjectChoices').innerHTML = '';
            
            // é‡ç½®å½±ç‰‡ç¸®åœ–
            const videoThumbnail = document.getElementById('videoThumbnail');
            videoThumbnail.removeAttribute('src');
            videoThumbnail.style.display = 'none';
            
            // é‡ç½®æ‰‹å‹•è½‰æ›å€åŸŸ
            document.getElementById('templatesGridManual').innerHTML = '';
            const centerRadio = document.querySelector('input[name="cropModeManual"][value="center"]');
            if (centerRadio) centerRadio.checked = true;
            
            // éš±è—åˆ†æç‹€æ…‹å€åŸŸ
            document.getElementById('analysisStatusSection').style.display = 'none';
            
            // é‡ç½®è‡ªå®šç¾©åˆ†æç‹€æ…‹ï¼ˆæ¸…ç©ºå¯èƒ½çš„è‡ªå®šç¾©åˆ†æè¼¸å…¥æ¡†ï¼‰
            const existingCustomPromptInputs = document.querySelectorAll('#customPrompt');
            existingCustomPromptInputs.forEach(input => {
                if (input) input.value = '';
            });
            
            // åœæ­¢ä¸¦éš±è—åŸå§‹å½±ç‰‡å‹•æ…‹é è¦½
            if (originalPreviewInterval) {
                clearInterval(originalPreviewInterval);
                originalPreviewInterval = null;
            }
            document.getElementById('originalPreviewBtn').style.display = 'none';
            document.getElementById('originalPreviewBtn').textContent = 'ğŸ¬ å‹•æ…‹é è¦½';
            document.getElementById('originalPreviewBtn').disabled = false;
            
            // æ¸…ç†å½±ç‰‡è³‡è¨Šé¡¯ç¤º
            clearVideoInfo();
            
            // æ¸…ç†é è¦½è¿½è¹¤
            activePreviewSections.clear();
            
            // é‡ç½®æª”æ¡ˆè¼¸å…¥
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
            
            // é‡ç½®æ‰€æœ‰è®Šæ•¸
            selectedFile = null;
            fileId = null;
            videoInfo = {};
            allSubjects = [];
            selectedTemplate = null;
            selectedLLMSubjects = [];
            originalThumbnail = '';
            originalFilename = '';
            currentCustomPrompt = '';
            conversationHistory = []; // æ–°å¢ï¼šé‡ç½®å°è©±æ­·å²
        }

        function displayVideoInfo(filename, vInfo, fileSize) {
            // æ›´æ–°æª”æ¡ˆåç¨±
            const fileNameElement = document.getElementById('videoFileName');
            fileNameElement.textContent = filename || '-';
            fileNameElement.title = filename || ''; // è¨­ç½® title å±¬æ€§ç”¨æ–¼æ‡¸åœé¡¯ç¤ºå®Œæ•´åç¨±
            
            // æ›´æ–°å½±ç‰‡æ ¼å¼ï¼ˆå¾æª”æ¡ˆåç¨±æå–ï¼‰
            const fileExtension = filename ? filename.split('.').pop().toUpperCase() : '-';
            document.getElementById('videoFormat').textContent = fileExtension;
            
            // æ›´æ–°è§£æåº¦
            if (vInfo && vInfo.width && vInfo.height) {
                document.getElementById('videoResolution').textContent = `${vInfo.width} Ã— ${vInfo.height}`;
            } else {
                document.getElementById('videoResolution').textContent = '-';
            }
            
            // æ›´æ–°å½±ç‰‡æ™‚é•·
            if (vInfo && vInfo.duration) {
                const duration = parseFloat(vInfo.duration);
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                document.getElementById('videoDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                document.getElementById('videoDuration').textContent = '-';
            }
            
            // æ›´æ–°å¹€ç‡
            if (vInfo && vInfo.fps) {
                document.getElementById('videoFPS').textContent = `${Math.round(vInfo.fps)} fps`;
            } else {
                document.getElementById('videoFPS').textContent = '-';
            }
            
            // æ›´æ–°æª”æ¡ˆå¤§å°
            if (fileSize) {
                const sizeMB = (fileSize / (1024 * 1024)).toFixed(1);
                document.getElementById('videoFileSize').textContent = `${sizeMB} MB`;
            } else {
                document.getElementById('videoFileSize').textContent = '-';
            }
        }

        function clearVideoInfo() {
            const infoElements = ['videoFileName', 'videoFormat', 'videoResolution', 'videoDuration', 'videoFPS', 'videoFileSize'];
            infoElements.forEach(id => {
                document.getElementById(id).textContent = '-';
            });
        }

        async function generateOriginalPreview() {
            const previewBtn = document.getElementById('originalPreviewBtn');
            const videoThumbnail = document.getElementById('videoThumbnail');
            
            // å¦‚æœå·²ç¶“åœ¨æ’­æ”¾å‹•æ…‹é è¦½ï¼Œå‰‡åœæ­¢
            if (previewBtn.textContent.includes('åœæ­¢')) {
                stopOriginalPreview();
                return;
            }
            
            previewBtn.textContent = 'â³ è¼‰å…¥ä¸­...';
            previewBtn.disabled = true;
            
            try {
                const response = await fetch('/api/generate_original_preview', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        file_id: fileId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('åŸå§‹å½±ç‰‡é è¦½ç”Ÿæˆå¤±æ•—');
                }
                
                const result = await response.json();
                console.log('ğŸ¬ åŸå§‹å½±ç‰‡é è¦½ API è¿”å›çµæœ:', result);
                
                if (result.preview_frames && result.preview_frames.length > 1) {
                    console.log(`âœ… è¨­ç½®åŸå§‹å½±ç‰‡å¤šå¹€å‹•ç•«ï¼Œå…± ${result.preview_frames.length} å¹€`);
                    setupOriginalFrameAnimation(videoThumbnail, result.preview_frames, previewBtn);
                } else if (result.preview_frames && result.preview_frames.length === 1) {
                    console.log('ğŸ“· åŸå§‹å½±ç‰‡åªæœ‰å–®å¹€');
                    videoThumbnail.src = result.preview_frames[0];
                    previewBtn.textContent = 'ğŸ¬ å‹•æ…‹é è¦½';
                    previewBtn.disabled = false;
                    showStatus('å½±ç‰‡å¤ªçŸ­ï¼Œç„¡æ³•ç”Ÿæˆå‹•æ…‹é è¦½', 'info');
                } else {
                    throw new Error('æ²’æœ‰æ”¶åˆ°é è¦½å¹€æ•¸æ“š');
                }
                
            } catch (error) {
                console.error('åŸå§‹å½±ç‰‡é è¦½ç”Ÿæˆå¤±æ•—:', error);
                showStatus(`å‹•æ…‹é è¦½å¤±æ•—: ${error.message}`, 'error');
                previewBtn.textContent = 'ğŸ¬ å‹•æ…‹é è¦½';
                previewBtn.disabled = false;
            }
        }

        let originalPreviewInterval = null;
        let originalPreviewFrames = null;

        function setupOriginalFrameAnimation(imageElement, frames, controlBtn) {
            console.log('ğŸ¬ é–‹å§‹è¨­ç½®åŸå§‹å½±ç‰‡å¹€å‹•ç•«ï¼Œå¹€æ•¸:', frames.length);
            
            originalPreviewFrames = frames;
            let currentFrame = 0;
            
            // è¨­ç½®åˆå§‹å¹€
            imageElement.src = frames[0];
            console.log('ğŸ“· è¨­ç½®åŸå§‹å½±ç‰‡åˆå§‹å¹€');
            
            controlBtn.textContent = 'â¸ï¸ åœæ­¢é è¦½';
            controlBtn.disabled = false;
            
            // é–‹å§‹å‹•ç•«
            originalPreviewInterval = setInterval(() => {
                currentFrame = (currentFrame + 1) % frames.length;
                console.log(`ğŸ“· åŸå§‹å½±ç‰‡åˆ‡æ›åˆ°ç¬¬ ${currentFrame + 1} å¹€`);
                imageElement.src = frames[currentFrame];
            }, 800); // æ¯800msåˆ‡æ›ä¸€å¹€ï¼Œç¨æ…¢ä¸€äº›ä»¥ä¾¿è§€çœ‹
            
            showStatus(`ğŸ¬ åŸå§‹å½±ç‰‡å‹•æ…‹é è¦½å·²å•Ÿå‹• (${frames.length} å¹€)`, 'success');
        }

        function stopOriginalPreview() {
            const previewBtn = document.getElementById('originalPreviewBtn');
            const videoThumbnail = document.getElementById('videoThumbnail');
            
            if (originalPreviewInterval) {
                clearInterval(originalPreviewInterval);
                originalPreviewInterval = null;
            }
            
            // æ¢å¾©åŸå§‹ç¸®åœ–
            if (originalThumbnail) {
                videoThumbnail.src = originalThumbnail;
            }
            
            previewBtn.textContent = 'ğŸ¬ å‹•æ…‹é è¦½';
            previewBtn.disabled = false;
            
            console.log('â¹ï¸ åŸå§‹å½±ç‰‡å‹•æ…‹é è¦½å·²åœæ­¢');
            showStatus('å‹•æ…‹é è¦½å·²åœæ­¢', 'info');
        }

        async function loadHistoryPage() {
            const container = document.getElementById('history-content');
            container.innerHTML = '<div class="spinner"></div>';
            try {
                const response = await fetch('/api/uploaded_videos');
                const videos = await response.json();
                container.innerHTML = '';
                if (videos.length === 0) {
                    container.innerHTML = '<p>æš«ç„¡æ­·å²ç´€éŒ„</p>';
                    return;
                }
                videos.forEach(video => {
                    const card = document.createElement('div');
                    card.style.cssText = 'border: 1px solid var(--gray-200); border-radius: var(--border-radius); padding: 16px; margin-bottom: 12px; display: flex; gap: 16px;';
                    let convertedListHTML = '<div><h4 style="margin-bottom: 8px; font-size: 14px;">è½‰æ›çµæœ:</h4><ul style="margin: 0; padding-left: 16px;">';
                    if (video.converted_videos && video.converted_videos.length > 0) {
                        video.converted_videos.forEach(converted => {
                            const downloadUrl = `/outputs/${converted.filename}`;
                            convertedListHTML += `
                                <li style="margin-bottom: 4px; font-size: 12px;">
                                    <a href="${downloadUrl}" download style="color: var(--primary); text-decoration: none;">${converted.filename}</a>
                                    <span style="color: var(--gray-500); margin-left: 8px;">(${new Date(converted.timestamp).toLocaleDateString()})</span>
                                </li>
                            `;
                        });
                    } else {
                        convertedListHTML += '<li style="color: var(--gray-500); font-size: 12px;">å°šç„¡è½‰æ›çµæœ</li>';
                    }
                    convertedListHTML += '</ul></div>';
                    card.innerHTML = `
                        <img src="${video.thumbnail}" style="width: 100px; height: 60px; object-fit: cover; border-radius: var(--border-radius); border: 1px solid var(--gray-200);">
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 8px; font-size: 14px; color: var(--gray-900);">${video.filename}</h3>
                            ${convertedListHTML}
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error("Failed to load history page:", error);
                container.innerHTML = '<p style="color:red;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        function showProgress(show) {
            document.getElementById('progressBar').style.display = show ? 'block' : 'none';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            if (text) showStatus(text, 'info');
        }

        function getOriginalFileName(fId) {
            // é»˜èªä½¿ç”¨ .mp4 æ“´å±•åï¼ˆæœ€å¸¸è¦‹çš„æ ¼å¼ï¼‰
            // å¾Œç«¯çµ±ä¸€ä½¿ç”¨é€™å€‹å‘½åæ ¼å¼ï¼š{file_id}_original.{ext}
            return `${fId}_original.mp4`;
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            setTimeout(() => { statusEl.style.display = 'none';}, type === 'info' ? 6000 : 3000);
        }
    </script>
</body>
</html> 